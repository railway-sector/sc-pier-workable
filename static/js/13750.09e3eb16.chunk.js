"use strict";(self.webpackChunksc_pier_workable=self.webpackChunksc_pier_workable||[]).push([[13750],{2522:(e,t,i)=>{i.d(t,{P:()=>l});var s=i(35143),a=i(54901),r=i(91291),n=i(46053),o=(i(81806),i(76460),i(47249),i(85842));const l=e=>{let t=class extends(r.A.EsriPromiseMixin(e)){constructor(){super(...arguments),this.parent=null,this._userInteractive=!1,this._interactiveViewModelCount=0}get interactive(){return this._interactiveViewModelCount>0||this._userInteractive}set interactive(e){this._userInteractive=e}get updating(){return!1}get visible(){return null==this.parent||this.parent.visible&&!this.parent.suspended}set visible(e){this._overrideIfSome("visible",e)}forceInteractive(){return this._interactiveViewModelCount++,(0,a.hA)(()=>this._interactiveViewModelCount--)}};return(0,s._)([(0,n.MZ)({constructOnly:!0})],t.prototype,"parent",void 0),(0,s._)([(0,n.MZ)({constructOnly:!0})],t.prototype,"view",void 0),(0,s._)([(0,n.MZ)({type:Boolean})],t.prototype,"interactive",null),(0,s._)([(0,n.MZ)()],t.prototype,"_userInteractive",void 0),(0,s._)([(0,n.MZ)({readOnly:!0})],t.prototype,"updating",null),(0,s._)([(0,n.MZ)()],t.prototype,"visible",null),(0,s._)([(0,n.MZ)()],t.prototype,"_interactiveViewModelCount",void 0),t=(0,s._)([(0,o.$)("esri.views.3d.analysis.AnalysisView3D")],t),t}},5109:(e,t,i)=>{i.d(t,{k:()=>o});var s=i(35143),a=i(68134),r=(i(76460),i(81806),i(47249),i(50076),i(85842)),n=i(56829);let o=class extends n.g{constructor(e){super(e)}initialize(){this.addHandles((0,a.wB)(()=>this.analysisViewData.visible,e=>this.visible=e,a.pc))}deactivate(){this.onDeactivate(),this.created||this.analysis.clear()}resetCreated(){this._set("created",!1)}};o=(0,s._)([(0,r.$)("esri.views.interactive.AnalysisToolBase")],o)},10260:(e,t,i)=>{i.d(t,{Hd:()=>l,ZX:()=>d,aS:()=>c,qW:()=>h});var s=i(98773),a=i(54901),r=i(30726),n=i(50346),o=i(68134);function l(e,t){return(0,o.wB)(()=>e.interactive,()=>function(e,t){e.interactive?function(e,t){c(e);const{view:i,analysis:s}=e,a=new t({view:i,analysis:s,analysisViewData:e});e.tool=a,i.tools.add(a)}(e,t):c(e)}(e,t),o.pc)}function c(e){const{view:t,tool:i}=e;null!=i&&(t.tools.remove(i),e.tool=null)}function h(e,t){const i=e.userOperation,l=(0,s.UT)(async l=>{if(i){const e=i.promise.catch(()=>{});i?.abort(),await e,(0,n.Te)(l)}const c=function(e,t){e.interactive=!0;const{tool:i,view:a}=e;a.activeTool=i;let l=(0,n.u7)(t,()=>{a.activeTool===i&&(a.activeTool=null)});return(0,s.UT)(async t=>{await(0,o.C_)(()=>!e.tool?.active,t),l=(0,r.xt)(l)},t)}(e,{signal:l}),h=t?.shouldRejectOnCancel??(()=>!0),d=(0,a.vE)([(0,o.on)(()=>e.tool,"cancel",()=>{h()&&c.abort()})]),{tool:u}=e;try{u&&(u.resetCreated(),t?.onToolActivated?.(u)),await c.promise,(0,n.Te)(l)}catch(p){if(l.aborted||!(0,n.zf)(p)||h())throw p}finally{d?.remove()}},{signal:t?.abortOptions?.signal});return e.userOperation=l,l.promise.finally(()=>{e.userOperation===l&&(e.userOperation=null)})}async function d(e,t){const i=e.analysis.clone();return await h(e,{abortOptions:t?.placementOptions,onToolActivated:t?.onToolActivated,shouldRejectOnCancel:()=>{const{analysis:t}=e;return!t.valid||t.equals(i)}}),{}}},27456:(e,t,i)=>{i.d(t,{V:()=>V,a:()=>y,b:()=>b});var s=i(34761),a=i(13191),r=i(73398),n=i(65058),o=i(36324),l=i(30041),c=i(95756),h=i(5517),d=i(21390),u=i(60205),p=i(86955),v=i(72790),w=i(23687),f=i(44640),_=i(4653),m=i(70367),g=i(2687);class V extends l.${constructor(){super(...arguments),this.shadowMap={depthTexture:null,nearFar:[1,100],numActiveFaces:1,atlasRegions:[[0,0,1,1]]},this.targetVector=[1,0,0],this.upVector=[0,0,1],this.fovs=[45,45],this.headingAndTilt=[0,0],this.observerOffset=[0,0,0],this.projectionMatrices=a.zK.flat(),this.viewMatrices=a.zK.flat(),this.volumeOffset=0}}function b(){const e=new g.N5,t=e.fragment;return e.include(r.c),e.include(l.w),t.include(n.E),t.include(o.p),t.uniforms.add(new _.x("depthTexture",e=>e.depth?.attachment),new w.F("inverseProjectionMatrix",e=>e.camera.inverseProjectionMatrix),new w.F("inverseViewNormalMatrix",e=>{let{camera:t}=e;return(0,s.Qw)(M,t.viewInverseTransposeMatrix)}),new h.t("viewshedObserverOffset",e=>e.observerOffset),new h.t("viewshedTargetVector",e=>e.targetVector),new h.t("viewshedUpVector",e=>e.upVector),new c.G("viewshedFOVs",e=>e.fovs),new c.G("viewshedHeadingAndTilt",e=>e.headingAndTilt),new c.G("viewshedNearFar",e=>e.shadowMap.nearFar??[1,100]),new d.m("viewshedVolumeOffset",e=>e.volumeOffset),new m.N("viewshedShadowMap",e=>e.shadowMap.depthTexture),new f.m("viewshedProjectionMatrices",e=>e.projectionMatrices,6),new f.m("viewshedViewMatrices",e=>e.viewMatrices,6),new v.c("viewshedNumFaces",e=>e.shadowMap.numActiveFaces),new u.x("viewshedAtlasRegions",e=>e.shadowMap.atlasRegions.flat(),24),new m.N("normalMap",e=>e.normals)),t.constants.add("visibleColor","vec4",[0,1,0,.5]),t.constants.add("occludedColor","vec4",[1,0,0,.5]),t.code.add(p.H`vec2 getViewshedUv(vec4 worldPosition, int face) {
mat4 viewshedMatrix = viewshedProjectionMatrices[face];
vec4 viewshedUv4 = viewshedMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
return viewshedUv.xy;
}
float viewshedDepthToFloat(float depth) {
return (depth - viewshedNearFar[0]) / (viewshedNearFar[1] - viewshedNearFar[0]);
}
float getOrthographicDepthToViewshed(vec4 worldPosition, int face) {
mat4 viewshedViewMatrix = viewshedViewMatrices[face];
vec4 viewshedUv4 = viewshedViewMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
float depth = -viewshedUv.z;
return viewshedDepthToFloat(depth);
}
float viewshedReadShadowMapDepth(sampler2D _viewshedShadowmap, ivec2 uv) {
return texelFetch(_viewshedShadowmap, uv, 0).r;
}
float viewshedFilterShadow(sampler2D _viewshedShadowmap, vec2 uv) {
vec2 uvScaled = uv * vec2(textureSize(_viewshedShadowmap, 0));
vec2 st    = fract(uvScaled);
ivec2 base = ivec2(uvScaled);
float s00 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y    ));
float s10 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y    ));
float s11 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y + 1));
float s01 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y + 1));
return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);
}
float viewshedTextureAtlasLookup(sampler2D _viewshedShadowmap, vec2 uv, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(uv) * atlasScale + atlasRegion.xy;
return viewshedFilterShadow(_viewshedShadowmap, uvAtlas);
}
float getDepthFromShadowMap(vec2 uv, int face) {
int index = 4 * face;
float umin = viewshedAtlasRegions[index];
float umax = viewshedAtlasRegions[index + 1];
float vmin = viewshedAtlasRegions[index + 2];
float vmax = viewshedAtlasRegions[index + 3];
vec4 atlasRegion = vec4(umin, vmin, umax, vmax);
return viewshedTextureAtlasLookup(viewshedShadowMap, uv, atlasRegion);
}
struct ViewshedPoint {
int face;
vec2 uv;
bool isWithin;
float orthographicDepth;
};
mat3 rotationMatrix(vec3 axis, float angle)
{
float s = sin(angle);
float c = cos(angle);
float oc = 1.0 - c;
return mat3(
oc * axis.xxz * axis.xyx + vec3(c, axis.zy) * vec3(1., -s, s),
oc * axis.xyy * axis.yyz + vec3(axis.z, c, axis.x) * vec3(s, 1., -s),
oc * axis.zyz * axis.xzz + vec3(axis.yx, c) * vec3(-s, s, 1.)
);
}
float distanceToPlane(vec3 position, vec3 normal) {
return dot(position, normal);
}
bool outsideViewshed(float distance) {
return distance > -viewshedVolumeOffset;
}
bool isWithinViewshed(vec3 position) {
float positionLength = length(position - viewshedObserverOffset);
float farSphereDistance = positionLength - viewshedNearFar[1];
if (outsideViewshed(farSphereDistance)) { return false; }
float nearSphereDistance = viewshedNearFar[0] - positionLength;
if (outsideViewshed(nearSphereDistance)) { return false; }
vec3 westVector = normalize(cross(viewshedUpVector, viewshedTargetVector));
bool leftOfTarget = distanceToPlane(position, westVector) > 0.0;
if (viewshedFOVs[0] < TWO_PI) {
float horAngle = viewshedFOVs[0] / 2.0;
horAngle = leftOfTarget ? horAngle : -horAngle;
vec3 sideVector = viewshedTargetVector * rotationMatrix(viewshedUpVector, horAngle);
bool inFront = distanceToPlane(position, sideVector) > 0.0;
if (inFront) {
vec3 sideNormal = cross(viewshedUpVector, sideVector) * (leftOfTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
} else if (viewshedFOVs[0] < PI) { return false; }
}
if (viewshedFOVs[1] < PI) {
float t = dot(viewshedUpVector, position);
vec3 nProjVector = normalize(position - t * viewshedUpVector);
float heading = acos(clamp(dot(normalize(viewshedTargetVector), nProjVector), -1.0, 1.0));
heading = leftOfTarget ? heading : -heading;
bool aboveTarget = distanceToPlane(position, viewshedUpVector) > 0.0;
float verFOV = viewshedFOVs[1] / 2.0;
verFOV = aboveTarget ? -verFOV : verFOV;
mat3 rotateByHeading = rotationMatrix(viewshedUpVector, heading);
vec3 sideVector = viewshedTargetVector * rotationMatrix(westVector, verFOV) * rotateByHeading;
vec3 leftVector = westVector * rotateByHeading;
vec3 sideNormal = cross(sideVector, leftVector) * (aboveTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
}
return true;
}
bool getViewshedPoint(vec4 localPosition, out ViewshedPoint point) {
for(int i=0; i < viewshedNumFaces; i++) {
vec2 viewshedUv = getViewshedUv(localPosition, i);
if (viewshedUv.x > 0. && viewshedUv.x < 1. && viewshedUv.y > 0. && viewshedUv.y < 1.) {
float orthoDepth = getOrthographicDepthToViewshed(localPosition, i);
if (orthoDepth >= 0.) {
bool isWithin = isWithinViewshed(localPosition.xyz);
point = ViewshedPoint(i, viewshedUv, isWithin, orthoDepth);
return true;
}
}
}
return false;
}
float normalCosAngle(float linearDepth, vec3 localPosition) {
vec4 normal4 = texture(normalMap, uv);
vec3 normalN = normalize(normal4.xyz * 2.0 - 1.0);
vec3 normal =  normalize((inverseViewNormalMatrix * vec4(normalN, 1.0)).xyz);
vec3 viewingDir = normalize(localPosition);
return dot(normal, viewingDir);
}`),t.main.add(p.H`float depth = depthFromTexture(depthTexture, uv);
if (depth >= 1.0 || depth <= 0.0) {
return;
}
float linearDepth = linearizeDepth(depth);
vec4 localPosition = reconstructLocalPosition(gl_FragCoord.xy, linearDepth);
ViewshedPoint point;
bool foundFace = getViewshedPoint(localPosition, point);
if (!foundFace || !point.isWithin) {
return;
}
float viewshedDepth = getDepthFromShadowMap(point.uv, point.face);
float distance = point.orthographicDepth;
bool visible = distance < viewshedDepth;
fragColor = visible ? visibleColor : occludedColor;
float cosAngle = normalCosAngle(linearDepth, localPosition.xyz);
float threshold = -0.01;
if (cosAngle > threshold) {
fragColor = occludedColor;
}`),e}const M=(0,a.vt)(),y=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:V,build:b},Symbol.toStringTag,{value:"Module"}))},30041:(e,t,i)=>{i.d(t,{$:()=>h,w:()=>d});var s=i(34761),a=i(13191),r=i(9392),n=i(27963),o=i(86955),l=i(43425),c=i(31432);class h extends c.Y{constructor(){super(...arguments),this.localOrigin=(0,r.Ul)()}}function d(e){e.include(n.Ir),e.fragment.uniforms.add(new l.X("inverseViewMatrix",(e,t)=>{const i=(0,s.Tl)((0,a.vt)(),t.camera.viewMatrix,e.localOrigin);return(0,s.Qw)(i,i)})).code.add(o.H`vec4 reconstructLocalPosition(vec2 coord, float linearDepth) {
vec4 cameraSpace = vec4(reconstructPosition(coord, linearDepth), 1.0);
return inverseViewMatrix * cameraSpace;
}`)}},32864:(e,t,i)=>{i.d(t,{A:()=>v});var s=i(35143),a=i(42251),r=i(69098),n=i(73582),o=i(42553),l=i(30726),c=i(46053),h=i(21403),d=(i(81806),i(47249),i(85842)),u=i(40565),p=i(19247);let v=class extends(o.A.JSONSupportMixin(r.A)){constructor(e){super(e),this.observer=null,this.farDistance=1e3,this.heading=0,this.tilt=90,this.horizontalFieldOfView=45,this.verticalFieldOfView=45,this.feature=null}get valid(){return null!=this.observer&&this.farDistance>0}equals(e){return(0,l.CM)(this.observer,e.observer)&&this.farDistance===e.farDistance&&this.heading===e.heading&&this.tilt===e.tilt&&this.horizontalFieldOfView===e.horizontalFieldOfView&&this.verticalFieldOfView===e.verticalFieldOfView&&(0,a.xH)(this.feature,e.feature)}};(0,s._)([(0,c.MZ)({type:p.A,json:{write:{isRequired:!0}}})],v.prototype,"observer",void 0),(0,s._)([(0,c.MZ)({type:Number,nonNullable:!0,range:{min:0},json:{write:{isRequired:!0}}})],v.prototype,"farDistance",void 0),(0,s._)([(0,c.MZ)({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),(0,h.w)(e=>n.ie.normalize((0,u.GB)(e),void 0,!0))],v.prototype,"heading",void 0),(0,s._)([(0,c.MZ)({type:Number,nonNullable:!0,range:{min:0,max:180},json:{write:{isRequired:!0}}})],v.prototype,"tilt",void 0),(0,s._)([(0,c.MZ)({type:Number,nonNullable:!0,range:{min:0,max:360},json:{write:{isRequired:!0}}})],v.prototype,"horizontalFieldOfView",void 0),(0,s._)([(0,c.MZ)({type:Number,nonNullable:!0,range:{min:0,max:180},json:{write:{isRequired:!0}}})],v.prototype,"verticalFieldOfView",void 0),(0,s._)([(0,c.MZ)(a.N1)],v.prototype,"feature",void 0),(0,s._)([(0,c.MZ)({readOnly:!0,json:{read:!1}})],v.prototype,"valid",null),v=(0,s._)([(0,d.$)("esri.analysis.Viewshed")],v)},36538:(e,t,i)=>{i.r(t),i.d(t,{default:()=>Jt});var s=i(35143),a=i(42251),r=i(91967),n=i(81806),o=i(76460),l=i(43927),c=i(30726),h=i(68134),d=i(46053),u=(i(47249),i(85842)),p=i(20664),v=i(9392),w=i(9956),f=i(50840),_=i(2413),m=i(2522),g=i(17430),V=i(54901),b=i(69539),M=i(53084),y=i(15941),S=i(34761),O=i(13191),D=i(83490),T=i(45463);const A=(0,y.kU)(2);const R=new class{constructor(){this.collisionRadius=5,this.fovUnfocusedArcWidth=4,this.fovFocusedArcWidth=2*this.fovUnfocusedArcWidth,this.scaleOrientSize=90,this.scaleOrientHandleRadius=.025,this.scaleOrientMinDistance=1,this.scaleOrientArrowTipLength=.3,this.scaleOrientArrowTipFocusMultiplier=2/1.5,this.observerSize=5,this.hoverTimeoutMilliseconds=1e3,this.viewAngleThreshold=10}getFovArcWidth(e){return e?this.fovFocusedArcWidth:this.fovUnfocusedArcWidth}getScaleOrientArrowTipLength(e){return this.scaleOrientArrowTipLength*(e?this.scaleOrientArrowTipFocusMultiplier:1)}};const C=new class{constructor(){this.frameWidthNotSelected=.3,this.frameWidthSelected=1,this.frameColor=new b.A([255,255,255,.99]),this.observerPointConfiguration={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0,color:b.A.toUnitRGBA(new b.A([3,252,111,1]))},this.shapeMaterialParameters={color:[.33,.33,.33,.25],renderOccluded:T.m$.Occlude,cullFace:D.s2.Back,writeDepth:!1}}};var x=i(32864),F=i(19247),P=i(13927),E=i(18690),H=i(98773),z=i(73582),I=i(50346),Z=i(64465),U=i(88321),L=i(79650),k=i(38317),N=i(7947),j=i(81923),B=i(71372);function W(e,t){let{tiltedUpVector:i,rightVector:s,observerRenderSpace:a}=e;const r=(0,k.wQ)(i,s,a,t);return r[12]=0,r[13]=0,r[14]=0,r}function $(e,t,i,s){const a=(0,v.vt)(),r=(0,P.Qj)(i.plane),n=function(e,t){const i=G;e.renderCoordsHelper.toRenderCoords(e.camera.position,i);const s=(0,j.ZC)(e,i,e.camera.heading,e.camera.tilt,(0,B.NP)()).direction;return(0,y.KJ)((0,p.p)(s,t))-90}(t,r);let o;if(Math.abs(n)>R.viewAngleThreshold)o=e.next((0,N.AA)(t,i.plane));else{const a=(0,P.O_)(s.targetRenderSpace,i.basis1,(0,P.vt)()),r=(0,p.n)(G,i.basis1),n=(0,p.n)(K,i.basis2);o=e.next((0,N.AA)(t,a)).next(e=>{const t=e=>{const t=(0,p.e)((0,p.a)(Q,e,i.origin),n),a=Math.acos((0,y.qE)(t/s.farDistanceRenderSpace,-1,1)),o=Math.sin(a)*s.farDistanceRenderSpace;return(0,p.f)((0,v.vt)(),i.origin,(0,p.f)((0,v.vt)(),(0,p.g)(Q,r,o),(0,p.g)(X,n,t)))},a=t(e.renderStart),o=t(e.renderEnd);return{...e,renderStart:a,renderEnd:o}})}return o.next(e=>{"start"===e.action&&(0,p.c)(a,e.renderStart);const t=(0,y.KJ)((0,k.FY)(a,e.renderEnd,i.origin,r));return{...e,deltaAngle:t}})}function q(e,t,i,s){return(0,S.$0)(Y,i,s),(0,p.t)(e,t,Y)}const G=(0,v.vt)(),K=(0,v.vt)(),Q=(0,v.vt)(),X=(0,v.vt)(),Y=(0,O.vt)();var J=i(56121),ee=i(91175),te=i(19112),ie=i(36452),se=i(62577),ae=i(86994),re=i(425),ne=i(17046),oe=i(76336);class le extends ie.A{constructor(e){super(),this._handles=new U.A,this._tool=e.tool,this._view=e.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator(e=>this._tool.manipulators.add(e))}destroy(){this._handles=(0,c.pR)(this._handles),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulators=null}createDragPipeline(e,t){const i=Object.values(this._manipulators);return(0,V.vE)(i.map(i=>{let{manipulator:s,side:a}=i;return(0,ne.Xt)(s,(i,s,r,n,o)=>{const l=function(e,t){let{observerRenderSpace:i,targetRenderSpace:s,tiltedUpVector:a,rightVector:r,farDistanceRenderSpace:n}=t;const o=(0,p.a)(ue,s,i),l=ce(e)?r:a,c=(0,p.g)(pe,l,n);return(0,L.f)(i,o,c)}(a,t),c=s.next(e=>({...e,manipulatorType:te.r.SCALE,side:a})),h=$(c,this._view,l,t);e(i,h,r)})}))}updateManipulatorsTransform(e){e.arcCentersPoints(ve),this._forEachManipulatorInfo(t=>this._updateArcManipulatorTransform(t,e,ve[t.side]))}updateManipulatorVisuals(e){this._forEachManipulatorInfo(t=>this._updateArcManipulatorVisuals(t,e))}_updateArcManipulatorVisuals(e,t){let{manipulator:i,side:s}=e;const a=[];if(null!=t){const[e,r]=function(e,t,i){const{horizontalFieldOfView:s,verticalFieldOfView:a}=t,r=ce(e),n=(0,y.kU)((0,y.qE)((r?a:s)/2,0,15)),o=function(e,t,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10;(0,ae.vA)(s>1,"createArcPolylineGeometry() needs at least 2 for numVertices");const a=t-e;if(a<=0||i<=0)return[(0,v.fA)(0,0,.01),(0,v.fA)(0,0,-.01)];const r=[],n=a/s;for(let o=0;o<s;o++){let a=e+o*n;o===s-1&&(a=t);const l=Math.cos(a)*i,c=Math.sin(a)*i,h=(0,v.fA)(l-i,0,c);r.push(h)}return r}(-n/2,n/2,r?1:Math.max(Math.sin((0,y.kU)(90-a/2)),.1));return[(0,se.Z8)(i,o),o]}(s,t,this._unfocusedArcMaterial);a.push(new ee.M(e,oe.p7.Unfocused),new ee.M(e.instantiate({material:this._focusedArcMaterial}),oe.p7.Focused)),i.collisionType={type:"line",paths:[r]}}i.renderObjects=a,i.radius=R.collisionRadius}_updateArcManipulatorTransform(e,t,i){let{manipulator:s,side:a}=e;const r=t.horizontalFieldOfView,n=(0,y.kU)(t.verticalFieldOfView/2),o=(0,y.kU)(r/2),l=ce(a);s.renderLocation=i;const c=(0,O.vt)(),h=e=>{(0,S.lw)(c,e,c)};h((0,S.i1)(de,(0,y.kU)(-90))),l||h((0,S.hM)(de,n));const d=t.farDistanceRenderSpace;let u,v;h((0,S.CV)(de,(0,p.i)(ue,d,d,d))),h((0,S.N9)(de,function(e){return function(e){switch(e){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}(e)*he}(a))),h(W(t,de)),l?(u=o,v=t.tiltedUpVector):(v=t.rightVector,u=n),u*="right"===a||"bottom"===a?-1:1;const w=(0,S.$0)(de,u,v);null!=w&&h(w),s.modelTransform=c}_createManipulators(){const e=this._createArcManipulator("left"),t=this._createArcManipulator("right"),i=this._createArcManipulator("top"),s=this._createArcManipulator("bottom");this._manipulators={left:e,right:t,top:i,bottom:s},[[s.manipulator,i.manipulator],[e.manipulator,t.manipulator]].forEach(e=>{let[t,i]=e;t.metadata={pairedManipulator:i},i.metadata={pairedManipulator:t}})}_createArcManipulator(e){const t=new J.q({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),i={manipulator:t,side:e};return this._updateArcManipulatorVisuals(i),this._handles.add(t.events.on("focus-changed",e=>{const i=t.metadata?.pairedManipulator;null!=i&&(i.hovering!==t.hovering&&(i.hovering=t.hovering),i.grabbing!==t.grabbing&&(i.grabbing=t.grabbing))})),i}_createArcMaterial(e){const t=R.getFovArcWidth(e),i=new re.W({renderOccluded:T.m$.OccludeAndTransparent,isDecoration:!0,width:t});return this._handles.add((0,h.wB)(()=>b.A.toUnitRGBA(this._view.effectiveTheme.accentColor),e=>i.setParameters({color:e}),h.Vh)),i}forEachManipulator(e){Object.values(this._manipulators).forEach(t=>{let{manipulator:i}=t;return e(i,te.r.SCALE)})}_forEachManipulatorInfo(e){Object.values(this._manipulators).forEach(t=>e(t))}get test(){return{manipulators:this._manipulators}}}function ce(e){return"left"===e||"right"===e}const he=Math.PI/2,de=(0,O.vt)(),ue=(0,v.vt)(),pe=(0,v.vt)(),ve={top:(0,v.vt)(),bottom:(0,v.vt)(),left:(0,v.vt)(),right:(0,v.vt)()};var we=i(95925),fe=i(93131),_e=i(76956);class me extends J.q{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:R.collisionRadius}),this._handles=new U.A,this._setupManipulatorVisual(t)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(e){const t=this._createMaterial(),i=[(0,v.fA)(0,0,0),(0,v.fA)(0,0,1)],s=(0,se.Nb)(t,i,e,16,!1),a=(0,se.Nb)(t,i,e*fe.UF,16,!1),r=ge(!1,t,e),n=ge(!0,t,e),o=(0,O.vt)();(0,S.kN)(o,i[i.length-1]),(0,S.lK)(o,o,(0,S.hM)(Ve,Math.PI/2)),(0,S.lK)(o,o,(0,S.i1)(Ve,Math.PI/2)),r.transformation=o,n.transformation=o,this.renderObjects=[new ee.M(s,oe.p7.Unfocused),new ee.M(a,oe.p7.Focused),new ee.M(r,oe.p7.Unfocused),new ee.M(n,oe.p7.Focused)];const l=(0,v.fA)(0,R.getScaleOrientArrowTipLength(!0),0),c=(0,p.t)(l,l,o),h=[...i,c];this.collisionType={type:"line",paths:[h]}}_createMaterial(){const e=new _e.v({cullFace:D.s2.Back,renderOccluded:T.m$.OccludeAndTransparent,isDecoration:!0});return this._handles.add((0,h.wB)(()=>b.A.toUnitRGBA(this.view.effectiveTheme.accentColor),t=>e.setParameters({color:t}),h.Vh)),e}}function ge(e,t,i){const s=R.getScaleOrientArrowTipLength(e);let a=2*i;e&&(a*=fe.UF);const r=s/2;return(0,se._B)(t,s,r,r,a,0)}const Ve=(0,O.vt)();var be=i(46947);class Me extends ie.A{constructor(e){super(),this._handles=new U.A,this._tool=e.tool,this._view=e.view;const t=R.scaleOrientHandleRadius;this._manipulatorHeading=new me(this._view,t),this._manipulatorTilt=new me(this._view,t),this._manipulatorDistance=new me(this._view,t),this.forEachManipulator(e=>this._tool.manipulators.add(e))}destroy(){this._handles.destroy(),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(e,t){return(0,ne.Xt)(this._manipulatorHeading,(i,s,a,r,n)=>{const o=this._view,{tiltParallelToSurface:l,farDistanceRenderSpace:c,upVector:h,observerRenderSpace:d,targetRenderSpace:u,rightVector:v}=t,w=Math.sin((0,y.kU)(l))*c,f=(0,p.f)(Oe,d,(0,p.g)(De,h,w)),_=(0,p.a)(De,u,f),m=(0,p.g)(Te,v,(0,p.H)(_)),g=$(s,o,(0,L.f)(f,_,m),t).next(e=>({...e,manipulatorType:te.r.ROTATE}));e(i,g,a)})}createTiltDragPipeline(e,t){return(0,ne.Xt)(this._manipulatorTilt,(i,s,a,r,n)=>{const{observerRenderSpace:o,farDistanceRenderSpace:l,upVector:c,targetDirection:h}=t,d=(0,p.e)(h,c),u=(0,p.b)(Oe,h,c,-d);(0,p.g)(u,(0,p.n)(u,u),l);const v=(0,p.g)(De,c,l),w=(0,L.f)(o,u,v),f=$(s,this._view,w,t).next(e=>({...e,manipulatorType:te.r.ROTATE}));e(i,f,a)})}createDistanceDragPipeline(e,t){return(0,ne.Xt)(this._manipulatorDistance,(i,s,a,r,n)=>{const o=(0,we.fA)(t.observerRenderSpace,t.targetDirection),l=s.next((0,ne.Tp)(this._view,i.location)).next((0,N.ov)(this._view,o)).next(e=>({...e,manipulatorType:te.r.SCALE}));e(i,l,a)})}updateManipulators(e){const{targetRenderSpace:t}=e;this._manipulatorHeading.renderLocation=t,this._manipulatorTilt.renderLocation=t,this._manipulatorDistance.renderLocation=t;const i=(0,O.vt)(),s=e=>{(0,S.lw)(i,e,i)},a=R.scaleOrientSize*(be.HJ/be.Gz);s((0,S.CV)(ye,(0,p.i)(Oe,a,a,a))),s(W(e,ye));const r=R.scaleOrientHandleRadius*fe.UF*a,n=(0,p.g)(Oe,e.targetDirection,r);s((0,S.kN)(ye,n));const o=(0,S.N9)(ye,-Ae);(0,S.lK)(o,o,(0,S.i1)(Se,-Ae)),this._manipulatorHeading.modelTransform=(0,S.lK)((0,O.vt)(),i,o);const l=(0,S.i1)(ye,Ae);(0,S.lK)(l,l,(0,S.N9)(Se,Math.PI)),this._manipulatorTilt.modelTransform=(0,S.lw)((0,O.vt)(),i,l),this._manipulatorDistance.modelTransform=i}forEachManipulator(e){e(this._manipulatorHeading,te.r.ROTATE),e(this._manipulatorTilt,te.r.ROTATE),e(this._manipulatorDistance,te.r.SCALE)}}const ye=(0,O.vt)(),Se=(0,O.vt)(),Oe=(0,v.vt)(),De=(0,v.vt)(),Te=(0,v.vt)(),Ae=Math.PI/2;i(62754),i(50076);class Re extends J.q{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:R.observerSize,interactive:!1}),this._handles=new U.A;const i=(0,k.UM)(this._color);this.renderObjects=[new ee.M((0,se.CM)(i,R.observerSize,32,32))],t.manipulators.add(this),this._handles.add([(0,h.wB)(()=>this._color,e=>{i.setParameters({color:e})},h.Vh)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return b.A.toUnitRGBA(this.view.effectiveTheme.accentColor)}}(0,s._)([(0,d.MZ)()],Re.prototype,"_color",null);var Ce=i(96999),xe=i(59833);const Fe=Symbol("dragHandles"),Pe=Symbol("hideManipulators"),Ee=Symbol("hideFoVManipulators"),He=Symbol("hideObserverManipulator");let ze=class extends r.A{constructor(e){super(e),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._forceHoveringTask=null,this._forceHoveringTestPromise=null,this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new le({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new Me({view:this.view,tool:this.parentTool}),this._observerManipulator=new Re(this.view,this.parentTool),this.addHandles([(0,h.wB)(()=>this.viewshedComputedData?.observerRenderSpace,e=>{null!=e&&(this._moveManipulation.renderLocation=e,this._observerManipulator.renderLocation=e)},h.pc),(0,h.wB)(()=>this.viewshedComputedData?.heading,e=>{e&&(this._moveManipulation.angle=(0,y.kU)(90-e))},h.Vh),(0,h.wB)(()=>{const{viewshedComputedData:e}=this;return{viewshedComputedData:e,observer:e?.observer}},(e,t)=>{let{viewshedComputedData:i,observer:s}=e;this._grabbing&&s!==t?.observer||(this.removeHandles(Fe),i?.valid&&this.addHandles([this._buildObserverDragPipeline(i),this._buildFOVDragPipeline(i),this._buildScaleOrientDragPipeline(i)].filter(E.Ru),Fe))},h.Vh),(0,h.wB)(()=>{const e=this.viewshedComputedData;return e?.valid?{viewshedCompData:e,target:e.targetRenderSpace,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView}:null},e=>{null!=e&&this._fieldOfViewManipulation.updateManipulatorsTransform(e.viewshedCompData)},h.Vh),(0,h.wB)(()=>{const e=this.viewshedComputedData;return e?.valid?{viewshedCompData:e,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView,tilt:e.tilt}:null},e=>{null!=e&&this._fieldOfViewManipulation.updateManipulatorVisuals(e.viewshedCompData)},h.Vh),(0,h.wB)(()=>{const e=this.analysisViewData.visible&&(this.viewshedComputedData?.valid??!1),t=this.parentTool.selectedViewshedComputedData===this.viewshedComputedData;return{fovManipulationAvailable:e&&!this.parentTool.isPlacingTarget,nonFOVManipulationAvailable:e&&(!this.parentTool.creating||t)}},e=>{let{fovManipulationAvailable:t,nonFOVManipulationAvailable:i}=e;this._moveManipulation.available=i,this._scaleOrientManipulation.available=i,this._observerManipulator.available=i,this._fieldOfViewManipulation.available=t},h.Vh),(0,h.wB)(()=>{const e=this.viewshedComputedData;if(!e?.valid)return null;const{observer:t,target:i,verticalFieldOfView:s,horizontalFieldOfView:a}=e;return{viewshedCompData:e,observer:t,target:i,verticalFieldOfView:s,horizontalFieldOfView:a}},e=>{null!=e&&this._scaleOrientManipulation.updateManipulators(e.viewshedCompData)},h.Vh)]);this._forEachManipulator(e=>{const t=this.analysisViewData;this.addHandles([e.events.on("focus-changed",()=>{const e=this._someManipulatorHovering();e&&this.parentTool.subToolHandles.forEach(e=>{let{subTool:t}=e;t._resetHoveringTask()}),this._someManipulatorSelected()||e||(this._forceHoveringTask=(0,H.UT)(async e=>{await(this._forceHoveringTestPromise??(0,I.Pl)(R.hoverTimeoutMilliseconds,e)),(0,I.Te)(e),this._forceHoveringTask=null,this._updateManipulatorVisibility()}))}),e.events.on("grab-changed",i=>{this._grabbing="start"===i.action,"end"===i.action&&t.tool?.updateInteractionVisualsVisibility(),this.parentTool.subToolHandles.forEach(e=>{let{subTool:t}=e;t!==this&&t._setInteractive(!this._grabbing)}),this._setInteractive(t=>t.hasManipulator(e)||!this._grabbing)}),e.events.on("drag",e=>{"start"===e.action&&t.tool?.updateInteractionVisualsVisibility()})])})}destroy(){this._forceHoveringTask=(0,c.DC)(this._forceHoveringTask),this._moveManipulation=(0,c.pR)(this._moveManipulation),this._fieldOfViewManipulation=(0,c.pR)(this._fieldOfViewManipulation),this._scaleOrientManipulation=(0,c.pR)(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=(0,c.pR)(this._observerManipulator)}get viewshed(){return this.viewshedComputedData?.viewshed}get grabbing(){return this._grabbing}get observer(){return this.viewshed?.observer}set observer(e){const t=this.viewshed;null!=t&&(t.observer=e)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}get moveInteractionState(){const{dragging:e,grabbing:t}=this._moveManipulation;return{dragging:e,grabbing:t}}get scaleOrientInteractionState(){const{dragging:e,grabbing:t}=this._scaleOrientManipulation;return{dragging:e,grabbing:t}}_setInteractive(e){const t="boolean"==typeof e;this._forEachManipulation(i=>i.interactive=t?e:e(i))}onManipulatorSelectionChanged(){this._updateManipulatorVisibility(),this._someManipulatorSelected()||(this.analysisViewData.selectedViewshed===this.viewshed&&(this.analysisViewData.selectedViewshed=null),this._resetHoveringTask())}hasManipulator(e){let t=!1;return this._forEachManipulator(i=>{t=t||i===e}),t}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new Ce.v({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:be.HJ})}_buildObserverDragPipeline(e){const t=e.observer;if(null==t)return null;const i=this.view.spatialReference;return this._moveManipulation.createDragPipeline((e,s,a,r,n)=>{r=r.next((0,ne.VG)(this,["observer"]));const o=(0,w.tryProjectWithZConversion)(t,i);if(null==o)return{steps:a,cancel:r};const l=xe.p.fromGeometry(o,(0,Z.yX)(this.view.viewingMode));return{steps:a.next((0,ne.Wp)({operations:l})).next(e=>(this.observer=l.data.geometry,e)),cancel:r}},{mode:"absolute-height",offset:0},i,void 0)}_buildFOVDragPipeline(e){let t=0,i=0;return this._fieldOfViewManipulation.createDragPipeline((s,a,r)=>{if(null==e)return{steps:a,cancel:r};const n=e.viewshed;let o=null;return r=r.next((0,ne.VG)(n,["horizontalFieldOfView","verticalFieldOfView"])),{steps:a.next(s=>{"start"===s.action&&(o=null,t=e.horizontalFieldOfView,i=e.verticalFieldOfView);const a=s.deltaAngle;if(null==o&&0!==a){const e="bottom"===s.side||"left"===s.side?a>0:a<0;o=ce(s.side)?0===t&&e||360===t&&!e:0===i&&e}const r=o?function(e){return"left"===e?"right":"right"===e?"left":"top"===e?"bottom":"top"}(s.side):s.side;let l=0;switch(r){case"left":l=t/2-a;break;case"right":l=t/2+a;break;case"top":l=i+2*a;break;case"bottom":l=i-2*a}return ce(r)?(l=z.ie.normalize(l),l=l>270?0:l>180?180:l,n.horizontalFieldOfView=2*l):n.verticalFieldOfView=l,s}),cancel:r}},e)}_buildScaleOrientDragPipeline(e){let t=0,i=0;const s=(t,i)=>(s,a,r)=>{if(null==e)return{steps:a,cancel:r};const n=e.viewshed;return r=r.next((0,ne.VG)(n,[t])),{steps:a=a.next(i(n,e)),cancel:r}};return(0,V.vE)([this._scaleOrientManipulation.createHeadingDragPipeline(s("heading",(t,s)=>s=>("start"===s.action&&(i=e.heading),t.heading=z.ie.normalize(i+s.deltaAngle),s)),e),this._scaleOrientManipulation.createTiltDragPipeline(s("tilt",(i,s)=>s=>{"start"===s.action&&(t=e.tilt);let a=t+s.deltaAngle;return a<-90?a=180:a>270&&(a=0),i.tilt=Ze.clamp(a),s}),e),this._scaleOrientManipulation.createDistanceDragPipeline(s("farDistance",(e,t)=>i=>{const s=(0,p.a)(Ie,i.renderEnd,t.observerRenderSpace),a=(0,p.H)(s)*t.metersPerUnit,r=(0,p.e)(s,t.targetDirection)<0?R.scaleOrientMinDistance:a;return e.farDistance=r,i}),e)])}_updateManipulatorVisibility(){const e=this._someManipulatorSelected(),t=null!=this._forceHoveringTask||this._someManipulatorHovering(),i=this._fieldOfViewManipulation.hovering,s=this.parentTool.creating;let a=[];const r=e=>{a.push(e.disableDisplay())};e||!s&&t?this.removeHandles(Pe):(this._scaleOrientManipulation.forEachManipulator(r),this._moveManipulation.forEachManipulator(r),this.addHandles(a,Pe),a=[]),e||!s&&t||s&&i?this.removeHandles(Ee):(this._fieldOfViewManipulation.forEachManipulator(r),this.addHandles(a,Ee)),e||!s?this.removeHandles(He):this.addHandles(this._observerManipulator.disableDisplay(),He)}_resetHoveringTask(){this._forceHoveringTask=(0,c.DC)(this._forceHoveringTask),this._updateManipulatorVisibility()}_forEachManipulator(e){this._forEachManipulation(t=>{t.forEachManipulator(e)}),e(this._observerManipulator)}_forEachManipulation(e){e(this._moveManipulation),e(this._fieldOfViewManipulation),e(this._scaleOrientManipulation)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,viewshedComputedData:this.viewshedComputedData,setHoveringTimeoutPromise:e=>{this._forceHoveringTestPromise=e}}}};(0,s._)([(0,d.MZ)({constructOnly:!0})],ze.prototype,"analysis",void 0),(0,s._)([(0,d.MZ)({constructOnly:!0})],ze.prototype,"analysisViewData",void 0),(0,s._)([(0,d.MZ)({constructOnly:!0})],ze.prototype,"parentTool",void 0),(0,s._)([(0,d.MZ)({constructOnly:!0,nonNullable:!0})],ze.prototype,"view",void 0),(0,s._)([(0,d.MZ)()],ze.prototype,"viewshed",null),(0,s._)([(0,d.MZ)()],ze.prototype,"_grabbing",void 0),(0,s._)([(0,d.MZ)()],ze.prototype,"grabbing",null),(0,s._)([(0,d.MZ)()],ze.prototype,"viewshedComputedData",void 0),(0,s._)([(0,d.MZ)()],ze.prototype,"observer",null),ze=(0,s._)([(0,u.$)("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],ze);const Ie=(0,v.vt)(),Ze=new z.hr(0,180);var Ue=i(14835),Le=i(75655),ke=i(1307),Ne=i(92690),je=i(5109),Be=i(82307),We=i(46576),$e=i(11500);const qe=Symbol("interactionVisuals");let Ge=class extends je.k{constructor(e){super(e),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._placementMode=it,this._creationState=!1,this._interactionVisualElements=null,this._settings=new Ue.w({getTheme:()=>this.view.effectiveTheme}),this._selectedManipulator=null}initialize(){this._intersector=(0,We.T)(this.view.state.viewingMode),this._createInteractionVisuals();const e=this.analysisViewData.viewshedComputedDataHandles;this.subToolHandles=(0,l.L)(()=>e,e=>{let{viewshedComputedData:t}=e;const i=new ze({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:t});return{subTool:i,remove:()=>{this.selectedViewshed===t.viewshed&&(this.selectedViewshed=null),i.destroy()}}}),this.addHandles([(0,h.z7)(()=>this._valid,()=>this.finishToolCreation(),h.pc),(0,h.wB)(()=>this._stagedViewshed,e=>{const t=this.analysisViewData.viewshedComputedDataHandles;this._stagedViewshedComputedData=null!=e&&null!=t?this._findSubTool(e)?.viewshedComputedData:null},h.pc),this.analysis.viewsheds.on("after-remove",e=>{const t=this._stagedViewshed;null!=t&&e.item===t&&this.analysis.viewsheds.add(t)}),(0,h.wB)(()=>this.firstGrabbedManipulator,e=>{if(null!=e){const t=this._findSubTool(e)?.viewshed;this.selectedViewshed=t,this._selectManipulator(e)}else this._selectedSubTool?.onManipulatorSelectionChanged()},h.OH),(0,h.wB)(()=>this.view.activeTool,e=>{e!==this&&null!=e&&(this.selectedViewshed=null)}),(0,h.z7)(()=>{const e=this.selectedViewshedComputedData;return null==e?null:{subTool:this._selectedSubTool,observer:e.observerRenderSpace,target:e.targetRenderSpace}},e=>{const{subTool:t,observer:i,target:s}=e;t?.moveInteractionState.dragging?this._updateInteractionVisualsLocation(i,!0):t?.scaleOrientInteractionState.dragging&&this._updateInteractionVisualsLocation(s,!1)},h.Vh),(0,h.wB)(()=>this.creating,()=>this.updateInteractionVisualsVisibility()),(0,h.wB)(()=>this.selectedViewshed,e=>{const t=this._selectedManipulator,i=this._selectedSubTool;null==e?this._selectManipulator(null):null!=t&&i.hasManipulator(t)||this._selectManipulator(i.discManipulator)},h.Vh)])}destroy(){this.subToolHandles=(0,c.pR)(this.subToolHandles),this.removeHandles(qe)}onDeactivate(){this.removeStaged(),this._creationState=!1}get _valid(){return this.analysisViewData.viewshedComputedDataHandles?.some(e=>e.viewshedComputedData.valid)??!1}get cursor(){return this.creating?"crosshair":null}get _selectedSubTool(){return this._findSubTool(this.selectedViewshed)}_selectManipulator(e){const t=this._selectedManipulator;t!==e&&(this._selectedManipulator=e,null!=t&&(t.selected=!1),null!=e&&(e.selected=!0),this._findSubTool(t)?.onManipulatorSelectionChanged(),this._selectedSubTool?.onManipulatorSelectionChanged())}get selectedViewshed(){return this.analysisViewData.selectedViewshed}set selectedViewshed(e){this.analysisViewData.selectedViewshed=e}get selectedViewshedComputedData(){return this._selectedSubTool?.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some(e=>{let{subTool:t}=e;return t.grabbing})}get creating(){return this._creationState&&this.active}get isPlacingTarget(){return"placing-target"===this._creationState}place(e){this.selectedViewshed=null,this._placementMode=e,this._creationState="placing-observer",this._finishToolCreationIfValid()}onManipulatorSelectionChanged(){this.subToolHandles.forEach(e=>e.subTool.onManipulatorSelectionChanged())}onInputEvent(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":Be.NE.cancel===e.key?this._cancelKeyHandler(e):Be.NE.delete.includes(e.key)&&this._deleteKeyHandler();break;case"hold":this.updateInteractionVisualsVisibility(!0)}}onInputEventAfter(e){"immediate-click"===e.type&&this._clickPlacementHandler(e)}onActivate(){this._placementMode=it}_clickPlacementHandler(e){if(!this.creating||this.hasFocusedManipulators)return;const t=this._intersectScreen(e,tt);if(null!=t){if("placing-observer"===this._creationState){t.mapPoint.z=(t.mapPoint.z??0)+1.5;const e=new x.A({observer:t.mapPoint.clone(),feature:t.feature});this.analysis.viewsheds.add(e),this._stagedViewshed=e,this._creationState="placing-target",this._updateStagedViewshed(t.scenePoint)}else if("placing-target"===this._creationState){this._updateStagedViewshed(t.scenePoint);const e=this._stagedViewshed;this._stagedViewshed=null,"multiple"===this._placementMode?this._creationState="placing-observer":(this._creationState=!1,this._stagedViewshed=null,this._finishToolCreationIfValid(),this.view.activeTool=null),this.selectedViewshed=e}e.stopPropagation()}}_doubleClickHandler(e){this.creating&&(this.removeStaged(),this._creationState=!1,this.view.activeTool=null,e.stopPropagation())}_pointerMoveHandler(e){if(!this.creating)return;const t=this._intersectScreen(e,tt);null!=t&&(this._updateInteractionVisualsLocation(t.scenePoint,!1),this._updateStagedViewshed(t.scenePoint))}_cancelKeyHandler(e){this.creating?this._onCancelWhileCreating(e):this.grabbing||(this.selectedViewshed=null,e.stopPropagation())}_onCancelWhileCreating(e){const t=this.removeStaged();this._finishToolCreationIfValid(),t?(this._creationState="placing-observer",this.selectedViewshed=null,"multiple"===this._placementMode&&e.stopPropagation()):this._creationState=!1}_deleteKeyHandler(){this.creating&&(this.removeStaged(),this._creationState="placing-observer"),null!=this.selectedViewshed&&this.analysis.viewsheds.remove(this.selectedViewshed)}_finishToolCreationIfValid(){this._valid&&this.finishToolCreation()}_updateStagedViewshed(e){const t=this._stagedViewshed,i=this._stagedViewshedComputedData;if(null==t||null==i)return;const{heading:s,tilt:a,farDistance:r}=function(e,t,i){const s=t.observerRenderSpace,a=(0,p.a)(Ke,i,s),r=(0,p.H)(a)*t.metersPerUnit,n=e.renderCoordsHelper.basisMatrixAtPosition(s,Je),o=(0,p.i)(Qe,n[8],n[9],n[10]),l=(0,P.O_)(s,o,et),c=(0,P._I)(l,i,Xe),h=(0,p.a)(c,c,s),d=((0,p.H)(h)<1e-4?90:(0,y.KJ)((0,p.p)(a,h)))*((0,p.e)(o,a)<0?-1:1)+90,u=(0,p.i)(Ye,n[4],n[5],n[6]),v=(0,y.KJ)((0,p.p)(u,h)),w=(0,p.i)(Ye,n[0],n[1],n[2]);return{heading:(0,p.e)(h,w)<0?360-v:v,tilt:d,farDistance:r}}(this.view,i,e);t.farDistance=r,t.tilt=a,t.heading=s}removeStaged(){const e=this._stagedViewshed;return null!=e&&(this._stagedViewshed=null,this.analysis.viewsheds.remove(e),!0)}_intersectScreen(e,t){const i=(0,$e.sC)(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);const s=this._intersector.results.min,a=t.scenePoint;if(!s.getIntersectionPoint(a))return null;const r=t.mapPoint;return r.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(a,r),null==r?null:(t.feature=(0,Ne.Gy)(s,this.view),t)}_createInteractionVisuals(){this.removeHandles(qe);const e=this._settings.visualElements,t=new ke.o({view:this.view,attached:!1,style:{glowWidth:e.heightPlane.glowWidth,innerWidth:e.heightPlane.innerWidth},isDecoration:!0}),i=new Le.U({view:this.view,extensionType:e.zVerticalLine.extensionType,attached:!1,innerWidth:1,writeDepthEnabled:!1,renderOccluded:T.m$.OccludeAndTransparent,isDecoration:!0});this._interactionVisualElements={laserline:t,verticalLine:i},this.addHandles([(0,h.wB)(()=>e.zVerticalLine,e=>e.apply(i),h.pc),(0,h.wB)(()=>e.heightPlane,e=>e.apply(t),h.pc),(0,V.hA)(()=>{t.destroy(),i.destroy(),this._interactionVisualElements=null})],qe)}updateInteractionVisualsVisibility(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=this.creating,i=this.analysisViewData.visible,s=this._selectedSubTool,a=this.selectedViewshedComputedData,r=(e,t)=>{const i=this._interactionVisualElements;null!=i&&(i.verticalLine.attached=t,i.laserline.attached=e)};if(t)return void r(i,!1);if(null==s||null==a)return void r(!1,!1);const n=s.moveInteractionState,o=e?n.grabbing:n.dragging,l=s.scaleOrientInteractionState,c=e?l.grabbing:l.dragging,h=i&&(o||c);if(r(h,o),h){const e=o?a.observerRenderSpace:a.targetRenderSpace;this._updateInteractionVisualsLocation(e,o)}}_updateInteractionVisualsLocation(e,t){const i=this._interactionVisualElements;if(null==i)return;const{laserline:s,verticalLine:a}=i;s.heightManifoldTarget=e,s.intersectsWorldUpAtLocation=t?e:null,null!=e&&a.setStartEndFromWorldDownAtLocation(e)}_findSubTool(e){if(null==e)return null;const t=e instanceof J.q?t=>t.subTool.hasManipulator(e):t=>t.subTool.viewshed===e;return this.subToolHandles?.find(t)?.subTool}get test(){}};(0,s._)([(0,d.MZ)({constructOnly:!0})],Ge.prototype,"view",void 0),(0,s._)([(0,d.MZ)()],Ge.prototype,"analysisViewData",void 0),(0,s._)([(0,d.MZ)()],Ge.prototype,"removeIncompleteOnCancel",void 0),(0,s._)([(0,d.MZ)()],Ge.prototype,"automaticManipulatorSelection",void 0),(0,s._)([(0,d.MZ)({constructOnly:!0})],Ge.prototype,"analysis",void 0),(0,s._)([(0,d.MZ)()],Ge.prototype,"subToolHandles",void 0),(0,s._)([(0,d.MZ)()],Ge.prototype,"_stagedViewshed",void 0),(0,s._)([(0,d.MZ)()],Ge.prototype,"_stagedViewshedComputedData",void 0),(0,s._)([(0,d.MZ)()],Ge.prototype,"_placementMode",void 0),(0,s._)([(0,d.MZ)()],Ge.prototype,"_creationState",void 0),(0,s._)([(0,d.MZ)()],Ge.prototype,"_valid",null),(0,s._)([(0,d.MZ)({readOnly:!0})],Ge.prototype,"cursor",null),(0,s._)([(0,d.MZ)()],Ge.prototype,"_selectedManipulator",void 0),(0,s._)([(0,d.MZ)()],Ge.prototype,"_selectedSubTool",null),(0,s._)([(0,d.MZ)()],Ge.prototype,"selectedViewshed",null),(0,s._)([(0,d.MZ)()],Ge.prototype,"selectedViewshedComputedData",null),(0,s._)([(0,d.MZ)()],Ge.prototype,"stagedViewshed",null),(0,s._)([(0,d.MZ)()],Ge.prototype,"grabbing",null),(0,s._)([(0,d.MZ)()],Ge.prototype,"creating",null),(0,s._)([(0,d.MZ)()],Ge.prototype,"isPlacingTarget",null),Ge=(0,s._)([(0,u.$)("esri.views.3d.analysis.Viewshed.ViewshedTool")],Ge);const Ke=(0,v.vt)(),Qe=(0,v.vt)(),Xe=(0,v.vt)(),Ye=(0,v.vt)(),Je=(0,O.vt)(),et=(0,P.vt)(),tt={mapPoint:new F.A,scenePoint:(0,v.vt)(),feature:null},it="multiple";var st=i(7256),at=i(83574),rt=i(32314),nt=i(50468),ot=i(17345),lt=i(66470);class ct extends rt.X{constructor(e){super(e),this._material=null,this._viewshedComputedData=null,this._material=new _e.v({...C.shapeMaterialParameters,isDecoration:this.isDecoration,writeDepth:!1}),this.applyProperties(e)}get viewshedComputedData(){return this._viewshedComputedData}set viewshedComputedData(e){this._viewshedComputedData=e,this.updateTransform()}updateTransform(){const e=this._viewshedComputedData;if(null==e)return;const t=(0,O.vt)(),i=e.farDistanceRenderSpace;(0,S.CV)(t,(0,v.fA)(i,i,i)),W(e,wt),(0,S.lK)(t,wt,t),(0,S.kN)(wt,this._viewshedComputedData.observerRenderSpace),(0,S.lK)(t,wt,t),this.transform=t}createExternalResources(){}destroyExternalResources(){}forEachMaterial(e){e(this._material)}createGeometries(e){const{_material:t,viewshedComputedData:i}=this;null!=i&&null!=t&&i.valid&&function(e,t){const{horizontalFieldOfView:i,verticalFieldOfView:s}=t,a=(0,p.i)(dt,0,0,1),r=(0,p.i)(ut,0,1,0),n=(0,p.i)(pt,1,0,0);q(a,a,(0,y.kU)(s/2),r),q(a,a,(0,y.kU)(i/2),n);const o=e=>Math.ceil(Math.abs(e)/A)+1,l=(0,y.kU)(i),c=(0,p.c)(vt,n),h=o(l),d=ht(-l/(h-1)),u=(0,S.$0)(wt,d,c),v=(0,y.kU)(-s),w=o(v),f=ht(v/(w-1)),_=(0,p.c)(ut,r),m=(0,S.$0)(ft,(0,y.kU)(i)/2,n);(0,p.t)(_,_,m);const g=ft,V=[],b=(0,p.c)(pt,a);for(let y=0;y<h;y++){(0,S.$0)(g,f,_);for(let e=0;e<w;e++){const t=3*(e*h+y);V[t]=b[0],V[t+1]=b[1],V[t+2]=b[2],(0,p.t)(b,b,g)}(0,p.t)(_,_,u),(0,p.t)(a,a,u),(0,p.c)(b,a)}const M=h*w;V[3*M]=0,V[3*M+1]=0,V[3*M+2]=0;const O=[];for(let p=0;p<h-1;p++)for(let e=0;e<w-1;e++){const t=6*(e*(h-1)+p);O[t]=e*h+p,O[t+1]=(e+1)*h+p,O[t+2]=e*h+p+1,O[t+3]=e*h+p+1,O[t+4]=(e+1)*h+p,O[t+5]=(e+1)*h+p+1}const D=[O];if(360!==i&&0!==s){const e=[],t=[];for(let i=0;i<w-1;i++){const s=3*i;e[s]=M,e[s+1]=(i+1)*h,e[s+2]=i*h,t[s]=M,t[s+1]=i*h+h-1,t[s+2]=(i+1)*h+h-1}D.push(e,t)}if(180!==s&&0!==i){const e=[],t=[];for(let i=0;i<h-1;i++){const s=3*i;e[s]=M,e[s+1]=i,e[s+2]=i+1,t[s]=M,t[s+1]=i+(w-1)*h+1,t[s+2]=i+(w-1)*h}D.push(e,t)}return D.map(t=>{const i=[[lt.r.POSITION,new nt.n(V,t,3,!0)]];return new ot.V(e,i)})}(t,i).forEach(t=>e.addGeometry(t))}}function ht(e){return isNaN(e)?1:e}const dt=(0,v.vt)(),ut=(0,v.vt)(),pt=(0,v.vt)(),vt=(0,v.vt)(),wt=(0,O.vt)(),ft=(0,O.vt)();var _t=i(35925);let mt=class extends r.A{constructor(e){super(e),this.visible=!0,this._viewshedCorners={topLeft:(0,v.vt)(),topRight:(0,v.vt)(),bottomLeft:(0,v.vt)(),bottomRight:(0,v.vt)()},this._arcCenterPoints={top:(0,v.vt)(),bottom:(0,v.vt)(),left:(0,v.vt)(),right:(0,v.vt)()},this._parallelCenters={top:(0,v.vt)(),bottom:(0,v.vt)()}}initialize(){const e={view:this.view,isDecoration:!0},t={...e,color:this._color,renderOccluded:T.m$.OccludeAndTransparent},i={...t,stipplePattern:(0,_t.wk)(2)};this._observerVisualElement=new at.l({...e,...C.observerPointConfiguration}),this._shapeVisualElement=new ct({...e,isDecoration:this.isDecoration}),this._frameLinesVisualElement=new st.t(t),this._leftArcVisualElement=new st.t(t),this._rightArcVisualElement=new st.t(t),this._topArcVisualElement=new st.t(t),this._bottomArcVisualElement=new st.t(t),this._centralLongitude=new st.t(i),this._centralLatitude=new st.t(i),this.addHandles([(0,h.wB)(()=>{const e=this.viewshedComputedData;if(!e?.valid)return null;const t=this._viewshedCorners,i=this._arcCenterPoints,s=this._parallelCenters;return e.cornerPoints(t),e.arcCentersPoints(i),e.parallelCenterPoints(s),{viewshedComputedData:e,corners:t,arcCenters:i,parallelCenters:s,interactive:this.analysisViewData.interactive,selected:this._selected}},e=>{const t=null!=e;this._forEachVisualElement(e=>e.attached=t),t&&this._updateVisualElements(e)},{initial:!0,equals:M.aI}),(0,h.wB)(()=>{const{viewshedComputedData:e}=this,{horizontalFieldOfView:t,verticalFieldOfView:i}=e??{};return{viewshedComputedData:e,horizontalFieldOfView:t,verticalFieldOfView:i}},e=>{let{viewshedComputedData:t}=e;const{_shapeVisualElement:i}=this;t!==i.viewshedComputedData&&(i.viewshedComputedData=t),this._shapeVisualElement.recreateGeometry()},h.Vh),(0,h.wB)(()=>{const{interactive:e}=this.analysisViewData;return{visible:this.visible,selected:e&&this._selected,staged:e&&this._staged,horFovNot360:360!==this.viewshedComputedData?.horizontalFieldOfView}},e=>{let{visible:t,selected:i,staged:s,horFovNot360:a}=e;const r=i||s;this._shapeVisualElement.visible=t,this._topArcVisualElement.visible=t,this._bottomArcVisualElement.visible=t,this._frameLinesVisualElement.visible=t&&a;const n=t&&(i||a);this._leftArcVisualElement.visible=n,this._rightArcVisualElement.visible=n,this._forEachLineVisualElement(e=>{e.width=r?C.frameWidthSelected:C.frameWidthNotSelected,e.renderOccluded=i?T.m$.OccludeAndTransparent:T.m$.Occlude}),[this._centralLatitude,this._centralLongitude].forEach(e=>{e.width=2*(r?C.frameWidthSelected:C.frameWidthNotSelected),e.visible=t&&i})},h.Vh),(0,h.wB)(()=>{const{analysisViewData:{interactive:e,tool:t},_selected:i,visible:s}=this,a=this.view.activeTool,r=!t?.active&&a instanceof Ge&&a.creating;return{observerVisible:s&&!i&&(!e||(t?.creating??!1)||r),color:this._color}},e=>{let{observerVisible:t,color:i}=e;this._observerVisualElement.visible=t,this._forEachLineVisualElement(e=>e.color=i)},h.Vh)])}get _color(){const{viewshedComputedData:e,_selected:t,analysisViewData:i}=this;if(null==e)return b.A.toUnitRGBA(C.frameColor);const s=i.tool?.active||i.interactive,a=e.viewshed===i.tool?.stagedViewshed,r=s&&(t||a)?this.view.effectiveTheme.accentColor:C.frameColor;return b.A.toUnitRGBA(r)}get _selected(){const{viewshedComputedData:e,analysisViewData:{selectedViewshedComputedData:t}}=this;return null!=e&&e===t}get _staged(){const{analysisViewData:{tool:e},viewshedComputedData:t}=this;return null!=e&&e.creating&&e.stagedViewshed===t?.viewshed}destroy(){this._observerVisualElement=(0,c.pR)(this._observerVisualElement),this._shapeVisualElement=(0,c.pR)(this._shapeVisualElement),this._frameLinesVisualElement=(0,c.pR)(this._frameLinesVisualElement),this._leftArcVisualElement=(0,c.pR)(this._leftArcVisualElement),this._rightArcVisualElement=(0,c.pR)(this._rightArcVisualElement),this._topArcVisualElement=(0,c.pR)(this._topArcVisualElement),this._bottomArcVisualElement=(0,c.pR)(this._bottomArcVisualElement),this._centralLongitude=(0,c.pR)(this._centralLongitude),this._centralLatitude=(0,c.pR)(this._centralLatitude)}_forEachLineVisualElement(e){[this._frameLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(e)}_forEachVisualElement(e){this._forEachLineVisualElement(e),e(this._observerVisualElement),e(this._shapeVisualElement)}_updateVisualElements(e){const{viewshedComputedData:t,corners:i,arcCenters:s,parallelCenters:a}=e,r=(0,v.o8)(t.observerRenderSpace);this._observerVisualElement.geometry=t.observer,this._shapeVisualElement.updateTransform(),this._updateFrameLines(r,i),this._updateFrameArcs(t,i,a),this._updateCentralHelperArcs(t,s)}_updateFrameLines(e,t){this._frameLinesVisualElement.geometry=[[e,t.topLeft],[e,t.topRight],[e,t.bottomLeft],[e,t.bottomRight]]}_updateFrameArcs(e,t,i){const{observerRenderSpace:s,rightVector:a,horizontalFieldOfView:r,tiltedUpVector:n}=e,o=(0,y.kU)(r),l=(0,v.vt)(),c=(0,O.vt)();(0,S.$0)(c,o/2,n),(0,p.t)(l,a,c),gt(this._leftArcVisualElement,s,t.bottomLeft,t.topLeft,"forward",l),(0,S.$0)(c,-o/2,n),(0,p.i)(l,0,0,0),(0,p.t)(l,a,c),gt(this._rightArcVisualElement,s,t.bottomRight,t.topRight,"forward",l);const h=r>180?"backward":"forward";gt(this._topArcVisualElement,i.top,t.topRight,t.topLeft,h,n),gt(this._bottomArcVisualElement,i.bottom,t.bottomRight,t.bottomLeft,h,n)}_updateCentralHelperArcs(e,t){const i=e.observerRenderSpace,s=e.horizontalFieldOfView>=180?"backward":"forward";gt(this._centralLatitude,i,t.right,t.left,s,e.tiltedUpVector),gt(this._centralLongitude,i,t.top,t.bottom,"forward",e.leftVector)}get test(){}};function gt(e,t,i,s,a,r){let n=arguments.length>6&&void 0!==arguments[6]?arguments[6]:A;const o=(0,v.vt)();(0,p.a)(o,i,t);const l=(0,p.H)(o),c=(0,v.vt)();(0,p.a)(c,s,t),(0,p.n)(c,c),(0,p.g)(c,c,l);let h=(0,p.p)(o,c);const d=(0,v.o8)(r);"backward"===a&&((0,p.u)(d,d),h=-(2*Math.PI-h));const u=[],w=Math.ceil(Math.abs(h)/n),f=(0,O.vt)();(0,S.$0)(f,h/w,d);const _=(0,v.vt)();(0,p.c)(_,o);const m=(0,v.vt)();(0,p.c)(m,i);for(let g=0;g<w;g++){const e=(0,v.vt)();(0,p.c)(e,m),(0,p.t)(_,_,f),(0,p.f)(m,t,_);const i=(0,v.vt)();(0,p.c)(i,m),u.push([e,i])}e.geometry=u}(0,s._)([(0,d.MZ)()],mt.prototype,"view",void 0),(0,s._)([(0,d.MZ)({constructOnly:!0})],mt.prototype,"isDecoration",void 0),(0,s._)([(0,d.MZ)()],mt.prototype,"analysisViewData",void 0),(0,s._)([(0,d.MZ)()],mt.prototype,"viewshedComputedData",void 0),(0,s._)([(0,d.MZ)()],mt.prototype,"visible",void 0),(0,s._)([(0,d.MZ)()],mt.prototype,"_color",null),(0,s._)([(0,d.MZ)()],mt.prototype,"_selected",null),(0,s._)([(0,d.MZ)()],mt.prototype,"_staged",null),mt=(0,s._)([(0,u.$)("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],mt);let Vt=class extends r.A{get visible(){return this.analysisViewData.visible}constructor(e){super(e)}initialize(){const e=this.analysisViewData,t=(0,l.L)(()=>this.analysisViewData.viewshedComputedDataHandles,t=>{let{viewshedComputedData:i}=t;const s=new mt({view:this.view,viewshedComputedData:i,analysisViewData:e,isDecoration:this.isDecoration});return{visualization:s,remove:()=>s.destroy()}});this._viewshedVisualizations=t,this.addHandles([(0,V.DQ)(t),(0,h.wB)(()=>this.visible,e=>this._viewshedVisualizations.forEach(t=>{let{visualization:i}=t;return i.visible=e}),h.Vh)])}get test(){}};var bt;(0,s._)([(0,d.MZ)({constructOnly:!0})],Vt.prototype,"analysisViewData",void 0),(0,s._)([(0,d.MZ)({constructOnly:!0,nonNullable:!0})],Vt.prototype,"view",void 0),(0,s._)([(0,d.MZ)({constructOnly:!0})],Vt.prototype,"isDecoration",void 0),(0,s._)([(0,d.MZ)()],Vt.prototype,"visible",null),Vt=(0,s._)([(0,u.$)("esri.views.3d.analysis.Viewshed.ViewshedAnalysisVisualization")],Vt);let Mt=bt=class extends r.A{constructor(e){super(e),this.observerRenderSpaceOverride=null,this.needUpdateByFeature=!1}get observer(){return this.viewshed.observer??new F.A}get effectiveObserverRenderSpace(){return this.observerRenderSpaceOverride??this.observerRenderSpace}get effectiveObserver(){return this.renderSpaceToPoint(this.effectiveObserverRenderSpace,this.observer.spatialReference)}get effectiveTargetRenderSpace(){return this._computeTargetRenderSpace(this.effectiveObserverRenderSpace)}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get feature(){return this.viewshed.feature}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,(0,v.vt)())}get target(){const e=this.targetRenderSpace;return this.renderSpaceToPoint(e,this.observer.spatialReference)}get targetRenderSpace(){return this._computeTargetRenderSpace(this.observerRenderSpace)}get targetDirection(){const e=(0,p.a)((0,v.vt)(),this.targetRenderSpace,this.observerRenderSpace);return(0,p.n)(e,e)}get tiltedUpVector(){const e=q((0,v.vt)(),this.upVector,-(0,y.kU)(this.tiltParallelToSurface),this.leftVector);return(0,p.n)(e,e)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,(0,O.vt)())}get upVector(){const e=this._basis;return(0,v.fA)(e[8],e[9],e[10])}get northVector(){const e=this._basis;return(0,v.fA)(e[4],e[5],e[6])}get leftVector(){const e=this.upVector,t=q((0,v.vt)(),this.northVector,-(0,y.kU)(this.heading),e);return(0,p.h)(t,e,t)}get rightVector(){return(0,p.u)((0,v.vt)(),this.leftVector)}clone(){return new bt({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}get valid(){return this.viewshed.valid}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(e,t,i){const{observerRenderSpace:s,targetRenderSpace:a}=this,r=(0,p.a)(yt,a,s);return q(r,r,-(0,y.kU)(t),this.leftVector),q(r,r,-(0,y.kU)(e),this.tiltedUpVector),(0,p.f)(i,r,s)}cornerPoints(e){const t=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(-t,i,e.topLeft),this.pointOnSphere(t,i,e.topRight),this.pointOnSphere(-t,-i,e.bottomLeft),this.pointOnSphere(t,-i,e.bottomRight)}arcCentersPoints(e){const t=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(0,i,e.top),this.pointOnSphere(0,-i,e.bottom),this.pointOnSphere(-t,0,e.left),this.pointOnSphere(t,0,e.right)}parallelCenterPoints(e){const t=this.observerRenderSpace,i=this.farDistanceRenderSpace*Math.sin((0,y.kU)(this.verticalFieldOfView/2)),s=(0,p.g)(yt,this.tiltedUpVector,i);(0,p.f)(e.top,t,s),(0,p.a)(e.bottom,t,s)}renderSpaceToPoint(e,t){const i=yt;return this.renderCoordsHelper.fromRenderCoords(e,i,t),new F.A(i[0],i[1],i[2],t)}_pointToRenderSpace(e,t){const i=(0,v.ci)(e.toArray());return this.renderCoordsHelper.toRenderCoords(i,e.spatialReference,t),t}_computeTargetRenderSpace(e){const{leftVector:t,northVector:i,upVector:s}=this,a=this.farDistanceRenderSpace,r=(0,v.vt)();return(0,p.g)(r,i,a),q(r,r,-(0,y.kU)(this.heading),s),q(r,r,-(0,y.kU)(this.tiltParallelToSurface),t),(0,p.f)(r,e,r),r}};(0,s._)([(0,d.MZ)()],Mt.prototype,"renderCoordsHelper",void 0),(0,s._)([(0,d.MZ)()],Mt.prototype,"viewshed",void 0),(0,s._)([(0,d.MZ)()],Mt.prototype,"observerRenderSpaceOverride",void 0),(0,s._)([(0,d.MZ)()],Mt.prototype,"needUpdateByFeature",void 0),(0,s._)([(0,d.MZ)()],Mt.prototype,"observer",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"effectiveObserverRenderSpace",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"effectiveObserver",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"effectiveTargetRenderSpace",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"farDistance",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"farDistanceRenderSpace",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"heading",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"tilt",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"feature",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"tiltParallelToSurface",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"horizontalFieldOfView",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"verticalFieldOfView",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"observerRenderSpace",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"target",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"targetRenderSpace",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"targetDirection",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"tiltedUpVector",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"_basis",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"upVector",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"northVector",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"leftVector",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"rightVector",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"valid",null),(0,s._)([(0,d.MZ)()],Mt.prototype,"metersPerUnit",null),Mt=bt=(0,s._)([(0,u.$)("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],Mt);const yt=(0,v.vt)();var St=i(29808),Ot=i(3112),Dt=i(19276),Tt=i(78315),At=i(90364),Rt=i(36451),Ct=i(71118),xt=i(74957),Ft=i(81330),Pt=i(55855),Et=i(33062);let Ht=class extends Et.A{constructor(){super(...arguments),this.sectionAngles=(0,Pt.vt)()}get sectionAnglesDeg(){return(0,Pt.ci)(this.sectionAngles.map(e=>(0,y.KJ)(e)))}set sectionAnglesDeg(e){this.sectionAngles=(0,Pt.ci)(e.map(e=>(0,y.kU)(e)))}get projectionMatrix(){return(0,S.lK)((0,O.vt)(),this.sectionMatrix,this._projectionMatrixInternal)}get sectionMatrix(){const e=this.sectionAngles[0],t=this.sectionAngles[1],i=this.sectionAngles[2],s=this.sectionAngles[3];(0,ae.vA)(e<=t),(0,ae.vA)(i<=s);const a=2*Math.tan(this.fovX/2),r=2*Math.tan(this.fovY/2),n=Math.tan(e),o=Math.tan(t),l=Math.tan(i),c=o-n,h=Math.tan(s)-l,d=a/c,u=r/h,p=-(n+c/2)/a*2,v=-(l+h/2)/r*2,w=(0,O.vt)();(0,S.kN)(w,[p,v,0]);const f=(0,O.vt)();(0,S.CV)(f,[d,u,1]);const _=(0,O.vt)();return(0,S.lK)(_,f,w)}get _sectionRatioX(){const e=Math.tan(this.sectionAngles[0]),t=Math.tan(this.sectionAngles[1]),i=2*Math.tan(this.fovX/2);return Math.min(1,(t-e)/i)}setViewport(e,t){const i=t*this._sectionRatioX;return this.viewport=[e[0],e[1],i,t],i}};(0,s._)([(0,d.MZ)()],Ht.prototype,"sectionAngles",void 0),(0,s._)([(0,d.MZ)()],Ht.prototype,"sectionAnglesDeg",null),(0,s._)([(0,d.MZ)()],Ht.prototype,"projectionMatrix",null),(0,s._)([(0,d.MZ)()],Ht.prototype,"sectionMatrix",null),(0,s._)([(0,d.MZ)()],Ht.prototype,"_sectionRatioX",null),Ht=(0,s._)([(0,u.$)("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],Ht);var zt=i(93345),It=i(82751);class Zt{constructor(){this.textureSizeQuality=1,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(e){const t=e?this.textureSizeModHighQuality:this.textureSizeModLowQuality;return this.textureSizeQuality*t}textureResizeModulo(e){return Math.ceil(e/this.textureSizeMultiple)*this.textureSizeMultiple}}const Ut=["front","left","right","back","top","bottom"];class Lt{constructor(e){this._fbos=e,this._faces={},this._width=0,this._height=0,this.settings=new Zt,this._maxTextureSize=Math.min((0,n.A)("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}get depthTexture(){return this._handle?.getTexture(zt.nI)}get ready(){return null!=this.depthTexture&&0!==this._width&&0!==this._height}get nearFar(){const e=this.faces;return 0===e.length?null:e[0].nearFar}get numActiveFaces(){const e=this._faces;let t=0;return Object.keys(e).forEach(i=>{e[i]&&(t+=1)}),t}get faces(){const e=this._faces,t=[];for(const i of Ut){const s=e[i];s&&t.push(s)}return t}get atlasRegions(){return this.faces.map(e=>[e.x/this._width,(e.x+e.width)/this._width,e.y/this._height,(e.y+e.height)/this._height])}get viewshedProjectionMatrices(){return this.faces.map(e=>e.projectionMatrix)}get viewshedViewMatrices(){return this.faces.map(e=>e.viewMatrix)}_setupFaceCamera(e,t,i,s){const{effectiveObserverRenderSpace:a,tiltedUpVector:r,targetRenderSpace:n,farDistanceRenderSpace:o,horizontalFieldOfView:l,verticalFieldOfView:c}=t,h=(0,v.vt)();(0,p.a)(h,n,a);const d=(0,v.vt)(),u=(0,v.vt)(),w=(e,t)=>{const i=(0,v.vt)(),s=(0,O.vt)();return(0,S.$0)(s,e,t),(0,p.t)(i,h,s),(0,p.f)(i,a,i),i};let f,_=r;const m=Math.min(90,l),g=Math.min(90,Math.max(0,(l-90)/2));let V=-45,b=45,M=-45,D=45;if(function(e){return!["top","bottom"].includes(e)}(e)){const e=e=>(0,y.qE)(e,-45,45);M=e(-c/2)-this.settings.toleranceBottomTop,D=e(+c/2)+this.settings.toleranceBottomTop}switch(e){case"front":f=n,V=-m/2,b=m/2;break;case"left":f=w(Math.PI/2,r),V=45-g;break;case"right":f=w(-Math.PI/2,r),b=-45+g;break;case"top":f=(0,p.f)(d,a,r),_=(0,p.u)(u,h);break;case"bottom":f=(0,p.a)(d,a,r),_=h;break;case"back":f=w(Math.PI,r)}const T=new Ht({center:f,eye:a,up:_,far:o});T.sectionAnglesDeg=[V-this.settings.toleranceSides,b+this.settings.toleranceSides,M,D],T.fovY=Math.PI/2;const A=T.setViewport(i,s);return this._faces[e]=T,A}isActive(e){return this._computeActiveFaces(e).size>0}_computeActiveFaces(e){const t=new Set,{horizontalFieldOfView:i,verticalFieldOfView:s}=e,a=-s/2,r=s/2;return 0===i||0===s||(a<=45&&r>=-45&&t.add("front"),i>90&&(t.add("left"),t.add("right")),i>270&&t.add("back"),r>45-this.settings.toleranceBottomTop&&t.add("top"),a<-45+this.settings.toleranceBottomTop&&t.add("bottom")),t}_computeBaseTextureSize(e,t,i,s){let{pixelRatio:a,fullWidth:r,fullHeight:n}=e;const o=t/a,l=this.settings.textureSizeModifier(i);return(0,Ft.Mv)(Math.max(r,n)*o*l,this._maxTextureSize/s)}_ensureFBO(e){const t=this._width,i=this._height,s=this._handle?.fbo;s&&s.width===t&&s.height===i&&e===(0,It.QJ)(s.depthStencilTexture?.descriptor?.internalFormat??zt.SB.DEPTH_COMPONENT16)||(this._handle?.release(),this._handle=this._allocateFBO(e))}_allocateFBO(e){const{_width:t,_height:i}=this,s=e?xt.zd.DEPTH24_STENCIL8:xt.zd.DEPTH16,a=this._fbos.acquire(t,i,"viewshed shadow map",s);return a.getTexture(zt.nI)?.setShadowFiltering(!1),a}clearFBO(e){const t=this._fbos.rctx;this._ensureFBO(e),t.bindFramebuffer(this._handle?.fbo),t.setClearColor(1,1,1,1),t.clear(zt.NV.COLOR|zt.NV.DEPTH)}dispose(){this._debugFBO||(this._handle=(0,c.Gz)(this._handle))}start(e,t,i,s){let a=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this._faces={};const r=this._computeActiveFaces(t),n=r.size;if(0===n)return!1;const o=this._computeBaseTextureSize(e,s,i,n);let l=0,c=0,h=0;return Ut.filter(e=>r.has(e)).forEach(e=>{const i=function(e,t){if(t<4)return 0;const i="front"===e||"left"===e;return 4===t?i?0:1:i||"right"===e?0:1}(e,n);i>c&&(h=Math.max(h,l),l=0),c=i;const s=i*o;l+=this._setupFaceCamera(e,t,[l,s],o)}),h=Math.max(h,l),this._width=this.settings.textureResizeModulo(h),this._height=function(e){return e<4?1:2}(n)*o,this.clearFBO(a),!0}finish(){}get test(){}}var kt=i(27456),Nt=i(16506),jt=i(59246),Bt=i(57162);class Wt extends jt.w{constructor(e,t){super(e,t,new Nt.$(kt.a,()=>i.e(28758).then(i.bind(i,28758))))}initializePipeline(){return(0,Bt.Ey)({colorWrite:Bt.kn,blending:Bt.T8})}}let $t=class extends Rt.A{get shadowMap(){return this._shadowMap}get hasViewsheds(){return this._viewsheds.length>0}get _contentPixelRatio(){return this.view.state.contentPixelRatio}get _viewshedsInView(){return this._viewsheds.items.filter(e=>function(e,t){const i=(0,Tt.h)(t.observerRenderSpace,t.farDistanceRenderSpace);return!!e.ready&&e.frustum.intersectsSphere(i)}(this.view,e))}constructor(e){super(e),this.isDecoration=!1,this._passParameters=new kt.V,this._viewsheds=new Dt.A,this._shadowMap=null,this.consumes={required:[At.OG.VIEWSHED,"normals"]},this.produces=At.OG.VIEWSHED,this.requireGeometryDepth=!0}initialize(){this._shadowMap=new Lt(this.fboCache),this.addHandles([(0,h.wB)(()=>this.view.resolutionScale,e=>{const t=this._shadowMap;t&&(t.settings.textureSizeQuality=e)},h.Vh),(0,h.z7)(()=>!this.hasViewsheds,()=>this._shadowMap?.dispose()),(0,h.wB)(()=>this._viewshedsInView.map(e=>[e.observerRenderSpace,e.heading,e.tilt,e.farDistance,e.horizontalFieldOfView,e.verticalFieldOfView]),()=>this.requestRender(D.C7.UPDATE),h.OH)])}destroy(){this._shadowMap=(0,c.WD)(this._shadowMap)}precompile(){if(this.hasViewsheds){this.techniques.precompile(Wt);for(const e of this._viewshedsInView)if(this._shadowMap?.isActive(e))return void this.view.stage.renderer.precompileViewshedShadowMap()}}render(e){const t=this.bindParameters,i=this.renderingContext,s=e.find(e=>{let{name:t}=e;return t===At.OG.VIEWSHED});if(!this.hasViewsheds||!t.depth||this.isDecoration&&!t.decorations)return s;this._passParameters.shadowMap=this._shadowMap??this._passParameters.shadowMap,this._passParameters.normals=e.find(e=>{let{name:t}=e;return"normals"===t})?.getTexture();const a=this.techniques.get(Wt);if(!a?.compiled)return this.requestRender(D.C7.UPDATE),s;const r=this.view.stage.renderer.isFeatureEnabled(Ct.n.HighResolutionViewshed);for(const n of this._viewshedsInView){if(!this._renderShadowCubeMap(t,n,r)||!this._shadowMap?.ready)continue;const e=this._setupViewshedParameters(n,t.camera);i.bindTechnique(a,t,e),i.bindFramebuffer(s.fbo),i.screen.draw()}return this.shadowMap?.dispose(),s}updateViewsheds(e){const t=this._viewsheds,{removes:i,adds:s}=e;if(i&&(Array.isArray(i)?t.removeMany(i):t.remove(i)),s)if(Array.isArray(s)){const e=s.filter(e=>!t.includes(e));t.addMany(e)}else t.includes(s)||t.add(s)}_renderShadowCubeMap(e,t,i){const s=this._shadowMap;if(!s)return!1;const a=this.view.basemapTerrain.hasStencilEnabledExtents,r=s.start(e.camera,t,i,this._contentPixelRatio,a);return r&&s.faces.forEach(e=>this.view.stage.renderer.renderViewshedShadowMap(e)),s.finish(),r}_setupViewshedParameters(e,t){const i=this._shadowMap;if(!i)return this._passParameters;const s=this._passParameters,a=e.effectiveObserverRenderSpace;s.localOrigin=a,s.observerOffset=(0,p.a)(Gt,e.observerRenderSpace,e.effectiveObserverRenderSpace),s.fovs=[(0,y.kU)(e.horizontalFieldOfView),(0,y.kU)(e.verticalFieldOfView)],s.headingAndTilt=[(0,y.kU)(e.heading),(0,y.kU)(e.tiltParallelToSurface)],s.upVector=e.tiltedUpVector;const r=function(e,t){const i=(0,v.vt)();return(0,p.a)(i,e,t)}(e.targetRenderSpace,a);s.targetVector=r;const n=new Array,o=new Array;for(let l=0;l<i.numActiveFaces;l++)(0,S.Tl)(Kt,i.viewshedViewMatrices[l],a),n.push(...Kt),qt(i.viewshedProjectionMatrices[l],Kt,Qt),o.push(...Qt);return s.viewMatrices=n,s.projectionMatrices=o,s.volumeOffset=this.selectedViewshed?.()===e.viewshed?function(e,t,i){if(null==e)return 0;const{observerRenderSpace:s,targetRenderSpace:a}=e,r=(0,p.j)(i,s)>(0,p.j)(i,a)?e.observer:e.target;return t.pixelSizeAt(r)}(e,this.view,t.eye):0,s}get test(){return{viewsheds:this._viewsheds,shadowMap:this._shadowMap,viewshedsInView:this._viewshedsInView}}};function qt(e,t,i){const s=(0,v.fA)(.5,.5,.5);return(0,S.kN)(i,s),(0,S.hs)(i,i,s),(0,S.lK)(i,i,e),(0,S.lK)(i,i,t),i}(0,s._)([(0,d.MZ)()],$t.prototype,"selectedViewshed",void 0),(0,s._)([(0,d.MZ)()],$t.prototype,"isDecoration",void 0),(0,s._)([(0,d.MZ)()],$t.prototype,"shadowMap",null),(0,s._)([(0,d.MZ)()],$t.prototype,"hasViewsheds",null),(0,s._)([(0,d.MZ)()],$t.prototype,"_contentPixelRatio",null),(0,s._)([(0,d.MZ)()],$t.prototype,"_viewshedsInView",null),(0,s._)([(0,d.MZ)()],$t.prototype,"consumes",void 0),(0,s._)([(0,d.MZ)()],$t.prototype,"produces",void 0),$t=(0,s._)([(0,u.$)("esri.views.3d.webgl-engine.lib.Viewshed")],$t);const Gt=(0,v.vt)(),Kt=(0,O.vt)(),Qt=(0,O.vt)();var Xt=i(10260);let Yt=class extends((0,m.P)(r.A)){constructor(e){super(e),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this._selectedViewshed=null,this.viewshedComputedDataHandles=null,this.userOperation=null,this._viewshedRenderer=null,this._intersector=null}get selectedViewshed(){return this._selectedViewshed}set selectedViewshed(e){this._unselectOtherViewsheds(e),this._selectedViewshed=e}get selectedViewshedComputedData(){return this.tool?.selectedViewshedComputedData}get _isDecoration(){return!this.parent}initialize(){const e=this.view;this._viewshedRenderer=new $t({view:e,selectedViewshed:()=>this.selectedViewshed??this.tool?.stagedViewshed,isDecoration:this._isDecoration}),this._intersector=new St.n(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=Ot.o.MIN,this.viewshedComputedDataHandles=(0,l.L)(()=>this.analysis.viewsheds,t=>{const i=new Mt({renderCoordsHelper:e.renderCoordsHelper,viewshed:t}),s=Symbol();return this.addHandles([(0,h.wB)(()=>({valid:i.valid,canProject:(0,w.canProjectWithoutEngine)(i.observer?.spatialReference,this.view.spatialReference)||(0,w.isLoaded)()}),(e,t)=>{let{valid:s,canProject:a}=e;this.visible&&(s&&a?this._addViewshedsToRenderer(i):t?.valid&&t?.canProject&&this._removeViewshedsFromRenderer(i),a||(0,g.V)(this.analysis,i.observer.spatialReference,o.A.getLogger(this)))},h.Vh),...this._createFeatureReferenceHandles(i)],s),{viewshedComputedData:i,remove:()=>{this.removeHandles(s),this._removeViewshedsFromRenderer(i),i.destroy()}}}),this._analysisVisualization=new Vt({view:e,analysisViewData:this,isDecoration:this._isDecoration}),this.addHandles([(0,h.wB)(()=>this.visible,e=>{const t=this.viewshedComputedDataHandles;if(null==t)return;e||(this.selectedViewshed=null);const i=t.map(e=>e.viewshedComputedData).filter(e=>e.valid).toArray();e?this._addViewshedsToRenderer(i):this._removeViewshedsFromRenderer(i)}),(0,h.wB)(()=>e.renderCoordsHelper,e=>{this.viewshedComputedDataHandles?.forEach(t=>{let{viewshedComputedData:i}=t;return i.renderCoordsHelper=e})}),(0,Xt.Hd)(this,Ge),(0,h.z7)(()=>this.interactive,()=>{this._unselectOtherViewsheds(this.selectedViewshed)},h.pc)])}destroy(){this.userOperation=(0,c.DC)(this.userOperation),(0,Xt.aS)(this),this._analysisVisualization=(0,c.pR)(this._analysisVisualization);const e=this.viewshedComputedDataHandles;null!=e&&this._removeViewshedsFromRenderer(e.map(e=>e.viewshedComputedData).toArray())}_createFeatureReferenceHandles(e){const{view:t}=this;return[(0,h.wB)(()=>[t.state.camera,t.slice.plane,e.viewshed.observer,e.targetRenderSpace,e.verticalFieldOfView,e.horizontalFieldOfView,e.feature],()=>{this._updateObserverFromFeature(t,e)},h.Vh),this._createElevationUpdateHandle(e),(0,h.z7)(()=>e.needUpdateByFeature,()=>{this._updateObserverFromFeature(t,e),e.needUpdateByFeature=!1})]}_createElevationUpdateHandle(e){const t=(i,s)=>{const{view:a}=this,{observer:r}=e;if(null==r)return;const n=(0,w.projectOrLoad)(r,a.spatialReference);if(null!=n.pending)return void n.pending.finally(()=>t(i,s));const o=n.geometry;null!=o&&((0,f.S)(i,s,ei,a.spatialReference),(0,_.Uc)(ei,[o.x,o.y])&&(e.needUpdateByFeature=!0))};return this.view.elevationProvider.on("elevation-change",e=>{let{extent:i,spatialReference:s}=e;return t(i,s)})}async createViewsheds(e){await(0,Xt.ZX)(this,{placementOptions:e,onToolActivated:e=>e.place("multiple")})}place(e){return(0,Xt.ZX)(this,{placementOptions:e,onToolActivated:e=>e.place("single")})}_addViewshedsToRenderer(e){this._viewshedRenderer.updateViewsheds({adds:e})}_removeViewshedsFromRenderer(e){this._viewshedRenderer.updateViewsheds({removes:e})}_updateObserverFromFeature(e,t){const i=t.observerRenderSpace,s=t.targetRenderSpace,r=(0,p.c)((0,v.vt)(),i),n={observer:i,observerSurfaceNormal:null,observerAdjusted:r,observerFeatureId:(0,a.wY)(t.feature),target:s,targetSurfaceNormal:null,targetAdjusted:(0,p.c)((0,v.vt)(),s),targetFeatureId:null};(0,a.uY)(e,this._intersector,n,e=>Math.min(e,.05*t.farDistanceRenderSpace)),t.observerRenderSpaceOverride=(0,p.q)(r,i)?null:r}_unselectOtherViewsheds(e){if(null!=e)for(const t of this.view.tools.items)t!==this.tool&&t instanceof Ge&&(t.analysisViewData.selectedViewshed=null)}get test(){}};(0,s._)([(0,d.MZ)({readOnly:!0})],Yt.prototype,"type",void 0),(0,s._)([(0,d.MZ)({constructOnly:!0,nonNullable:!0})],Yt.prototype,"analysis",void 0),(0,s._)([(0,d.MZ)()],Yt.prototype,"tool",void 0),(0,s._)([(0,d.MZ)()],Yt.prototype,"_selectedViewshed",void 0),(0,s._)([(0,d.MZ)()],Yt.prototype,"selectedViewshed",null),(0,s._)([(0,d.MZ)()],Yt.prototype,"selectedViewshedComputedData",null),(0,s._)([(0,d.MZ)()],Yt.prototype,"viewshedComputedDataHandles",void 0),(0,s._)([(0,d.MZ)()],Yt.prototype,"userOperation",void 0),(0,s._)([(0,d.MZ)()],Yt.prototype,"_analysisVisualization",void 0),(0,s._)([(0,d.MZ)()],Yt.prototype,"_viewshedRenderer",void 0),Yt=(0,s._)([(0,u.$)("esri.views.3d.analysis.ViewshedAnalysisView3D")],Yt);const Jt=Yt,ei=(0,_.Ie)()},42251:(e,t,i)=>{i.d(t,{N1:()=>h,uY:()=>d,wY:()=>c,xH:()=>l});var s=i(20664),a=i(9392),r=i(95925),n=i(3112),o=i(92690);function l(e,t){return c(e)===c(t)}function c(e){if(null==e)return null;const t=null!=e.layer?e.layer.id:"";let i=null;return i=null!=e.objectId?e.objectId:null!=e.layer&&"objectIdField"in e.layer&&null!=e.layer.objectIdField&&null!=e.attributes?e.attributes[e.layer.objectIdField]:e.uid,null==i?null:`o-${t}-${i}`}const h={json:{write:{writer:function(e,t){null!=e?.layer?.objectIdField&&null!=e.attributes&&(t.feature={layerId:e.layer.id,objectId:e.attributes[e.layer.objectIdField]})},target:{"feature.layerId":{type:[Number,String],isRequired:!0},"feature.objectId":{type:[Number,String],isRequired:!0}}},origins:{"web-scene":{read:function(e){if(null!=e.layerId&&null!=e.objectId)return{uid:null,layer:{id:e.layerId,objectIdField:"ObjectId"},attributes:{ObjectId:e.objectId}}}}}}};function d(e,t,i,l){const{sceneIntersectionHelper:h}=e,{observer:d,observerFeatureId:p,targetFeatureId:f,target:_}=i;if(null==p&&null==f)return;l||(l=e=>e),(0,s.a)(w,d,_);const m=(0,s.l)(w);(0,s.b)(w,d,w,1/m);const g=(0,r.Cr)(w,_,v);t.options.store=n.o.ALL,h.intersectToolIntersectorRay(g,t);let V=null,b=null,M=null,y=null;for(const s of t.results.all){const t=(0,o.Gy)(s,e);if(null==t||null==s.distanceInRenderSpace)continue;const i=c(t);null!=i&&(null!=p&&i===p&&(V??=l(u(s,e,m)),s.distanceInRenderSpace-1<V&&(M=s)),null!=f&&i===f&&(b??=l(u(s,e,m)),null==y&&s.distanceInRenderSpace-1<m&&m-s.distanceInRenderSpace+1<b&&(y=s)))}const{observerAdjusted:S,targetAdjusted:O}=i;M?.getIntersectionPoint(S)?i.observerSurfaceNormal=M.getTransformedNormal((0,a.vt)()):i.observerSurfaceNormal=null,y?.getIntersectionPoint(O)?i.targetSurfaceNormal=y.getTransformedNormal((0,a.vt)()):i.targetSurfaceNormal=null}function u(e,t,i){if((0,o.QS)(e)){const s=(0,o.SM)(e,t);if(null!=s)return Math.min(s*p,i)}return 1e-5*i}const p=.05,v=(0,r.vt)(),w=(0,a.vt)()},46576:(e,t,i)=>{i.d(t,{T:()=>r});var s=i(29808),a=i(3112);function r(e){const t=new s.n(e);return t.options.store=a.o.MIN,t.options.excludeLabels=!0,t}},63928:(e,t,i)=>{i.d(t,{W:()=>n});var s=i(9392),a=i(45463),r=i(48168);class n extends a.im{constructor(){super(...arguments),this._pp0=(0,s.fA)(0,0,1),this._pp1=(0,s.fA)(0,0,0)}intersect(e,t,i,s,a,n){return(0,r.Uy)(e,i,s,a,void 0,n)}intersectDraped(e,t,i,s){return this._pp0[0]=this._pp1[0]=i[0],this._pp0[1]=this._pp1[1]=i[1],(0,r.Uy)(e,t,this._pp0,this._pp1,void 0,s)}}},74050:(e,t,i)=>{i.d(t,{Dh:()=>l,IB:()=>h,Vv:()=>s,fg:()=>o,jI:()=>c});i(15941);var s,a=i(19555),r=i(72745);function n(e,t){return e[0]*t[1]-e[1]*t[0]}function o(e,t,i,s){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:i;return(0,a.Re)(u,s,i),(0,a.Re)(v,t,r),function(e,t,i){const s=(0,a.Om)(i,t)/(0,a.m3)(i);(0,a.hs)(e,i,s)}(w,v,u),(0,a.WQ)(e,r,w)}function l(e,t,i,s){(0,a.Re)(u,t,i);const r=s/(0,a.Bw)(u);return(0,a.Ln)(e,i,u,r)}function c(e,t){const i=e.start,r=e.end,o=t.start,l=t.end,c=(0,a.Re)(u,r,i),h=(0,a.Re)(p,l,o),f=n(c,h);if(Math.abs(f)<=d)return[];const _=(0,a.Re)(v,i,o),m=n(h,_)/f,g=n(c,_)/f;if(m>=0){if(g>=0||t.type===s.LINE)return[(0,a.Ln)(w,i,c,m)]}else if(e.type===s.LINE&&(g>=0||t.type===s.LINE))return[(0,a.Ln)(w,i,c,m)];return[]}function h(e,t,i){const r=[],n=(0,a.Re)(u,e.end,e.start),o=(0,a.Re)(p,e.start,t),l=(0,a.m3)(n),c=2*(0,a.Om)(n,o),h=c*c-4*l*((0,a.m3)(o)-i*i);if(0===h){const t=-c/(2*l);(e.type===s.LINE||t>=0)&&r.push((0,a.Ln)(w,e.start,n,t))}else if(h>0){const t=Math.sqrt(h),i=(-c+t)/(2*l);(e.type===s.LINE||i>=0)&&r.push((0,a.Ln)(w,e.start,n,i));const o=(-c-t)/(2*l);(e.type===s.LINE||o>=0)&&r.push((0,a.Ln)(v,e.start,n,o))}return r}!function(e){e[e.RAY=0]="RAY",e[e.LINE=1]="LINE"}(s||(s={}));const d=1e-6,u=(0,r.vt)(),p=(0,r.vt)(),v=(0,r.vt)(),w=(0,r.vt)()},93131:(e,t,i)=>{i.d(t,{Bw:()=>f,D9:()=>y,DG:()=>d,E3:()=>T,FF:()=>l,Hb:()=>r,I4:()=>b,Jj:()=>D,Ll:()=>p,NT:()=>_,Sw:()=>R,UF:()=>o,YG:()=>O,ZR:()=>v,aE:()=>C,aj:()=>S,c1:()=>h,cE:()=>c,cO:()=>w,lS:()=>u,qD:()=>m,rb:()=>g,sd:()=>A,vA:()=>M,vo:()=>n,xj:()=>V});var s=i(81806),a=i(15941);const r=(0,s.A)("mac")?"Meta":"Control",n="Shift",o=2,l=1.15,c=1.15,h=2500,d=.02,u=Math.cos((0,a.kU)(45)),p=Math.cos((0,a.kU)(5)),v=.95,w=.3,f=2,_=1,m=3,g=11,V=22.5,b=40,M=48,y=2.25,S=4,O=1,D=.3,T=6,A=4,R=1600,C=.4}}]);
//# sourceMappingURL=13750.09e3eb16.chunk.js.map