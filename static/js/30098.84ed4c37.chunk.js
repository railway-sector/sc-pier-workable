"use strict";(self.webpackChunksc_pier_workable=self.webpackChunksc_pier_workable||[]).push([[30098],{30098:(e,t,s)=>{s.r(t),s.d(t,{FeatureTileTree3D:()=>Ue});var i=s(6326),r=s(91967),n=s(19276),o=(s(81806),s(76460)),l=s(30726),a=s(68930),u=s(68134),h=s(75540),c=s(46053),d=(s(47249),s(87990)),f=s(2413),_=s(76191),p=s(20664),m=s(9392),v=s(4763),g=s(95925),y=s(34111),T=s(98510),M=s(45308),b=s(482);var S=s(13927),w=s(61985);class x{constructor(e,t){this._renderCoordsHelper=e,this.opaqueGround=t,this._cache=new Map,this._cameraForward=(0,m.vt)(),this._cameraEye=(0,m.vt)(),this._cameraFovY=55*Math.PI/180,this._frustumBoundingSphereCenter=(0,m.vt)(),this._frustumBoundingSphereRadius=0,this._frustum=new w.P(e),this._renderSR=e.spatialReference;const s=(0,T.lO)(this._renderSR);this._renderSREllipsoidRadius=(0,y.tO)(s).radius}setup(e){this._aboveGround=e.aboveGround,this._frustum.update(e),(0,p.n)(this._cameraForward,e.viewForward),(0,p.d)(this._cameraEye,e.eye),this._cameraFovY=e.fovY,this._updateFrustumBoundingSphere()}done(){this._cache.clear()}compute(e){if(this._cache.has(e.id))return this._cache.get(e.id);const t=this._isVisibleInFrustum(e);return this._cache.set(e.id,t),t}_isVisibleInFrustum(e){return 2===this._renderCoordsHelper.viewingMode?this._isTileVisibleInFrustumLocal(e):this._isTileVisibleInFrustumGlobal(e)}_updateFrustumBoundingSphere(){const e=this._frustum,t=e.origin,s=D;(0,p.n)(s,e.direction);const i=e.points,r=V;(0,p.a)(r,i[4],t);const n=.5*(0,p.f)(r,r)/(0,p.f)(s,r),o=this._frustumBoundingSphereCenter;(0,p.c)(o,t,s,n);const l=1+n;this._frustumBoundingSphereRadius=l}_isTileVisibleInFrustumLocal(e){const t=e.spatialReference,s=e.extent,i=this._renderSR;if(!s)return!0;if(k[0]=s[0],k[1]=s[1],k[2]=0,k[3]=s[2],k[4]=s[3],k[5]=0,!(0,M.projectBuffer)(k,t,0,k,i,0))return!1;(0,p.j)(B[0],k[0],k[1],0),(0,p.j)(B[1],k[3],k[1],0),(0,p.j)(B[2],k[3],k[4],0),(0,p.j)(B[3],k[0],k[4],0),(0,p.j)(P,.5*(k[0]+k[3]),.5*(k[1]+k[4]),.5*(k[2]+k[5]));const r=be,n=.5*(0,p.F)(B[0],B[2]),o=this._frustum,l=this._frustumBoundingSphereRadius,a=this._frustumBoundingSphereCenter,u=z;(0,p.a)(u,a,P);const h=(0,p.f)(r,u),c=Y;if((0,p.c)(c,P,r,h),(0,p.F)(c,a)>n+l)return!1;const d=this._cameraForward,f=(0,p.f)(d,be),_=this._cameraFovY,m=this._cameraEye;if(Math.abs(f)<Math.abs(Math.cos(.5*_))){let e=!0;const t=(0,p.j)(Se,d[0],d[1],0),s=(0,p.f)(m,t);for(let i=0;i<4;++i){const r=B[i];if((0,p.f)(r,t)-s>0){e=!1;break}}if(e)return!1}{const e=B[0],t=B[2];if(e[0]<=m[0]&&m[0]<=t[0]&&e[1]<=m[1]&&m[1]<=t[1])return!0}const v=I,g=this.opaqueGround&&this._aboveGround,y=this.opaqueGround&&!this._aboveGround,T=Math.min(y?ge:1/0,h+l),b=Math.max(g?-ge:-1/0,h-l);for(let M=0;M<4;++M)(0,p.c)(v[M],B[M],r,T),(0,p.c)(v[M+4],B[M],r,b);if(F(o.planes,v,8))return!1;if(O(o.planes,v,8))return!0;for(let p=0;p<4;++p){const e=v[p],t=v[p+4];if(we(o.planes,e,t))return!0;const s=v[(p+1)%4];if(we(o.planes,e,s))return!0;const i=v[4+(p+1)%4];if(we(o.planes,t,i))return!0}if(Ce[0][3]=+B[0][0],Ce[1][3]=-B[2][0],Ce[2][3]=+B[0][1],Ce[3][3]=-B[2][1],Ce[4][3]=+b,Ce[5][3]=-T,O(Ce,o.points))return!0;if(O(Ce,o.points))return!0;for(let p=0;p<4;++p){const e=m,t=o.points[p+4];if(xe(Ce,e,t))return!0;const s=o.points[4+(p+1)%4];if(xe(Ce,t,s))return!0}return!1}_isTileVisibleInFrustumGlobal(e){if(e.level<A)return!0;const t=e.spatialReference,s=e.extent;if(!s||!t)return!0;const i=this.opaqueGround&&this._aboveGround,r=this.opaqueGround&&!this._aboveGround,n=B,o=.5*(s[0]+s[2]);if((0,p.j)(n[0],s[0],s[1],0),(0,p.j)(n[1],s[2],s[1],0),(0,p.j)(n[2],s[2],s[3],0),(0,p.j)(n[3],s[0],s[3],0),(0,p.j)(n[4],o,s[1],0),(0,p.j)(n[5],o,s[3],0),!function(e,t,s,i,r,n){let o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1;const l=(0,b.jd)(t,r);if(null==l)return!1;if(l===b.pO){if(e===i&&s===n)return!0;const t=s+o;for(let r=s,o=n;r<t;++r,++o)(0,p.d)(i[o],e[r]);return!0}const a=s+o;for(let u=s,h=n;u<a;++u,++h)l(e[u],0,i[h],0);return!0}(n,t,0,n,this._renderSR,0,6))return!1;const l=n[0][2]>0,a=n[3][2]<0,u=l||a,h=this._renderSREllipsoidRadius;if(u){const e=H;R(e,Ee,n[0]);const t=N;if(R(t,Ee,n[1]),l){const s=q,i=n[4],r=U;R(r,i,Ee),R(s,r,i);const o=n[0];(0,p.i)(o,e,s),E(o,h);const l=n[1];(0,p.i)(l,t,s),E(l,h)}else if(a){const s=q,i=n[5],r=U;R(r,i,Ee),R(s,i,r);const o=n[3];(0,p.i)(o,s,e),E(o,h);const l=n[2];(0,p.i)(l,s,t),E(l,h)}}const c=P,d=(0,p.a)(X,n[3],n[0]);(0,p.n)(d,d);const f=(0,p.g)(ee,n[0],n[3]);(0,p.h)(f,f,.5);const _=-(0,p.f)(f,d),v=(0,p.g)(te,n[0],n[1]);(0,p.h)(v,v,.5);const g=(0,p.g)(se,n[2],n[3]);(0,p.h)(g,g,.5);const y=(0,p.a)(ie,g,v);(0,p.n)(y,y);const T=-(_+(0,p.f)(d,v))/(0,p.f)(d,y);(0,p.c)(c,v,y,T),E(c,h);const M=this._frustumBoundingSphereRadius,w=this._frustumBoundingSphereCenter,x=this._frustum,L=x.planes,j=Z;(0,p.n)(j,c);const O=(0,p.f)(n[0],j)/(0,p.H)(n[0]),I=x.origin,k=x.points;let D=!1;if(i){{D=!0;const e=(0,p.n)(ye,I);for(let t=0;t<4;++t){const s=k[4+t],i=(0,p.a)((0,m.vt)(),s,I);(0,p.n)(i,i);const r=(0,p.i)((0,m.vt)(),e,i);(0,p.n)(r,r);const n=(0,p.i)((0,m.vt)(),i,r);if((0,p.n)(n,n),(0,p.f)(I,n)>h){D=!1;break}}}if(D&&(0,p.f)(I,j)<h*O-ge)return!1;const e=(0,p.n)(ye,x.origin);if((0,p.f)(e,j)<0)return!1;{const e=(0,p.n)(Te,x.direction);if((0,p.f)(e,j)>Me)return!1}}const V=Math.sqrt(1-O*O);if(V>.9)return!0;let Y=!1;const z=(0,p.f)(j,w),ae=(0,p.H)(w);if(ae<=M&&!L.some(e=>(0,S.mN)(e,$)>0)){if(!i)return!0;Y=!0}const me=z/ae;if(!Y&&z<=0&&-z>M)return!1;const be=M/ae;if(Math.sqrt(1-me*me)*Math.sqrt(1-be*be)-be*me>V)return!1;if(!D){if(n.some(e=>x.intersectsPoint(e)))return!0;if(x.intersectsPoint(c))return!0}const Se=J;(0,p.a)(Se,w,$);const we=(0,p.f)(Se,j),xe=W;(0,p.h)(xe,j,we);const Re=(0,p.F)(xe,w),Ce=t.isWGS84,Le=e.lij,je=Ce&&Le[2]===2**Le[0]-1,Fe=Ce&&0===Le[2],Oe=Fe?fe:je?ce:ue,Ae=Fe?_e:je?de:he;if(!Y){const e=n,t=pe,s=re,i=ne,r=$;for(const n of Oe){const o=e[n];if(C(s,e[(n+1)%4],o),C(i,r,o),R(t,i,s),G(t,k,1))return!1}}let Ge=null;if(!i&&we<1.01*M){const e=2.5*M;if(Re>O*e+M)return!1;const t=Q,s=e/O;for(let i=0;i<4;++i)(0,p.h)(t[i],n[i],s/h);(0,p.j)(t[4],0,0,0),Ge=t}else{const e=(r?h+ge:we+M)/O,t=i?h-ge:(we-M)/O,s=K;for(let i=0;i<4;++i){const r=n[i];(0,p.h)(s[i],r,t/h),(0,p.h)(s[i+4],r,e/h)}Ge=s}if(F(L,Ge,Ge.length))return!1;const Ie=x.lines,ke=oe,Be=le;for(const m of Ie){(0,p.n)(Be,m.direction);for(const e of Ae){const t=Ge[e];if((0,p.n)(ke,t),ve(Be,ke,Ge,k))return!1;const s=(e+1)%4;if(i){const e=Ge[s];if((0,p.a)(ke,e,t),(0,p.n)(ke,ke),ve(Be,ke,Ge,k))return!1}if(r){const t=Ge[4+e],i=Ge[4+s];if((0,p.a)(ke,i,t),(0,p.n)(ke,ke),ve(Be,ke,Ge,k))return!1}}}return!0}}function R(e,t,s){return(0,p.i)(e,t,s),(0,p.n)(e,e),e}function C(e,t,s){return(0,p.a)(e,t,s),(0,p.n)(e,e),e}function E(e,t){return(0,p.h)(e,e,t/(0,p.H)(e)),e}const L=[0,1,2,3,5];function j(e,t,s){for(let i=0;i<s;++i)if((0,S.mN)(e,t[i])<=0)return!1;return!0}function F(e,t,s){for(const i of L)if(j(e[i],t,s))return!0;return!1}function O(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.length;for(let i=0;i<s;++i){const s=t[i];let r=!0;for(const t of e)if((0,S.mN)(t,s)>0){r=!1;break}if(r)return!0}return!1}const A=2;function G(e,t,s){for(const i of t)if((0,p.f)(i,e)<s)return!1;return!0}const I=[(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)()],k=[0,0,0,0,0,0],B=[(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)()],P=(0,m.vt)(),q=(0,m.vt)(),H=(0,m.vt)(),N=(0,m.vt)(),U=(0,m.vt)(),Z=(0,m.vt)(),W=(0,m.vt)(),D=(0,m.vt)(),V=(0,m.vt)(),Y=(0,m.vt)(),z=(0,m.vt)(),$=(0,m.CN)(0,0,0),J=(0,m.vt)(),K=[(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)()],Q=[(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)()],X=(0,m.vt)(),ee=(0,m.vt)(),te=(0,m.vt)(),se=(0,m.vt)(),ie=(0,m.vt)(),re=(0,m.vt)(),ne=(0,m.vt)(),oe=(0,m.vt)(),le=(0,m.vt)(),ae=(0,m.vt)(),ue=[0,1,2,3],he=[0,1,2,3],ce=[0,1,3],de=[0,1,3],fe=[1,2,3],_e=[1,2,3],pe=(0,m.vt)();const me=[0,0];function ve(e,t,s,i){const r=s.length,n=i.length;if(0===r||0===n)return!0;const o=ae;R(o,e,t);const l=n<r,a=l?s:i,u=me;return function(e,t,s){let i=1/0,r=-1/0;for(const n of s){const e=(0,p.f)(t,n);i=Math.min(i,e),r=Math.max(r,e)}e[0]=i,e[1]=r}(u,o,l?i:s),function(e,t,s,i){let r=1/0,n=-1/0;for(const o of i){const i=(0,p.f)(s,o);if(r=Math.min(r,i),n=Math.max(n,i),r<=t&&n>=e)return!1}return!0}(u[0],u[1],o,a)}const ge=430,ye=(0,m.vt)(),Te=(0,m.vt)(),Me=Math.cos(.25*Math.PI),be=(0,m.fA)(0,0,1),Se=(0,m.vt)();function we(e,t,s){const i={t0:0,t1:1};for(const r of L)if(!Re(e[r],t,s,i))return!1;return i.t0<i.t1}function xe(e,t,s){const i={t0:0,t1:1};for(const r of e)if(!Re(r,t,s,i))return!1;return i.t0<i.t1}function Re(e,t,s,i){let{t0:r,t1:n}=i;const o=(0,S.mN)(e,t),l=(0,S.mN)(e,s);if(o>=0&&l>=0)return!1;if(o<0&&l>=0){const e=-o/(l-o);if(e<r)return!1;e<n&&(n=e)}else if(o>=0&&l<0){const e=o/(o-l);if(e>n)return!1;e>r&&(r=e)}return i.t0=r,i.t1=n,!0}const Ce=[(0,S.fA)(-1,0,0,1),(0,S.fA)(1,0,0,-1),(0,S.fA)(0,-1,0,1),(0,S.fA)(0,1,0,-1),(0,S.fA)(0,0,-1,1),(0,S.fA)(0,0,1,-1)],Ee=(0,m.CN)(0,0,1);var Le=s(33062);class je{constructor(e,t,s){this._renderCoordsHelper=e,this._tilingScheme=t,this._camera=new Le.A,this._surfaceElevation=0,this._focusOnMap=[0,0],this._visibility=new x(e,s)}set opaqueGround(e){this._visibility.opaqueGround=e}setup(e,t,s){this._camera.copyFrom(e),this._surfaceElevation=s,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,this._visibility.setup(this._camera)}done(){this._visibility.done()}update(e){const{measures:t,extent:s,level:i}=e;s&&(t.visible=this._visibility.compute(e),t.distance=(0,f.Io)(s,this._focusOnMap),t.mergeable=!0,t.lodLevel=A,t.splitPriority=Math.max(0,A-i),t.visible&&(this._isGlobal?this._updateSplitAndLodGlobal(e):this._updateSplitAndLodLocal(e)))}_updateSplitAndLodGlobal(e){const t=e.level,s=this._renderCoordsHelper,{eye:i,fov:r}=this._camera,n=s.referenceEllipsoid.radius,o=(0,p.H)(i)-n;if(2*Math.atan(n/o)<r&&o>0)return void(e.measures.lodLevel=Math.max(t,A));const l=Fe,{extent:a}=e;if(!a)return;const{_surfaceElevation:u}=this;(0,p.j)(l[0],a[0],a[1],u),(0,p.j)(l[1],a[2],a[1],u),(0,p.j)(l[2],a[2],a[3],u),(0,p.j)(l[3],a[0],a[3],u);const h=(0,p.j)(Oe,.5*(a[0]+a[2]),.5*(a[1]+a[3]),u),c=this._tilingScheme.spatialReference;for(let p=0;p<4;++p)s.toRenderCoords(l[p],c,l[p]);s.toRenderCoords(h,c,h);const d=(0,p.n)(ke.direction,h),f=(0,p.f)(i,d),_=(0,p.h)(Ge,d,f);this._updateSplitAndLod(e,l,h,_)}_updateSplitAndLodLocal(e){const t=Fe,{extent:s}=e;if(!s)return;const{_surfaceElevation:i}=this;(0,p.j)(t[0],s[0],s[1],i),(0,p.j)(t[1],s[2],s[1],i),(0,p.j)(t[2],s[2],s[3],i),(0,p.j)(t[3],s[0],s[3],i);const r=this._tilingScheme.spatialReference;for(let h=0;h<4;++h)this._renderCoordsHelper.toRenderCoords(t[h],r,t[h]);const n=(0,p.j)(Oe,.5*(t[0][0]+t[2][0]),.5*(t[0][1]+t[2][1]),.25*(t[0][2]+t[1][2]+t[2][2]+t[3][2])),o=(0,p.j)(Ae,n[0],n[1],0),{eye:l,far:a}=this._camera,u=(0,p.j)(Ge,o[0],o[1],l[2]);(0,p.j)(ke.origin,o[0],o[1],l[2]-2*a),(0,p.d)(ke.direction,Ie),this._updateSplitAndLod(e,t,n,u)}_updateSplitAndLod(e,t,s,i){const r=Math.max((0,p.F)(t[0],t[2]),(0,p.F)(t[1],t[3]),(0,p.F)(t[0],s)+(0,p.F)(s,t[2]),(0,p.F)(t[1],s)+(0,p.F)(s,t[3])),{eye:n,near:o,fov:l,viewForward:a,width:u,height:h,pixelRatio:c,frustum:d}=this._camera,f=(0,p.f)(n,a),_=(0,p.f)(s,a)-f,m=(0,p.F)(s,n);let g=_,y=_,T=m,M=m;const b=(e,t)=>t<o?1:Math.sqrt(e*e-t*t)/t;let S=b(m,_);for(const v of t){const e=(0,p.f)(v,a)-f;g=Math.min(g,e),y=Math.max(y,e);const t=(0,p.F)(v,n);M=Math.max(M,t),T=Math.min(T,t);const s=b(t,e);S=Math.min(S,s)}if(y<o)return void(e.measures.lodLevel=0);const w=Math.cos(.5*l),x=(0,p.F)(n,i);S>w&&x>Pe*r&&(y=qe*M,g=qe*T);const R=.5*Math.sqrt(u*u+h*h)/c,C=2*Math.tan(.5*l),E=e=>Math.max(o,e)*Be/R*C,L=e.level,j=r*2**L*Math.max(1,C),F=E(g),O=Math.ceil(Math.log2(Math.max(1,j/F)));if(e.measures.lodLevel=Math.max(O,e.measures.lodLevel),e.measures.splitPriority+=e.measures.lodLevel-L,L<O){const s=+(0,v.bU)(d,t[0])+ +(0,v.bU)(d,t[1])+ +(0,v.bU)(d,t[2])+ +(0,v.bU)(d,t[3]);e.measures.splitPriority+=s}const A=E(y)/F;A>2.5&&(e.measures.splitPriority+=A)}get _isGlobal(){return 1===this._renderCoordsHelper.viewingMode}}const Fe=[(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)()],Oe=(0,m.vt)(),Ae=(0,m.vt)(),Ge=(0,m.vt)(),Ie=(0,m.CN)(0,0,1),ke=(0,g.fA)(m.uY,Ie),Be=312,Pe=.5,qe=2;var He=s(42136),Ne=s(59752);let Ue=class extends r.A{constructor(e){super(e),this.tiles=new n.A,this.tileSize=512,this._idToTile=new Map,this._dirty=(0,h.v)(!1),this._pendingTiles=(0,h.v)(null),this._newTiles=new a.A,this._tests=!1,this._measurements=new je(e.renderCoordsHelper,e.terrain.tilingScheme,this._opaqueGround)}initialize(){this.addHandles([(0,u.wB)(()=>this.tileSize,()=>this._reset(),u.pc),(0,u.wB)(()=>[this.pointsOfInterest.cameraOnSurface?.location,this.viewState?.contentCamera,this.pointsOfInterest.focus?.location,this.terrain?.baseOpacity??1],()=>this._setDirty(),u.pc),(0,u.wB)(()=>this.tilingScheme,e=>{this._reset(),this._measurements=new je(this.renderCoordsHelper,e,this._opaqueGround)},u.OH),(0,u.wB)(()=>this._opaqueGround,e=>this._measurements.opaqueGround=e,u.OH)]),this._frameWorker=this.scheduler?.registerTask(Ne.W6.FEATURE_TILE_TREE,this)}destroy(){this._frameWorker=(0,l.xt)(this._frameWorker),this._measurements=null,this._newTiles.prune()}get tilingScheme(){return this.terrain.tilingScheme?.clone()}set filterExtent(e){if(null!=e&&!e.spatialReference.equals(this.viewState.spatialReference))return void o.A.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||null!=t&&e&&t.equals(e))return;const s=null!=e?e.clone():null;this._set("filterExtent",s),this._setDirty()}get _filterExtentRect(){if(null==this.filterExtent)return null;const e=(0,f.vt)();return(0,He.k)(this.filterExtent,e,this.tilingScheme.spatialReference),e}get _rootTileIds(){const{tilingScheme:e}=this;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty.value||!!this._pendingTiles.value}get _opaqueGround(){return 1===(this.terrain?.baseOpacity??1)}_setDirty(){this.suspended||(this._frameWorker?this._dirty.value=!0:this.runTask(Ne.Bb))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(!1),this._dirty.value=!1}get readyToRun(){return this.updating}_reset(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._newTiles.clear(),this._pendingTiles.value=null,e&&this._setDirty()}_getRootTiles(){const e=this.tilingScheme;return this._rootTileIds.map(t=>new _.mS(t[0],t[1],t[2],e))}runTask(e){e=this._tests?Ne.Bb:e,this._dirty.value=!1,this._pendingTiles.value||(this._startUpdate(e),null!=this._frameWorker&&(this._frameWorker.priority=Ne.W6.FEATURE_TILE_TREE_ACTIVE)),this._splitPendingTiles(e),this._pendingTiles.value||null==this._frameWorker||(this._frameWorker.priority=Ne.W6.FEATURE_TILE_TREE)}_startUpdate(e){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();const{_measurements:t,_filterExtentRect:s,_newTiles:i}=this;t.setup(this.viewState.contentCamera,this.pointsOfInterest.focus.location,this.pointsOfInterest.cameraOnSurface.location.z??0),this._pendingTiles.value=this._getRootTiles().filter(e=>{if(t.update(e),e.measures.visible&&(!s||!e.extent||(0,f.HY)(e.extent,s))){if(e.measures.splitPriority>0)return!0;i.push(e)}return!1}).sort(Ze),this._newTiles.clear(),e.madeProgress()}_splitPendingTiles(e){const t=this._pendingTiles.value;if(!t)return;const{tilingScheme:s,_filterExtentRect:i,_newTiles:r,_measurements:n}=this;for(;t.length>0&&this._tileBudgetRatio<=2;){const o=t.pop();if(e.madeProgress(),o.measures.splitPriority>0){s.ensureMaxLod(o.level+1);const e=o.createChildren();for(const s of e)n.update(s),!s.measures.visible||i&&s.extent&&!(0,f.HY)(s.extent,i)||(s.measures.splitPriority>0?t.push(s):r.push(s));t.sort(Ze),this._mergeNewTiles(2),this._mergeNewTiles(2,!0)}else r.push(o);if(e.done)return}r.pushArray(t),this._pendingTiles.value=null,this._updateTiles(),r.clear(),n.done()}get _tileBudgetRatio(){return(this._newTiles.length+(this._pendingTiles.value?.length??0))/60}_mergeNewTiles(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._tileBudgetRatio<=e)return;const{_newTiles:s,_measurements:i}=this;s.sort((e,t)=>t.measures.distance-e.measures.distance);const r=new Map(s.map(e=>[e.id,e])),n=s.length;for(const o of r.values()){const{lij:n,measures:l}=o;if(!l.mergeable||n[1]%2!=0||n[2]%2!=0||n[0]<=1||o.lodLevelDelta>=4)continue;const a=l.lodLevel;let u=a,h=!0;const c=r.get((0,_.et)(n[0],n[1]+1,n[2]));let d=Math.abs((c?.measures.lodLevel??0)-a),f=0===d||t&&c?.measures.mergeable&&d<=1;if(!c||!f)continue;u+=c.measures.lodLevel,h&&=0===d;const p=r.get((0,_.et)(n[0],n[1],n[2]+1));if(d=Math.abs((p?.measures.lodLevel??0)-a),f=0===d||t&&p?.measures.mergeable&&d<=1,!p||!f)continue;u+=p.measures.lodLevel,h&&=0===d;const m=r.get((0,_.et)(n[0],n[1]+1,n[2]+1));if(d=Math.abs((m?.measures.lodLevel??0)-a),f=0===d||t&&m?.measures.mergeable&&d<=1,!m||!f)continue;u+=m.measures.lodLevel,h&&=0===d,s.removeUnordered(o),s.removeUnordered(c),s.removeUnordered(p),s.removeUnordered(m),r.delete(o.id),r.delete(c.id),r.delete(p.id),r.delete(m.id);const v=new _.mS(n[0]-1,n[1]/2,n[2]/2,this.tilingScheme);if(i.update(v),v.measures.visible=!0,v.measures.lodLevel=u/4,v.measures.mergeable=h,s.push(v),r.set(v.id,v),this._tileBudgetRatio<=e)return}s.length<n&&this._mergeNewTiles(e,t)}_updateTiles(){this._mergeNewTiles(1),this._mergeNewTiles(1,!0);for(const i of this.tiles.items)i.used=!1;let e=!1;const t=this._newTiles.filter(t=>{const s=this._idToTile.get(t.id);return s?(e||=s.measures.lodLevel!==t.measures.lodLevel,s.measures={...t.measures},s.used=!0):this._idToTile.set(t.id,t),!s}),s=this.tiles.items.filter(e=>!e.used&&(this._idToTile.delete(e.id),!0));this.tiles.removeMany(s),this.tiles.addMany(t),this._sortTiles(),!e||s.length||t.length||this.tiles.emit("change")}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((e,t)=>e.measures.distance-t.measures.distance),this.tiles.forEach((e,t)=>e.loadPriority=t)}};function Ze(e,t){return e.lodLevelDelta-t.lodLevelDelta||e.measures.splitPriority-t.measures.splitPriority||t.measures.distance-e.measures.distance}(0,i.Cg)([(0,c.MZ)({constructOnly:!0})],Ue.prototype,"scheduler",void 0),(0,i.Cg)([(0,c.MZ)({constructOnly:!0})],Ue.prototype,"renderCoordsHelper",void 0),(0,i.Cg)([(0,c.MZ)({constructOnly:!0})],Ue.prototype,"pointsOfInterest",void 0),(0,i.Cg)([(0,c.MZ)({constructOnly:!0})],Ue.prototype,"viewState",void 0),(0,i.Cg)([(0,c.MZ)({constructOnly:!0})],Ue.prototype,"terrain",void 0),(0,i.Cg)([(0,c.MZ)()],Ue.prototype,"tiles",void 0),(0,i.Cg)([(0,c.MZ)()],Ue.prototype,"tileSize",void 0),(0,i.Cg)([(0,c.MZ)({readOnly:!0})],Ue.prototype,"tilingScheme",null),(0,i.Cg)([(0,c.MZ)()],Ue.prototype,"filterExtent",null),(0,i.Cg)([(0,c.MZ)({readOnly:!0})],Ue.prototype,"_filterExtentRect",null),(0,i.Cg)([(0,c.MZ)({readOnly:!0})],Ue.prototype,"_rootTileIds",null),(0,i.Cg)([(0,c.MZ)({value:!1})],Ue.prototype,"suspended",null),(0,i.Cg)([(0,c.MZ)({readOnly:!0})],Ue.prototype,"updating",null),Ue=(0,i.Cg)([(0,d.$)("esri.views.3d.layers.support.FeatureTileTree3D")],Ue)},76191:(e,t,s)=>{s.d(t,{Tb:()=>n,et:()=>u,mS:()=>l,nx:()=>o});var i=s(34111),r=s(2413);const n="virtual-snapshot-tile",o="virtual-display-filter-highlight-tile";class l{constructor(e,t,s,i){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:u(e,t,s);this._tilingScheme=i,this.id=n,this.lij=[0,0,0],this.extent=null,this.measures=new a,this.loadPriority=0,this.used=!1,this.lij[0]=this.measures.lodLevel=e,this.lij[1]=t,this.lij[2]=s,i&&(this.extent=(0,r.vt)(),i?.getExtent(e,t,s,this.extent))}get planetRadius(){return(0,i.tO)(this.spatialReference).radius}get spatialReference(){return this._tilingScheme?.spatialReference}get resolution(){return this._tilingScheme?.resolutionAtLevel(this.measures.lodLevel)??0}get level(){return this.lij[0]}get lodLevelDelta(){return this.measures.lodLevel-this.level}createChildren(){const e=this.lij[0]+1,t=2*this.lij[1],s=2*this.lij[2];return[new l(e,t,s,this._tilingScheme),new l(e,t+1,s,this._tilingScheme),new l(e,t,s+1,this._tilingScheme),new l(e,t+1,s+1,this._tilingScheme)]}}class a{constructor(){this.visible=!0,this.distance=0,this.lodLevel=0,this.splitPriority=0,this.mergeable=!0}}function u(e,t,s){return`${e}/${t}/${s}`}}}]);
//# sourceMappingURL=30098.84ed4c37.chunk.js.map