"use strict";(self.webpackChunksc_pier_workable=self.webpackChunksc_pier_workable||[]).push([[87081],{657:(e,t,i)=>{i.d(t,{Y:()=>r});var s=i(30726),n=i(50346);class r{constructor(e,t){this._textures=e,this.loadPromise=null,this._disposed=!1;const i=this._textures.acquire(t);(0,n.$X)(i)?(i.then(e=>{this._disposed?(0,s.Gz)(e):this._textureRef=e}),this.loadPromise=i):this._textureRef=i}dispose(){this._textureRef=(0,s.Gz)(this._textureRef),this._disposed=!0}get glTexture(){return this._textureRef?.glTexture}}},10231:(e,t,i)=>{i.d(t,{i:()=>s});class s{constructor(e,t,i,s,n){this.toMapSpace=e,this.transform=t,this.obb=i,this.geometry=s,this.elevationAlignable=n}}},14303:(e,t,i)=>{i.d(t,{A:()=>g});var s,n=i(6326),r=i(42553),o=i(53084),a=i(62754),l=i(46053),c=(i(81806),i(76460),i(87990)),h=i(17707),d=i(37546),u=i(65215),p=i(56611);let g=s=class extends r.o{constructor(e){super(e),this.geometry=null,this.type="clip"}writeGeometry(e,t,i,s){if(s.layer?.spatialReference&&!s.layer.spatialReference.equals(this.geometry.spatialReference)){if(!(0,p.canProjectWithoutEngine)(e.spatialReference,s.layer.spatialReference))return void(s?.messages&&s.messages.push(new a.A("scenemodification:unsupported","Scene modifications with incompatible spatial references are not supported",{modification:this,spatialReference:s.layer.spatialReference,context:s})));const n=new u.A;(0,p.projectPolygon)(e,n,s.layer.spatialReference),t[i]=n.toJSON(s)}else t[i]=e.toJSON(s)}clone(){return new s({geometry:(0,o.o8)(this.geometry),type:this.type})}};(0,n.Cg)([(0,l.MZ)({type:u.A}),(0,d.P)()],g.prototype,"geometry",void 0),(0,n.Cg)([(0,h.K)(["web-scene","portal-item"],"geometry")],g.prototype,"writeGeometry",null),(0,n.Cg)([(0,l.MZ)({type:["clip","mask","replace"],nonNullable:!0}),(0,d.P)()],g.prototype,"type",void 0),g=s=(0,n.Cg)([(0,c.$)("esri.layers.support.SceneModification")],g)},21479:(e,t,i)=>{i.d(t,{f:()=>a});var s=i(20664),n=i(482),r=i(14556),o=i(80963);function a(e,t,i,a){const l=(0,n.Tp)(t,a);if(null==l)return!1;const c=l.source.spatialReferenceId,h=l.dest.spatialReferenceId;if(c===h&&0!==c||(0,o.aI)(t,a))return i[0]=1,i[1]=1,i[2]=1,!0;if(1===c){const t=(0,s.b)(e),o=t/Math.sqrt(e[0]*e[0]+e[1]*e[1]),a=t/r.$O.radius;if(3===h)return i[0]=o*a,i[1]=o*a,i[2]=1,!0;if(2===h||5===h){const e=n.iE;return i[0]=e*o*a,i[1]=e*a,i[2]=1,!0}}else if(11===c){if(2===h||5===h)return i[0]=n.iE,i[1]=n.iE,i[2]=1,!0;if(3===h){const t=e[1]/r.$O.radius;return i[0]=1,i[1]=1/Math.cos(t),i[2]=1,!0}}return!1}},35493:(e,t,i)=>{i.d(t,{e:()=>b});var s=i(6326),n=i(54099),r=i(76460),o=i(46053),a=(i(81806),i(47249),i(87990)),l=i(34761),c=i(13191),h=i(20664),d=i(9392),u=i(79115),p=i(2413),g=i(78315),m=i(95225),f=i(89801),y=i(96342);let b=class extends n.nJ{constructor(e){super(e),this._tmpEvent=new f.p,this._renderCoordsHelper=e.view.renderCoordsHelper,this._renderSR=this._renderCoordsHelper.spatialReference,this._layerElevationSource=e.layerElevationSource}initialize(){this._intersector=new y.n(this.view.state.viewingMode),this._intersector.options.store=0,this._intersector.options.normalRequired=!1,this._tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}get spatialReference(){return this.view?.elevationProvider?.spatialReference}getElevation(e,t,i,s){const n=this._renderCoordsHelper,o=(0,h.j)(w,e,t,i);if(!n.toRenderCoords(o,s,o))return r.A.getLogger(this).error("could not project point to compute elevation"),null;const{layerElevationSource:a,_intersector:l,intersectionHandler:c}=this,d=a.fullExtent,u=null!=d&&Number.isFinite(d.xmin)&&Number.isFinite(d.xmax)&&Number.isFinite(d.ymin)&&Number.isFinite(d.ymax)&&Number.isFinite(d.zmin)&&Number.isFinite(d.zmax)?new m.H(d.zmin,d.zmax):a.elevationRange;if(null==u)return null;const p=a.elevationOffset,g=u.elevationRangeMin+p,f=u.elevationRangeMax+p,y=n.setAltitude(C,f,o),b=n.setAltitude(x,g,o);return l.reset(y,b,this.view.state.camera),c.intersect(l,null,y,b,null,!0),l.results.min.getIntersectionPoint(o)?n.getAltitude(o):null}getSphereElevationBounds(e,t){return(0,u.z)(e,t,_,this._renderSR),this._layerElevationSource.getElevationRange(_)}getRootElevationBounds(){const e=this.layerElevationSource.fullExtent;return e?.hasZ?new m.H(e.zmin,e.zmax):null}notifyObjectsChanged(e){this.spatialReference&&(this._computeLayerExtent(t=>{for(const i of e)t(i)},this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}notifyObjectsChangedFunctional(e){this.spatialReference&&(this._computeLayerExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}notifyObjectChanged(e){this.spatialReference&&(this._computeObjectExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}_computeObjectExtent(e,t){(0,p.Ie)(t),this._expandExtent(e,t)}_computeLayerExtent(e,t){(0,p.Ie)(t),e(e=>{this._expandExtent(e,t)})}_expandExtent(e,t){const i=this.spatialReference;if(null==i)return;if(null==e)return;(0,l.I0)(v,e.quaternion),v[12]=e.center[0],v[13]=e.center[1],v[14]=e.center[2];const s=e.halfSize;for(let n=0;n<8;++n)w[0]=1&n?s[0]:-s[0],w[1]=2&n?s[1]:-s[1],w[2]=4&n?s[2]:-s[2],(0,h.t)(w,w,v),this._renderCoordsHelper.fromRenderCoords(w,w,i),(0,p.fT)(t,w,t)}};(0,s.Cg)([(0,o.MZ)({constructOnly:!0})],b.prototype,"layerElevationSource",void 0),(0,s.Cg)([(0,o.MZ)({constructOnly:!0})],b.prototype,"intersectionHandler",void 0),(0,s.Cg)([(0,o.MZ)({constructOnly:!0})],b.prototype,"view",void 0),(0,s.Cg)([(0,o.MZ)()],b.prototype,"spatialReference",null),b=(0,s.Cg)([(0,a.$)("esri.views.3d.layers.i3s.LayerElevationProvider")],b);const v=(0,c.vt)(),_=(0,g.f)(0,0,0,0),w=(0,d.vt)(),C=(0,d.vt)(),x=(0,d.vt)()},55002:(e,t,i)=>{i.d(t,{d:()=>s});class s{constructor(e,t){this.position=e,this.rotationScale=t,this.origin=void 0}}},79115:(e,t,i)=>{i.d(t,{z:()=>l});var s=i(15941),n=i(9392),r=i(482),o=i(14556),a=i(78315);function l(e,t,i,s){if(null==t||null==s)return!1;const n=(0,r.Tp)(t,s);if(null==n?.projector)return!1;if(n.projector===r.pO)return e!==i&&(i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3]),!0;const{source:l,dest:u,projector:p}=n;if(3===u.spatialReferenceId){const t=r.w5[l.spatialReferenceId][2];if(null==t)return!1;t((0,a.a)(e),0,h,0),(0,r.s7)(h,0,d,0);const s=c(h[1],e[2],e[3],o.$O.radius);return(0,a.e)(i,d,s),!0}if(2!==l.spatialReferenceId&&5!==l.spatialReferenceId||11!==u.spatialReferenceId){p((0,a.a)(e),0,d,0);const t=l.metersPerUnit??1,s=u.metersPerUnit??1,n=e[3]*t/s;(0,a.e)(i,d,n)}else{const t=r.w5[l.spatialReferenceId][1],s=r.w5[1][11];let n=e[3];null!=t&&null!=s&&(n=c(e[1],e[2],e[3],o.$O.radius)),p((0,a.a)(e),0,d,0),(0,a.e)(i,d,n)}return!0}function c(e,t,i,s){const n=s+t;if(n<s/2||i>n)return Number.MAX_VALUE;const r=Math.abs(u*e)+Math.asin(i/n);return r>=Math.PI/2?Number.MAX_VALUE:i/Math.cos(r)}const h=(0,n.vt)(),d=(0,n.vt)(),u=(0,s.kU)(1)},81148:(e,t,i)=>{i.d(t,{V:()=>n});var s=i(80963);function n(e){return e&&(0,s.q8)(e)?2:e&&(0,s.KQ)(e)?3:1}},83491:(e,t,i)=>{i.d(t,{w:()=>h});var s=i(6326),n=i(54901),r=i(50346),o=i(68134),a=i(46053),l=(i(81806),i(76460),i(47249),i(87990)),c=i(47700);const h=e=>{const t=e;let i=class extends t{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(){super.postscript(),(0,c.jI)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const e=new AbortController,t=e.signal;this.addHandles((0,n.hA)(()=>e.abort())),await(0,o.C_)(()=>this.view.defaultsFromMap?.heightModelInfoReady,t),(0,r.Te)(t);const i=(0,c.Hu)(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(i)throw i}};return(0,s.Cg)([(0,a.MZ)()],i.prototype,"view",void 0),(0,s.Cg)([(0,a.MZ)()],i.prototype,"slicePlaneEnabled",void 0),i=(0,s.Cg)([(0,l.$)("esri.views.3d.layers.LayerView3D")],i),i}},87081:(e,t,i)=>{i.r(t),i.d(t,{default:()=>ce});var s=i(6326),n=i(81806),r=i(76460),o=i(30726),a=i(68134),l=i(52394),c=i(46053),h=(i(47249),i(87990)),d=i(86300),u=i(44680),p=i(13191),g=i(4336),m=i(20664),f=i(9392),y=i(55855),b=i(34111),v=i(5809),_=i(21479),w=i(14487),C=i(2413),x=i(88105),M=i(14303),O=i(12482),R=i(97048),E=i(83491),T=i(65768);class S extends T.P{constructor(e,t,i,s,n,r,o){super(e,0,0,0,t),this.nodesCached=i,this.vboMB=s,this.textureMB=n,this.vboMBCached=r,this.textureMBCached=o}}var A=i(75228),P=i(35493),H=i(93345);const j={Points:null,Lines:null,LineStrip:null,Triangles:H.WR.TRIANGLES,TriangleStrip:H.WR.TRIANGLE_STRIP,NotSet:null},I={Opaque:1,Mask:2,Blend:0},U={Back:2,Front:1,None:0,NotSet:2},F={WrapYBit:{s:33071,t:10497},WrapXBit:{s:10497,t:33071},WrapXy:{s:10497,t:10497},None:{s:33071,t:33071},NotSet:{s:33071,t:33071}},V={U8:1,I8:1,U16:2,I16:2,U32:4,I32:4,F32:4,F64:8,Utf8String:1,NotSet:1};var k=i(45270),B=i(82805),L=i(48168);class N{constructor(e){this.layerView=e,this.type=8,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerViewUid=e.uid}intersect(e,t,i,s,n,r){if(e.options.filteredLayerViewUids.includes(this.layerView.uid))return;const{results:o,tolerance:a}=e,l=2===e.options.store,{componentObjectCollection:c}=this.layerView.view.stage.renderView,h=new L.JG(a,r,e.options.normalRequired),d=(0,L.OO)(i,s,Z),u=(0,m.a)((0,f.vt)(),s,i),p=(0,m.n)((0,f.vt)(),u),g=(n,r,a)=>{if(r>=0){if(null!=t&&!t(i,s,r))return;const n=e=>{const t=new k.kV(this.layerView.layer.uid);e.set(this.type,t,r,a)};if(this.isGround&&(null==o.ground.distance||r<o.ground.distance)&&n(o.ground),e.options.isFiltered)return;if((null==o.min.distance||r<o.min.distance)&&n(o.min),(null==o.max.distance||r>o.max.distance)&&n(o.max),l){const t=new B.i(e.ray);n(t),e.results.all.push(t)}}};this.layerView.forEachVisibleTile(e=>{if(!e.boundingVolumeIntersectsRay(i,p))return;const{componentObjects:t}=e;for(const n of t)(0,L.Wb)(n.aabbInWorldCoordinates,i,d,0)&&c.intersect(n,i,s,null,h,g)})}}const Z=(0,f.vt)();var z=i(95225),D=i(42136),G=i(59231),$=i(10231),W=i(16449),q=i(55002),J=i(657),X=i(81148),K=i(50468),Q=i(25672),Y=i(96897),ee=i(52757),te=i(91196),ie=i(90992),se=i(79196),ne=i(75569);class re{constructor(e,t,i,s,n,r,o){this.handle=e,this.componentObjects=t,this.textures=i,this.cpuMemoryUsage=s,this.vboMemoryUsage=n,this.textureMemoryUsage=r,this.obb=o,this.isVisible=!1,this.usedMemory=this.textureMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage;const a=(0,f.vt)();o?.getCenter(a),this._obbCenter=a,this._obbRadiusSquared=o?o?.radius**2:0}boundingVolumeIntersectsRay(e,t){if(!this.obb)return!0;const i=(0,m.a)(oe,this._obbCenter,e),s=(0,m.f)(i,t);return(0,m.f)(i,i)-s*s<=this._obbRadiusSquared&&this.obb.intersectRay(e,t)}}const oe=(0,f.vt)();function ae(e){return Math.round(e/1048.576)/1e3}let le=class extends((0,E.w)(te.A)){get hasModifications(){return this._modifications&&this._modifications.length>0}constructor(e){super(e),this.type="integrated-mesh-3dtiles",this._compressionTracker=new se.c,this._modifications=new Array,this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this._usedMemory=0,this._cacheMemory=0,this.drapeTargetType=1,this._applySSAO=!(0,n.A)("disable-feature:im-ssao"),this._shadeNormals=!!(0,n.A)("enable-feature:im-shading"),this._lyrHandleToObjects=new Map,this._visibleObjects=new Set,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set,this._memCache=e.view.resourceController.memoryController.newCache(`IM3DTiles-${this.uid}`,e=>this._deletePerObjectData(e))}initialize(){this._dbgFlags.add(3),this._dbg(2,"Tiles3DLayerView3D initialize() called");const{view:e}=this;if(this._updatingHandles.add(()=>this.layer.modifications,()=>this._loadModifications(),a.Vh),!this._canProjectWithoutEngine())throw(0,ie.lQ)("layer",this.layer.spatialReference.wkid,e.renderSpatialReference?.wkid);const t=(0,A.Bk)(this).then(t=>{this._wasmLayerId=t,this._intersectionHandler=new N(this),e.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add(()=>this.slicePlaneEnabled,e=>this._slicePlaneEnabledChange(e)),this._updatingHandles.add(()=>this._modifications,()=>this._modificationsChanged(),a.Vh),this._updatingHandles.add(()=>this.fullOpacity,()=>this._opacityChange()),this._updatingHandles.add(()=>e.clippingArea,()=>this._clippingAreaChanged(),a.Vh),this._elevationProvider=new P.e({view:e,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),e.elevationProvider.register(1,this._elevationProvider),e.overlayManager.registerDrapeTarget(this),this.addHandles([(0,a.wB)(()=>this.layer.elevationInfo,e=>this._elevationInfoChanged(e))]),this._suspendedHandle=(0,a.wB)(()=>this.suspended,e=>this._wasm?.setEnabled(this,!e),a.Vh)});this.addResolvingPromise(t),this._replacesTerrain&&this.addHandles((0,a.z7)(()=>this.view.map.ground.opacity,()=>{this._opacityChange()}))}get _replacesTerrain(){return this.layer.replacesTerrain&&!!this.view.map.basemap?.groundLayers.includes(this.layer)}get fullOpacity(){return this._replacesTerrain?this.view.map.ground.opacity:1}get opacity(){return 1}_opacityChange(){const{fullOpacity:e}=this;this.forEachComponentObject(t=>{this._collection.getMaterial(t).objectOpacity=e})}intersect(e,t,i,s){this._intersectionHandler.intersect(e,t,i,s,null,!1)}get ready(){return!0}destroy(){this._dbg(2,"Tiles3DLayerView3D destroy() called"),(0,A.r8)(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.notifyObjectsChangedFunctional(e=>this.forEachComponentObject(t=>e(t.obb))),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach(e=>this.freeObject(e)),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._visibleObjects.clear(),this._usedMemory=0,this._cacheMemory=0,this._memCache.destroy(),this._updatingHandles=(0,o.pR)(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_modificationsChanged(){const e=this.layer.spatialReference,t=(0,R.Ir)(this._layerClippingArea,this._modifications,e);this._wasm?.setMeshModifications(this,t,e.wkid)}_clippingAreaChanged(){const e=this.layer.spatialReference,t=(0,C.vt)();this._layerClippingArea=(0,D.k)(this.view.clippingArea,t,e)?t:null,this._modificationsChanged()}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle??=(0,l._)(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null})}_slicePlaneEnabledChange(e){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=e),this.forEachComponentObject(t=>{const i=this._collection.getMaterial(t);i.commonMaterialParameters.hasSlicePlane=e,i.commonMaterialParameters.cullFace=e?0:this._initialCullFace.get(t)})}_elevationInfoChanged(e){this._wasm?.setLayerOffset(this,(0,O.M7)(e))}get _wasm(){return(0,A.pw)(this.view)}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){return this._usedMemory}get unloadedMemory(){return 0}get cachedMemory(){return this._cacheMemory}get visibleAtCurrentScale(){return(0,ie.E5)(this.layer.effectiveScaleRange,this.view.scale)}get performanceInfo(){let e=0,t=0,i=0,s=0,n=0,r=0;return this._lyrHandleToObjects.forEach(o=>{o.isVisible?(e+=o.textureMemoryUsage,t+=o.vboMemoryUsage,n++):(i+=o.textureMemoryUsage,s+=o.vboMemoryUsage,r++)}),new S(this.usedMemory,n,r,ae(t),ae(e),ae(s),ae(i))}_canProjectWithoutEngine(){if(2===this.view.state.viewingMode){const e=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??-1;if(3857!==e&&32662!==e)return!1}return!0}get _stage(){return this.view.stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationProvider(){return this._elevationProvider}get elevationOffset(){return(0,O.M7)(this.layer.elevationInfo)}get elevationRange(){const e=this.fullExtent;return e?.zmin&&e?.zmax?new z.H(e.zmin,e.zmax):null}getElevationRange(e){return null}get fullExtent(){return this.layer.fullExtent}forEachComponentObject(e){this._forEachObject(this._lyrHandleToObjects.values(),e)}forEachVisibleTile(e){for(const t of this._visibleObjects)e(t)}forEachVisibleComponentObject(e){this._forEachObject(this._visibleObjects,e)}_forEachObject(e,t){for(const i of e)for(const e of i.componentObjects)t(e)}isUpdating(){const e=this._wasm;return!(this._wasmLayerId<0||null==e)&&(e.isUpdating(this._wasmLayerId)||this._compressionTracker.compressing)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(e){const t=e.meshData;if(null==t.data)throw new Error("meshData.data undefined");if(t.desc=JSON.parse(t.desc),null==t.desc)throw new Error("meshData.desc undefined");const i=(0,f.ci)(t.desc.origin),s=new Array,n=this.view.basemapTerrain.spatialReference;let r,o;if("global"===this.view.viewingMode){const e=(0,p.vt)();(0,v.l)(b.fv,i,e,n),r=(0,d.z0)((0,u.vt)(),e),o=(0,d.B8)((0,u.vt)(),r)}else r=u.zK,o=u.zK;const a=(0,f.o8)(i),l=(0,f.vt)(),c=function(e){return e?new G.ab(e.center,e.halfSize,(0,g.fA)(...e.quaternion)):null}(t.desc.obb);let h=0,C=0;const M={textureMemoryUsage:0},O=new Array,R=new Map,E=t.desc.prims.length;for(let d=0;d<E;d++){const e=t.desc.prims[d];if(this._dbg(2,JSON.stringify(e)),null==j[e.ptype]||null==t.data){this._dbg(2,"[Unsupported Feature] Unsupported primitive mode ("+e.ptype+"). Skipping primitive.");continue}const p=t.desc?.materials&&null!=e.materialId?t.desc.materials[e.materialId]:null,g=null!=p?p.lightingModel:"Unlit",{positionView:b,positionAttr:v,normalsView:E,normalsAttr:T,colorAttr:S,texCoord0Attr:A,indicesView:P}=this.getBufferViews(e,t.data.buffer,r);if(null==v||null==b||null==P)continue;const H=new W.$3(null!=S,A?1:0,null!=E,this._shadeNormals||this._replacesTerrain,this._applySSAO),F=v.data.length/v.size,V=(e,t)=>!e||e.data.length/e.size===F||(this._dbg(3,`${t} !== numPos. Skipping primitive.`),!1);if(!V(A,"numTexcoord")||!V(S,"numColors")||!V(T,"normals"))continue;const k=(0,W.hH)(H),B=c?.clone()??de(v,i);if(r!==u.zK)for(let t=0;t<b.count;t++)b.getVec(t,l),(0,m.o)(l,l,r),b.setVec(t,l);const L=k.createBuffer(v.data.length);if((0,ee.Ap)("position",v,null,null,L,0),null!=A){const e=L.getField("uv0",x.gH);(0,ee.Ue)(A,e,0)}null!=S&&(0,ee.Ap)("color",S,null,null,L,0),null!=T&&(0,ee.Ap)("normalCompressed",T,null,null,L,0);const N=new Uint32Array([0,P.typedBuffer.length]),Z=new W.s5({data:L.buffer,count:L.byteLength/k.stride,layoutParameters:H},{positions:b.typedBuffer,indices:P.typedBuffer},P.typedBuffer,N);h+=b.count+P.count;const z=this.view.renderSpatialReference,D=(0,f.vt)(),G=[1,1,1];(0,_.f)(a,z,G,n)||this._dbg(3,"Unsupported coordinate system for IM overlay"),(0,w.F)(a,z,D,n);const J=this._collection.createObject(new $.i((0,y.fA)(D[0],D[1],G[0],G[1]),new q.d(a,o),B,Z,!1));if(p){const e=e=>{e.baseColor=p.baseColorFactor,e.usePBR="Pbr"===g,e.hasParametersFromSource=!1,e.baseColorTexture=this._getTexture(p.baseColorTex,t,R,M),e.usePBR&&(e.mrrFactors=[p.metallicFactor,p.roughnessFactor,0],e.emissiveBaseColor=p.emissiveFactor??[0,0,0],e.metallicRoughnessTexture=this._getTexture(p.metalTex,t,R,M),e.emissionTexture=this._getTexture(p.emissiveTex,t,R,M),e.occlusionTexture=this._getTexture(p.occlusionTex,t,R,M),e.normalTexture=this._getTexture(p.normalTex,t,R,M)),e.objectOpacity=0,e.alphaDiscardMode=2;const i=[];e.baseColorTexture&&i.push(e.baseColorTexture.loadPromise),e.usePBR&&(e.metallicRoughnessTexture&&i.push(e.metallicRoughnessTexture.loadPromise),e.emissionTexture&&i.push(e.emissionTexture.loadPromise),e.occlusionTexture&&i.push(e.occlusionTexture.loadPromise),e.normalTexture&&i.push(e.normalTexture.loadPromise));const n=Promise.all(i);s.push(n),n.then(()=>{e.alphaDiscardMode=I[p.alphaMode],e.objectOpacity=this.fullOpacity,M.textureMemoryUsage+=e.baseColorTexture?.glTexture?.usedMemory??0,e.usePBR&&(M.textureMemoryUsage+=(e.metallicRoughnessTexture?.glTexture?.usedMemory??0)+(e.emissionTexture?.glTexture?.usedMemory??0)+(e.occlusionTexture?.glTexture?.usedMemory??0)+(e.normalTexture?.glTexture?.usedMemory??0))}),e.commonMaterialParameters.doubleSided=p.isDoubleSided,e.commonMaterialParameters.cullFace=p.faceCulling?U[p.faceCulling]:0,this._initialCullFace.set(J,e.commonMaterialParameters.cullFace),e.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,e.componentParameters.castShadows=0,e.textureAlphaCutoff=p.alphaCutoff??ne.Q,e.alphaDiscardMode=I[p.alphaMode],e.isIntegratedMesh=!0,e.sphereDepthInterpolate=this.layer.hasGoogleUrl,e.polygonOffsetEnabled=!1,e.hasOccludees=!1,e.ellipsoidMode=(0,X.V)(this.view.spatialReference)};this._collection.updateMaterial(J,e)}O.push(J),C+=this._collection.getObjectGPUMemoryUsage(J)}await Promise.all(s);const T=new Array;R.forEach(e=>{T.push(e)});const S=new re(e.handle,O,T,h,C,M.textureMemoryUsage,c);return this._memCache.put(`${S.handle}`,S),this._lyrHandleToObjects.set(e.handle,S),this._cacheMemory+=S.usedMemory,{memUsageBytes:S.usedMemory}}freeRenderable(e){const t=this._lyrHandleToObjects.get(e);t&&(t.isVisible?(this._visibleObjects.delete(t),this._usedMemory-=t.usedMemory):this._cacheMemory-=t.usedMemory,this.freeObject(t),this._lyrHandleToObjects.delete(e))}freeObject(e){this._memCache.pop(`${e.handle}`),e.textures.forEach(e=>this._stage.removeTexture(e)),e.componentObjects.forEach(e=>{this._collection.destroyObject(e),this._initialCullFace.delete(e)})}setRenderableVisibility(e,t,i){for(let s=0;s<i;++s){const i=t[s];if(!i)continue;const n=e[s],r=this._lyrHandleToObjects.get(n);if(r){if(r.isVisible)continue;this._visibleGeometryChanged(),r.isVisible=!0,this._visibleObjects.add(r),this._usedMemory+=r.usedMemory,this._cacheMemory-=r.usedMemory,r.componentObjects.forEach(e=>{this._collection.setObjectVisibility(e,i),this._elevationProvider.notifyObjectChanged(this._collection.getComponentObb(e))}),this._memCache.pop(`${n}`)}}for(let s=0;s<i;++s){const i=e[s],n=t[s];if(n)continue;const r=this._lyrHandleToObjects.get(i);if(r){if(!r.isVisible)continue;this._visibleGeometryChanged(),r.isVisible=!1,this._visibleObjects.delete(r),this._usedMemory-=r.usedMemory,this._cacheMemory+=r.usedMemory,r.componentObjects.forEach(e=>{this._collection.setObjectVisibility(e,n),this._elevationProvider.notifyObjectChanged(this._collection.getComponentObb(e))}),this._memCache.put(`${i}`,r)}}}_getTexture(e,t,i,s){let r=null;if(e&&t.desc?.images&&t.data?.buffer){const o=t.desc.images[e?.imageId];if(r=i.get(o),!r&&o){const a=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,l=!!o.mipCount||a>1,c=F[e.wrapMode??"None"];let h=o.alpha?6408:6407;const d=new Uint8Array(t.data.buffer,o.data.byteOffset,o.data.byteCount);let u=null,p=null,g=null;switch(o.format){case"Raw":"R8"===o.pixelFormat?(u=d,h=6403,p=""):"Rgb8"===o.pixelFormat?(u=d,h=6407,p=""):"Rgba8"===o.pixelFormat&&(u=d,h=6408,p="");break;case"Dxt1":u=d,h=6407,p="image/vnd-ms.dds";break;case"Dxt5":u=d,h=6408,p="image/vnd-ms.dds";break;case"Basis":u=d,h=6407,p="image/ktx2";break;case"Png":p="image/png",g=document.createElement("img");break;case"Jpeg":p="image/jpeg",g=document.createElement("img");break;case"Etc2":p="image/ktx",g=document.createElement("img");break;case"Astc":this._dbg(3,"Astc texture not supported");break;case"Pvrtc":this._dbg(3,"Pvrtc texture not supported")}if(g&&p){const e=new Blob([d],{type:p});g.src=URL.createObjectURL(e),u=g}if(u&&null!=p){const e=(0,n.A)("enable-feature:esri-compress-IM-textures")?{compressionTracker:this._compressionTracker,compressionCallback:e=>{e&&e>0&&(s.textureMemoryUsage-=e)}}:void 0;r=new Y.g(u,{mipmap:l,maxAnisotropy:a,encoding:p,wrap:c,pixelFormat:h,compressionOptions:e,noUnpackFlip:!0,width:o.mip0Width,height:o.mip0Height}),this._stage.addTexture(r),i.set(o,r)}}}return r?new J.Y(this.view.stage.renderView.textures,r.id):null}getBufferViews(e,t,i){let s,n,r,o,a,l,c,h=null;for(let u=0;u<e.atrbs.length;u++){const c=e.atrbs[u],p=c.view,g=void 0,m=p.byteOffset+p.byteCount,f=p.byteCount/V[p.type],y=[...Array(f).keys()].map(e=>e);try{switch(c.sem){case"Position":3!==p.ncomp||"F32"!==p.type?this._dbg(3,"[Unsupported Feature] Unsupported view for Position ("+p+")"):(s=new x.xs(t,p.byteOffset,g,m),n=new K.n(s.typedBuffer,y,3));break;case"Normal":if(3!==p.ncomp||"F32"!==p.type)this._dbg(3,"[Unsupported Feature] Unsupported view for Normal ("+p+")");else{const e=new x.xs(t,p.byteOffset,g,m),s=(0,Q._l)(e.typedBuffer,i);a=new x.Qt(s.buffer),l=new K.n(a.typedBuffer,y,2)}break;case"TexCoord":2!==p.ncomp||"F32"!==p.type?this._dbg(3,"[Unsupported Feature] Unsupported view for Texcoord ("+p+")"):void 0===o&&(o=new K.n(new x.gH(t,p.byteOffset,g,m).typedBuffer,y,2));break;case"Color":4===p.ncomp?("F32"===p.type&&(h=new x.Eq(t,p.byteOffset,g,m)),"U8"===p.type&&(h=new x.XP(t,p.byteOffset,g,m)),"U16"===p.type&&(h=new x.Uz(t,p.byteOffset,g,m))):3===p.ncomp&&("F32"===p.type&&(h=new x.xs(t,p.byteOffset,g,m)),"U8"===p.type&&(h=new x.eI(t,p.byteOffset,g,m)),"U16"===p.type&&(h=new x.nS(t,p.byteOffset,g,m))),null==h?this._dbg(2,"[Unsupported Feature] Unsupported view for Color ("+p+")"):r=new K.n(h.typedBuffer,y,p.ncomp);break;case"FeatureIndex":break;default:this._dbg(2,"[Unsupported Feature] Unsupported semantic ("+c.sem+"). Skipping vertex attribute.")}}catch(d){this._dbg(2,"Error Creating buffer ("+d+"). Skipping vertex attribute.")}}if(e.index){const i=e.index.view,s=void 0,n=i.byteOffset+i.byteCount;switch(e.index.view.type){case"U16":c=new x.h(t,i.byteOffset,s,n);break;case"U32":c=new x.P(t,i.byteOffset,s,n);break;default:this._dbg(3,"[Unsupported Feature] index type not supported ("+i.type+").")}}if(null==c&&null!=s){const e=s.count;if(e<65535){const t=new Uint16Array(e);c=new x.h(t.buffer)}else{const t=new Uint32Array(e);c=new x.P(t.buffer)}for(let t=0;t<e;t++)c.set(t,t)}return{positionView:s,positionAttr:n,colorAttr:r,texCoord0Attr:o,indicesView:c,normalsView:a,normalsAttr:l}}_loadModifications(){if(this.removeHandles("modifications"),null==this.layer.modifications)return void(this._modifications=[]);const e=this.layer.modifications;this.addHandles(this._updatingHandles.addOnCollectionChange(()=>e,()=>this._modifications=e.toArray(),a.Vh),"modifications")}_deletePerObjectData(e){this._wasm?.onRenderableEvicted(this,e.handle,e.usedMemory),this.freeRenderable(e.handle)}_dbg(e,t){this._dbgFlags.has(e)&&(3===e?r.A.getLogger(this).error(t):r.A.getLogger(this).warn(t))}};(0,s.Cg)([(0,c.MZ)()],le.prototype,"fullOpacity",null),(0,s.Cg)([(0,c.MZ)({type:[M.A]})],le.prototype,"_modifications",void 0),(0,s.Cg)([(0,c.MZ)()],le.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),(0,s.Cg)([(0,c.MZ)()],le.prototype,"layer",void 0),(0,s.Cg)([(0,c.MZ)({readOnly:!0})],le.prototype,"visibleAtCurrentScale",null),(0,s.Cg)([(0,c.MZ)()],le.prototype,"elevationOffset",null),le=(0,s.Cg)([(0,h.$)("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],le);const ce=le,he=(0,f.vt)();function de(e,t){const i=(0,G.OX)(e);return(0,m.g)(he,i.center,t),i.center=he,i}},91196:(e,t,i)=>{i.d(t,{A:()=>p});var s=i(6326),n=i(54099),r=i(5632),o=i(76460),a=i(30726),l=i(91291),c=i(46053),h=(i(81806),i(47249),i(87990)),d=i(19451),u=i(90992);let p=class extends((0,r.sA)((0,l.g)(n.nJ))){get spatialReferenceSupported(){return!0}constructor(e){super(e),this._updatingHandles=new d.U,this.layer=null,this.parent=null}initialize(){this.when().catch(e=>{if("layerview:create-error"!==e.name){const t=this.layer&&this.layer.id||"no id",i=this.layer?.title||"no title";o.A.getLogger(this).error("#resolve()",`Failed to resolve layer view (layer title: '${i}', id: '${t}')`,e)}})}destroy(){this._updatingHandles=(0,a.pR)(this._updatingHandles),this._set("parent",null)}get fullOpacity(){return(this.layer?.opacity??1)*(this.parent?.fullOpacity??1)}get suspended(){return this.destroyed||!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&!0===this.layer?.legendEnabled}get updating(){return!(!this._updatingHandles?.updating&&!this.isUpdating())}get updatingProgress(){return this.updating?0:1}get updateSuspended(){return this.suspended}get visible(){return!0===this.layer?.visible}set visible(e){this._overrideIfSome("visible",e)}get visibleAtCurrentScale(){return!0}get visibleAtCurrentTimeExtent(){const e=this.view.timeExtent,t=this.layer?.visibilityTimeExtent;return!e||!t||!e.intersection(t).isEmpty}canResume(){const e=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return this.visible&&this.layer?.loaded&&this.parent&&!this.parent.suspended&&this.view?.ready&&(0,u.g7)(e)&&this.visibleAtCurrentScale&&this.visibleAtCurrentTimeExtent||!1}getSuspendInfo(){const e=this.parent?.suspended?this.parent.suspendInfo:{};this.view?.ready||(e.viewNotReady=!0),this.layer&&this.layer.loaded||(e.layerNotLoaded=!0);const t=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return(0,u.g7)(t)&&this.visibleAtCurrentScale||(e.outsideScaleRange=!0),this.visibleAtCurrentTimeExtent||(e.outsideVisibilityTimeExtent=!0),this.visible||(e.layerInvisible=!0),e}isUpdating(){return!1}};(0,s.Cg)([(0,c.MZ)({readOnly:!0})],p.prototype,"spatialReferenceSupported",null),(0,s.Cg)([(0,c.MZ)()],p.prototype,"view",void 0),(0,s.Cg)([(0,c.MZ)()],p.prototype,"fullOpacity",null),(0,s.Cg)([(0,c.MZ)()],p.prototype,"layer",void 0),(0,s.Cg)([(0,c.MZ)()],p.prototype,"parent",void 0),(0,s.Cg)([(0,c.MZ)({readOnly:!0})],p.prototype,"suspended",null),(0,s.Cg)([(0,c.MZ)({readOnly:!0})],p.prototype,"suspendInfo",null),(0,s.Cg)([(0,c.MZ)({readOnly:!0})],p.prototype,"legendEnabled",null),(0,s.Cg)([(0,c.MZ)({type:Boolean,readOnly:!0})],p.prototype,"updating",null),(0,s.Cg)([(0,c.MZ)({readOnly:!0})],p.prototype,"updatingProgress",null),(0,s.Cg)([(0,c.MZ)()],p.prototype,"updateSuspended",null),(0,s.Cg)([(0,c.MZ)()],p.prototype,"visible",null),(0,s.Cg)([(0,c.MZ)({readOnly:!0})],p.prototype,"visibleAtCurrentScale",null),(0,s.Cg)([(0,c.MZ)({readOnly:!0})],p.prototype,"visibleAtCurrentTimeExtent",null),p=(0,s.Cg)([(0,h.$)("esri.views.layers.LayerView")],p)},97048:(e,t,i)=>{i.d(t,{Ir:()=>g,_b:()=>c,sQ:()=>h,xb:()=>d});var s=i(76460),n=i(68930),r=i(9392),o=i(12016),a=i(56611),l=i(14487);class c{constructor(e,t,i,s,n,r){this.layout=e,this.interleavedVertexData=t,this.indices=i,this.hasColors=s,this.hasModifications=n,this.positionData=r}}class h{constructor(e,t,i,s,n,r,o){this.componentOffsets=e,this.featureIds=t,this.anchorIds=i,this.anchors=s,this.transformedGeometry=n,this.globalTrafo=r,this.obb=o}}class d extends o.B{constructor(e){super("SceneLayerWorker","process",{process:e=>[e.geometryBuffer],project:e=>[e.positions.buffer],transformNormals:e=>[e.normals.buffer]},e,{hasInitialize:!0})}setModifications(e,t,i){const s={context:e,modifications:t,isGeodetic:i};return this.broadcast(s,"setModifications")}setLegacySchema(e,t){const i=JSON.stringify(t);return this.broadcast({context:e,jsonSchema:i},"setLegacySchema")}destroyContext(e){return this.broadcast(e,"destroyContext")}async destroyContextAndSelf(e){await this.destroyContext(e),this.destroy()}project(e,t){return this.invokeMethod("project",e,t)}transformNormals(e,t){return this.invokeMethod("transformNormals",e,t)}}const u=new n.A({deallocator:null}),p=(0,r.vt)();function g(e,t,i){u.clear();let n=1/0,r=1/0,o=-1/0,c=-1/0,h=!1;for(const g of t){const e="clip"===g.type?2:"mask"===g.type?1:0,t=g.geometry;let d=e=>e;if(t.spatialReference){if(!(0,a.canProjectWithoutEngine)(t.spatialReference,i)){s.A.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("im-modification-projection-failed","Can't project modification polygon into layer spatial reference, ignoring modification",{polygon:t});continue}d=e=>((0,l.F)(e,t.spatialReference,p,i),p)}else t.hasZ||(p[2]=0,d=e=>(p[0]=e[0],p[1]=e[1],p));h=h||1===e;const m=t.rings.length,f=t.rings.some(e=>e.length<3);if(0===m||f)s.A.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("im-modification-invalid-polygon","Ignoring invalid modification polygon (no rings or rings with less than 3 vertices).",{polygon:t});else{u.push(e),u.push(m);for(const e of t.rings){u.push(e.length);for(const t of e){const e=d(t);u.push(e[0]),u.push(e[1]),u.push(e[2]),n=Math.min(n,e[0]),r=Math.min(r,e[1]),o=Math.max(o,e[0]),c=Math.max(c,e[1])}}}}if(null!=e)if(h){const t=1e-4;u.push(2),u.push(2),u.push(4),u.push(n-t),u.push(r-t),u.push(0),u.push(o+t),u.push(r-t),u.push(0),u.push(o+t),u.push(c+t),u.push(0),u.push(n-t),u.push(c+t),u.push(0),u.push(4),u.push(e[0]),u.push(e[1]),u.push(0),u.push(e[2]),u.push(e[1]),u.push(0),u.push(e[2]),u.push(e[3]),u.push(0),u.push(e[0]),u.push(e[3]),u.push(0)}else u.push(1),u.push(1),u.push(4),u.push(e[0]),u.push(e[1]),u.push(0),u.push(e[2]),u.push(e[1]),u.push(0),u.push(e[2]),u.push(e[3]),u.push(0),u.push(e[0]),u.push(e[3]),u.push(0);u.push(3);const d=new Float64Array(u.length);for(let s=0;s<u.length;++s)d[s]=u.at(s);return d}}}]);
//# sourceMappingURL=87081.ba532e54.chunk.js.map