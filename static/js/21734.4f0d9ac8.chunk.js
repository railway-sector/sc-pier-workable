"use strict";(self.webpackChunksc_pier_workable=self.webpackChunksc_pier_workable||[]).push([[21734],{21734:(e,t,r)=>{r.r(t),r.d(t,{destroyContext:()=>w,dracoDecompressPointCloudData:()=>p,filterObbsForModifications:()=>d,filterObbsForModificationsSync:()=>v,initialize:()=>j,interpretObbModificationResults:()=>M,process:()=>h,project:()=>b,setLegacySchema:()=>m,setModifications:()=>y,setModificationsSync:()=>x,test:()=>F,transformNormals:()=>g});var s=r(15941),o=r(13312),n=r(44815),i=r(14894),a=r(5845),c=r(45136),f=r(28899);let l;var u=r(97048);async function h(e){E=await N();const t=[e.geometryBuffer];return{result:L(E,e,t),transferList:t}}async function p(e){E=await N();const t=[e.geometryBuffer],{geometryBuffer:r}=e,s=r.byteLength,o=E._malloc(s),n=new Uint8Array(E.HEAPU8.buffer,o,s);n.set(new Uint8Array(r));const i=E.dracoDecompressPointCloudData(o,n.byteLength);if(E._free(o),i.error.length>0)throw new Error(`i3s.wasm: ${i.error}`);const a=i.featureIds?.length>0?i.featureIds.slice():null,c=i.positions.slice();return a&&t.push(a.buffer),t.push(c.buffer),{result:{positions:c,featureIds:a},transferList:t}}async function d(e){await N(),v(e);const t={buffer:e.buffer};return{result:t,transferList:[t.buffer]}}async function y(e){await N(),x(e)}async function m(e){E=await N(),E.setLegacySchema(e.context,e.jsonSchema)}async function b(e){const{localMatrix:t,origin:s,positions:c,vertexSpace:f}=e,l=o.A.fromJSON(e.inSpatialReference),u=o.A.fromJSON(e.outSpatialReference),h=t?(0,n.Vj)(t):void 0,p=(0,n.cj)(s);let d;const[{projectBuffer:y},{initializeProjection:m}]=await Promise.all([Promise.resolve().then(r.bind(r,45308)),Promise.resolve().then(r.bind(r,56611))]);await m(l,u);const b=[0,0,0];if(!y(p,l,0,b,u,0))throw new Error("Failed to project");if("georeferenced"===f.type&&null==f.origin){if(d=new Float64Array(c.length),!y(c,l,0,d,u,0,d.length/3))throw new Error("Failed to project")}else{const e="georeferenced"===f.type?i.A.fromJSON(f):a.A.fromJSON(f),{projectMeshVertexPositions:t}=await r.e(22956).then(r.bind(r,22956)),s=t({vertexAttributes:{position:c},transform:h?{localMatrix:h}:void 0,vertexSpace:e,spatialReference:l},u);if(!s)throw new Error("Failed to project");d=s}const g=d.length,[w,A,E]=b;for(let r=0;r<g;r+=3)d[r]-=w,d[r+1]-=A,d[r+2]-=E;return{result:{projected:d,original:c,projectedOrigin:b},transferList:[d.buffer,c.buffer]}}async function g(e){let{normalMatrix:t,normals:r}=e;const o=new Float32Array(r.length);return(0,c.b)(o,r,t),(0,s.or)(t)&&(0,c.n)(o,o),{result:{transformed:o,original:r},transferList:[o.buffer,r.buffer]}}function w(e){S(e)}let A,E;function x(e){if(!E)return;const t=e.modifications,r=E._malloc(8*t.length),s=new Float64Array(E.HEAPU8.buffer,r,t.length);for(let o=0;o<t.length;++o)s[o]=t[o];E.setModifications(e.context,r,t.length,e.isGeodetic),E._free(r)}function L(e,t,r){const{context:s,globalTrafo:o,mbs:n,obbData:i,elevationOffset:a,geometryBuffer:c,geometryDescriptor:f,indexToVertexProjector:l,vertexToRenderProjector:h}=t,p=e._malloc(c.byteLength),d=e._malloc(33*Float64Array.BYTES_PER_ELEMENT),y=new Uint8Array(e.HEAPU8.buffer,p,c.byteLength);y.set(new Uint8Array(c));const m=new Float64Array(e.HEAPU8.buffer,d,33);_(m,[NaN,NaN,NaN]);let b=m.byteOffset+3*m.BYTES_PER_ELEMENT,g=new Float64Array(m.buffer,b);_(g,o),b+=16*m.BYTES_PER_ELEMENT,g=new Float64Array(m.buffer,b),_(g,n),b+=4*m.BYTES_PER_ELEMENT,i&&(g=new Float64Array(m.buffer,b),_(g,i));const w=f,A={isDraco:!1,isLegacy:!1,color:t.layouts.some(e=>e.some(e=>"color"===e.name)),normal:t.needNormals&&t.layouts.some(e=>e.some(e=>"normalCompressed"===e.name)),uv0:t.layouts.some(e=>e.some(e=>"uv0"===e.name)),uvRegion:t.layouts.some(e=>e.some(e=>"uvRegion"===e.name)),featureIndex:w.featureIndex},E=e.process(s,!!t.obbData,p,y.byteLength,w,A,d,a,l,h,t.normalReferenceFrame);if(e._free(d),e._free(p),E.error.length>0)throw new Error(`i3s.wasm: ${E.error}`);if(E.discarded)return null;const x=E.componentOffsets.length>0?E.componentOffsets.slice():null,L=E.featureIds.length>0?E.featureIds.slice():null,M=E.anchorIds.length>0?Array.from(E.anchorIds):null,v=E.anchors.length>0?Array.from(E.anchors):null,S=E.interleavedVertedData.slice().buffer,j=1===E.indicesType?new Uint16Array(E.indices.buffer,E.indices.byteOffset,E.indices.byteLength/2).slice():new Uint32Array(E.indices.buffer,E.indices.byteOffset,E.indices.byteLength/4).slice(),N=E.positions.slice(),{buffer:F,byteOffset:P,byteLength:I}=E.positionIndices,O=1===E.positionIndicesType?new Uint16Array(F,P,I/2).slice():new Uint32Array(F,P,I/4).slice(),R=new u._b(t.layouts[0],S,j,E.hasColors,E.hasModifications,{data:N,indices:O});return L&&r.push(L.buffer),x&&r.push(x.buffer),r.push(S),r.push(j.buffer),r.push(N.buffer),r.push(O.buffer),new u.sQ(x,L,M,v,R,o,E.obb)}function M(e){return 0===e?0:1===e?1:2===e?2:3}function v(e){if(!E)return;const{context:t,buffer:r}=e,s=E._malloc(r.byteLength),o=r.byteLength/Float64Array.BYTES_PER_ELEMENT,n=new Float64Array(E.HEAPU8.buffer,s,o),i=new Float64Array(r);n.set(i),E.filterOBBs(t,s,o),i.set(n),E._free(s)}function S(e){E&&0===E.destroy(e)&&(E=null,A=null,l=null)}function _(e,t){for(let r=0;r<t.length;++r)e[r]=t[r]}async function j(){E||await N()}async function N(){return E||(E=await(A??=(l??=(async()=>{const e=await r.e(77258).then(r.bind(r,77258));return await e.default({locateFile:e=>(0,f.s)(`esri/libs/i3s/${e}`)})})(),l))),E}const F={transform:(e,t)=>E&&L(E,e,t),destroy:S}},97048:(e,t,r)=>{r.d(t,{Ir:()=>d,_b:()=>f,sQ:()=>l,xb:()=>u});var s=r(76460),o=r(68930),n=r(9392),i=r(12016),a=r(56611),c=r(14487);class f{constructor(e,t,r,s,o,n){this.layout=e,this.interleavedVertexData=t,this.indices=r,this.hasColors=s,this.hasModifications=o,this.positionData=n}}class l{constructor(e,t,r,s,o,n,i){this.componentOffsets=e,this.featureIds=t,this.anchorIds=r,this.anchors=s,this.transformedGeometry=o,this.globalTrafo=n,this.obb=i}}class u extends i.B{constructor(e){super("SceneLayerWorker","process",{process:e=>[e.geometryBuffer],project:e=>[e.positions.buffer],transformNormals:e=>[e.normals.buffer]},e,{hasInitialize:!0})}setModifications(e,t,r){const s={context:e,modifications:t,isGeodetic:r};return this.broadcast(s,"setModifications")}setLegacySchema(e,t){const r=JSON.stringify(t);return this.broadcast({context:e,jsonSchema:r},"setLegacySchema")}destroyContext(e){return this.broadcast(e,"destroyContext")}async destroyContextAndSelf(e){await this.destroyContext(e),this.destroy()}project(e,t){return this.invokeMethod("project",e,t)}transformNormals(e,t){return this.invokeMethod("transformNormals",e,t)}}const h=new o.A({deallocator:null}),p=(0,n.vt)();function d(e,t,r){h.clear();let o=1/0,n=1/0,i=-1/0,f=-1/0,l=!1;for(const d of t){const e="clip"===d.type?2:"mask"===d.type?1:0,t=d.geometry;let u=e=>e;if(t.spatialReference){if(!(0,a.canProjectWithoutEngine)(t.spatialReference,r)){s.A.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("im-modification-projection-failed","Can't project modification polygon into layer spatial reference, ignoring modification",{polygon:t});continue}u=e=>((0,c.F)(e,t.spatialReference,p,r),p)}else t.hasZ||(p[2]=0,u=e=>(p[0]=e[0],p[1]=e[1],p));l=l||1===e;const y=t.rings.length,m=t.rings.some(e=>e.length<3);if(0===y||m)s.A.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("im-modification-invalid-polygon","Ignoring invalid modification polygon (no rings or rings with less than 3 vertices).",{polygon:t});else{h.push(e),h.push(y);for(const e of t.rings){h.push(e.length);for(const t of e){const e=u(t);h.push(e[0]),h.push(e[1]),h.push(e[2]),o=Math.min(o,e[0]),n=Math.min(n,e[1]),i=Math.max(i,e[0]),f=Math.max(f,e[1])}}}}if(null!=e)if(l){const t=1e-4;h.push(2),h.push(2),h.push(4),h.push(o-t),h.push(n-t),h.push(0),h.push(i+t),h.push(n-t),h.push(0),h.push(i+t),h.push(f+t),h.push(0),h.push(o-t),h.push(f+t),h.push(0),h.push(4),h.push(e[0]),h.push(e[1]),h.push(0),h.push(e[2]),h.push(e[1]),h.push(0),h.push(e[2]),h.push(e[3]),h.push(0),h.push(e[0]),h.push(e[3]),h.push(0)}else h.push(1),h.push(1),h.push(4),h.push(e[0]),h.push(e[1]),h.push(0),h.push(e[2]),h.push(e[1]),h.push(0),h.push(e[2]),h.push(e[3]),h.push(0),h.push(e[0]),h.push(e[3]),h.push(0);h.push(3);const u=new Float64Array(h.length);for(let s=0;s<h.length;++s)u[s]=h.at(s);return u}}}]);
//# sourceMappingURL=21734.4f0d9ac8.chunk.js.map