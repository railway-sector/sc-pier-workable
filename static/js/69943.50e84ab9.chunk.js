"use strict";(self.webpackChunksc_pier_workable=self.webpackChunksc_pier_workable||[]).push([[69943],{2522:(e,t,i)=>{i.d(t,{P:()=>s});var n=i(6326),r=(i(76460),i(81806),i(47249),i(50076),i(87990)),o=i(49853);let s=class extends o.a{};s=(0,n.Cg)([(0,r.$)("esri.views.3d.analysis.AnalysisView3D")],s)},5109:(e,t,i)=>{i.d(t,{k:()=>a});var n=i(6326),r=i(68134),o=(i(76460),i(81806),i(47249),i(50076),i(87990)),s=i(56829);let a=class extends s.g{constructor(e){super(e)}initialize(){this.addHandles((0,r.wB)(()=>this.analysisViewData.visible,e=>this.visible=e,r.pc))}deactivate(){this.onDeactivate(),this.created||this.analysis.clear()}resetCreated(){this._set("created",!1)}};a=(0,n.Cg)([(0,o.$)("esri.views.interactive.AnalysisToolBase")],a)},10260:(e,t,i)=>{i.d(t,{Hd:()=>l,ZX:()=>d,aS:()=>u,qW:()=>c});var n=i(98773),r=i(54901),o=i(30726),s=i(50346),a=i(68134);function l(e,t){return(0,a.wB)(()=>e.interactive,()=>function(e,t){e.interactive?function(e,t){u(e);const{view:i,analysis:n}=e,r=new t({view:i,analysis:n,analysisViewData:e});e.tool=r,i.tools.add(r)}(e,t):u(e)}(e,t),a.pc)}function u(e){const{view:t,tool:i}=e;null!=i&&(t.tools.remove(i),e.tool=null)}function c(e,t){const i=e.userOperation,l=(0,n.UT)(async l=>{if(i){const e=i.promise.catch(()=>{});i?.abort(),await e,(0,s.Te)(l)}const u=function(e,t){e.interactive=!0;const{tool:i,view:r}=e;r.activeTool=i;let l=(0,s.u7)(t,()=>{r.activeTool===i&&(r.activeTool=null)});return(0,n.UT)(async t=>{await(0,a.C_)(()=>!e.tool?.active,t),l=(0,o.xt)(l)},t)}(e,{signal:l}),c=t?.shouldRejectOnCancel??(()=>!0),d=(0,r.vE)([(0,a.on)(()=>e.tool,"cancel",()=>{c()&&u.abort()})]),{tool:h}=e;try{h&&(h.resetCreated(),t?.onToolActivated?.(h)),await u.promise,(0,s.Te)(l)}catch(p){if(l.aborted||!(0,s.zf)(p)||c())throw p}finally{d?.remove()}},{signal:t?.abortOptions?.signal});return e.userOperation=l,l.promise.finally(()=>{e.userOperation===l&&(e.userOperation=null)})}async function d(e,t){const i=e.analysis.clone();return await c(e,{abortOptions:t?.placementOptions,onToolActivated:t?.onToolActivated,shouldRejectOnCancel:()=>{const{analysis:t}=e;return!t.valid||t.equals(i)}}),{}}},42251:(e,t,i)=>{i.d(t,{N1:()=>u,uY:()=>c,wY:()=>l,xH:()=>a});var n=i(20664),r=i(9392),o=i(95925),s=i(92690);function a(e,t){return l(e)===l(t)}function l(e){if(null==e)return null;const t=null!=e.layer?e.layer.id:"";let i=null;return i=null!=e.objectId?e.objectId:null!=e.layer&&"objectIdField"in e.layer&&null!=e.layer.objectIdField&&null!=e.attributes?e.attributes[e.layer.objectIdField]:e.uid,null==i?null:`o-${t}-${i}`}const u={json:{write:{writer:function(e,t){null!=e?.layer?.objectIdField&&null!=e.attributes&&(t.feature={layerId:e.layer.id,objectId:e.attributes[e.layer.objectIdField]})},target:{"feature.layerId":{type:[Number,String],isRequired:!0},"feature.objectId":{type:[Number,String],isRequired:!0}}},origins:{"web-scene":{read:function(e){if(null!=e.layerId&&null!=e.objectId)return{uid:null,layer:{id:e.layerId,objectIdField:"ObjectId"},attributes:{ObjectId:e.objectId}}}}}},clonable:"reference"};function c(e,t,i,a){const{sceneIntersectionHelper:u}=e,{observer:c,observerFeatureId:h,targetFeatureId:v,target:_}=i;if(null==h&&null==v)return;a||(a=e=>e),(0,n.a)(g,c,_);const y=(0,n.b)(g);(0,n.c)(g,c,g,1/y);const m=(0,o.Cr)(g,_,p);t.options.store=2,u.intersectToolIntersectorRay(m,t);let b=null,f=null,C=null,w=null;for(const n of t.results.all){const t=(0,s.Gy)(n,e);if(null==t||null==n.distanceInRenderSpace)continue;const i=l(t);null!=i&&(null!=h&&i===h&&(b??=a(d(n,e,y)),n.distanceInRenderSpace-1<b&&(C=n)),null!=v&&i===v&&(f??=a(d(n,e,y)),null==w&&n.distanceInRenderSpace-1<y&&y-n.distanceInRenderSpace+1<f&&(w=n)))}const{observerAdjusted:O,targetAdjusted:M}=i;C?.getIntersectionPoint(O)?i.observerSurfaceNormal=C.getTransformedNormal((0,r.vt)()):i.observerSurfaceNormal=null,w?.getIntersectionPoint(M)?i.targetSurfaceNormal=w.getTransformedNormal((0,r.vt)()):i.targetSurfaceNormal=null}function d(e,t,i){if((0,s.QS)(e)){const n=(0,s.SM)(e,t);if(null!=n)return Math.min(n*h,i)}return 1e-5*i}const h=.05,p=(0,o.vt)(),g=(0,r.vt)()},49853:(e,t,i)=>{i.d(t,{a:()=>u});var n=i(6326),r=i(54099),o=i(54901),s=i(91291),a=i(46053),l=(i(81806),i(76460),i(47249),i(87990));let u=class extends((0,s.g)(r.nJ)){constructor(){super(...arguments),this.parent=null,this._userInteractive=!1,this._interactiveViewModelCount=0}get interactive(){return this._interactiveViewModelCount>0||this._userInteractive}set interactive(e){this._userInteractive=e}get updating(){return!1}get visible(){return(this.parent?.visible&&!this.parent.suspended)??!0}set visible(e){this._overrideIfSome("visible",e)}forceInteractive(){return this._interactiveViewModelCount++,(0,o.hA)(()=>this._interactiveViewModelCount--)}};(0,n.Cg)([(0,a.MZ)({constructOnly:!0})],u.prototype,"parent",void 0),(0,n.Cg)([(0,a.MZ)({constructOnly:!0})],u.prototype,"view",void 0),(0,n.Cg)([(0,a.MZ)({type:Boolean})],u.prototype,"interactive",null),(0,n.Cg)([(0,a.MZ)()],u.prototype,"_userInteractive",void 0),(0,n.Cg)([(0,a.MZ)({readOnly:!0})],u.prototype,"updating",null),(0,n.Cg)([(0,a.MZ)()],u.prototype,"visible",null),(0,n.Cg)([(0,a.MZ)()],u.prototype,"_interactiveViewModelCount",void 0),u=(0,n.Cg)([(0,l.$)("esri.views.analysis.AnalysisView")],u)},60664:(e,t,i)=>{i.d(t,{A:()=>p});var n=i(6326),r=i(42251),o=i(69098),s=i(42553),a=i(30726),l=i(46053),u=(i(81806),i(76460),i(47249),i(87990)),c=i(37546),d=i(19247),h=i(731);let p=class extends((0,s.T)(o.Pw)){constructor(e){super(e),this.position=null,this.elevationInfo=null,this.feature=null}equals(e){return(0,a.CM)(this.position,e.position)&&(0,a.CM)(this.elevationInfo,e.elevationInfo)&&(0,r.xH)(this.feature,e.feature)}};(0,n.Cg)([(0,l.MZ)({type:d.A,json:{write:!0,origins:{"web-scene":{write:{isRequired:!0}}}}}),(0,c.P)()],p.prototype,"position",void 0),(0,n.Cg)([(0,l.MZ)({type:h.A}),(0,c.P)()],p.prototype,"elevationInfo",void 0),(0,n.Cg)([(0,l.MZ)(r.N1)],p.prototype,"feature",void 0),p=(0,n.Cg)([(0,u.$)("esri.analysis.LineOfSightAnalysisTarget")],p)},63928:(e,t,i)=>{i.d(t,{W:()=>o});var n=i(45463),r=i(48168);class o extends n.i{intersect(e,t,i,n,o,s){return(0,r.Uy)(e,i,n,o,void 0,s)}intersectDraped(e,t,i,n){return(0,r.gz)(i[0],i[1],e,n)}}},64921:(e,t,i)=>{i.d(t,{w:()=>n});const n={Left:0,Middle:1,Right:2,Back:3,Forward:4,Undefined:-1}},65553:(e,t,i)=>{i.r(t),i.d(t,{default:()=>ze});var n=i(6326),r=i(19276),o=(i(81806),i(30726)),s=i(46053),a=i(76460),l=(i(47249),i(87990)),u=i(9392),c=i(2522),d=i(42251),h=i(98773),p=i(54099),g=i(88321),v=i(54901),_=i(50346),y=i(68134),m=i(20664),b=i(19451),f=i(19247),C=i(56611),w=i(50840),O=i(42294),M=i(2413),T=i(95925),I=i(12482),A=i(91967);let V=class extends A.A{constructor(e){super(e),this.target=null,this.intersectedGraphic=null,this.intersectedLocation=null,this.elevationAlignedTargetLocation=null,this.visible=void 0}};(0,n.Cg)([(0,s.MZ)()],V.prototype,"target",void 0),(0,n.Cg)([(0,s.MZ)()],V.prototype,"intersectedGraphic",void 0),(0,n.Cg)([(0,s.MZ)()],V.prototype,"intersectedLocation",void 0),(0,n.Cg)([(0,s.MZ)()],V.prototype,"elevationAlignedTargetLocation",void 0),(0,n.Cg)([(0,s.MZ)({type:Boolean})],V.prototype,"visible",void 0),V=(0,n.Cg)([(0,l.$)("esri.views.3d.analysis.LineOfSightAnalysisResult")],V);let R=class extends A.A{constructor(e){super(e),this.elevationAlignedTargetLocation=null,this.inputPoints={isValid:!1,observer:(0,u.vt)(),observerSurfaceNormal:null,observerFeatureId:null,target:(0,u.vt)(),targetSurfaceNormal:null,targetFeatureId:null,observerAdjusted:(0,u.vt)(),targetAdjusted:(0,u.vt)()},this.computationResult={start:(0,u.vt)(),end:(0,u.vt)(),intersection:(0,u.vt)(),isValid:!1,isTargetVisible:!1},this.result=null}notifyResultChanged(){this.notifyChange("computationResult")}notifyInputPointsChanged(){this.notifyChange("inputPoints")}};(0,n.Cg)([(0,s.MZ)()],R.prototype,"target",void 0),(0,n.Cg)([(0,s.MZ)()],R.prototype,"elevationAlignedTargetLocation",void 0),(0,n.Cg)([(0,s.MZ)()],R.prototype,"inputPoints",void 0),(0,n.Cg)([(0,s.MZ)()],R.prototype,"computationResult",void 0),(0,n.Cg)([(0,s.MZ)()],R.prototype,"result",void 0),R=(0,n.Cg)([(0,l.$)("esri.views.3d.analysis.LineOfSight.LineOfSightComputation")],R);var S=i(76931),P=i(75762),L=i(18690);let x=class extends A.A{constructor(e){super(e)}clone(){return this}equals(e){return this.context?.type===e.context?.type&&(!this.context||!e.context||this.context.equals(e.context))&&this.id===e.id&&(0,o.CM)(this.mapPoint,e.mapPoint)&&(0,m.G)(this.renderPoint,e.renderPoint)&&(0,L.aI)(this.normal,e.normal)&&(0,T.aI)(this.ray,e.ray)}};(0,n.Cg)([(0,s.MZ)({constructOnly:!0})],x.prototype,"context",void 0),(0,n.Cg)([(0,s.MZ)({constructOnly:!0})],x.prototype,"id",void 0),(0,n.Cg)([(0,s.MZ)({constructOnly:!0})],x.prototype,"mapPoint",void 0),(0,n.Cg)([(0,s.MZ)({constructOnly:!0})],x.prototype,"renderPoint",void 0),(0,n.Cg)([(0,s.MZ)({constructOnly:!0})],x.prototype,"normal",void 0),(0,n.Cg)([(0,s.MZ)({constructOnly:!0})],x.prototype,"ray",void 0),x=(0,n.Cg)([(0,l.$)("esri.views.3d.analysis.LineOfSight.LineOfSightIntersectionResult")],x);class E{constructor(e){this.graphic=e,this.type="graphic"}equals(e){return e.type===this.type&&this.graphic===e.graphic}}const H=new class{constructor(){this.type="ground"}equals(e){return e.type===this.type}};var Z=i(37431),D=i(21255),z=i(96342),k=i(92690);let F=class extends A.A{constructor(e){super(e),this._terrainIntersectionOptionsLayerUids=new Set(["terrain"])}initialize(){this.intersector=new z.n(this.view.state.viewingMode),this.intersector.options.hud=!1,this.intersector.options.store=0}getScreenPointIntersection(e){const t=(0,S.WA)(e,P.oG.get()),i=(0,Z.Z4)(this.view.state.camera,t,N);return this._getRayIntersection(i)}_getRayIntersection(e,t){const{view:i,intersector:n}=this;if(null==e||null==i.sceneIntersectionHelper)return null;n.options.store=0,i.sceneIntersectionHelper.intersectToolIntersectorRay(e,n,t);const r=n.results.min;if(null==r.target)return null;const o=(0,u.vt)();if(!r.getIntersectionPoint(o))return null;if(null!=t?.maxDistance&&!r.withinDistance(t.maxDistance))return null;const s=i.renderCoordsHelper.fromRenderCoords(o,new f.A({spatialReference:i.spatialReference})),a=(0,u.o8)(r.normal);if((0,D.DC)(r))return new x({context:H,id:r.target.lij.slice(),mapPoint:s,renderPoint:o,normal:a,ray:(0,T.C)(e)});if((0,D.WR)(i,r))return new x({context:H,id:`${r.target.layerViewUid}`,mapPoint:s,renderPoint:o,normal:a,ray:(0,T.C)(e)});const l=(0,k.Gy)(r,i);if(null!=l){const{layer:t}=l,i=l.getObjectId()??l.uid;return new x({context:new E(l),id:`${t?.uid}/${i}`,mapPoint:s,renderPoint:o,normal:a,ray:(0,T.C)(e)})}const c="layerViewUid"in r.target?`${r.target.layerViewUid}`:"";return new x({context:null,id:c,mapPoint:s,renderPoint:o,normal:a,ray:(0,T.C)(e)})}updateFromGroundIntersection(e,t,i){const n=G,r=j,o=U,s=B;(0,m.d)(r,e),this.view.renderCoordsHelper.worldUpAtPosition(r,o),(0,m.n)(o,o);const a=this.view.basemapTerrain.visibleElevationBounds,l=(t>=0?1:-1)*((a?Math.abs(a.max-a.min):100)+Math.abs(t));(0,m.h)(s,o,l),(0,m.g)(n,r,s),(0,T.Cr)(n,r,N);const c=this._getRayIntersection(N,{include:this._terrainIntersectionOptionsLayerUids,maxDistance:l});if(null!=c){const e=B;return(0,m.h)(e,o,t),(0,m.g)(i,c.renderPoint,e),(0,u.o8)(c.normal)}return(0,m.d)(i,e),null}};(0,n.Cg)([(0,s.MZ)()],F.prototype,"view",void 0),(0,n.Cg)([(0,s.MZ)()],F.prototype,"intersector",void 0),F=(0,n.Cg)([(0,l.$)("esri.views.3d.analysis.LineOfSight.LineOfSightRayIntersector")],F);const G=(0,u.vt)(),j=(0,u.vt)(),U=(0,u.vt)(),B=(0,u.vt)(),N=(0,T.vt)();var q=i(17430),W=i(59752);let $=class extends p.nJ{constructor(e){super(e),this.updateOnCameraChange=!0,this._observerGroundOffsetRenderSpace=0,this._effectiveObserverElevationMode="absolute-height",this._observerFeatureId=null,this._updatingHandles=new b.U,this._frameTask=W.nu,this._computationHandles=new g.A,this._externalObserverUpdate=!0}initialize(){const e=this.view.resourceController?.scheduler;this._frameTask=e?e.registerTask(W.W6.LINE_OF_SIGHT_TOOL):W.nu,this._intersector=new F({view:this.view}),this.addHandles([this._connectObserver(),this._connectComputations(),this._connectTargets()])}destroy(){this._computationHandles.destroy(),this._computations.removeAll(),this._updatingHandles.destroy()}get updating(){return this._frameTask.updating||this._updatingHandles.updating}get priority(){return this._frameTask.priority}set priority(e){this._frameTask.priority=e}get _computations(){return this.analysisViewData.computations}get _elevationAlignedObserverPositionRenderSpace(){return this.analysisViewData.observerEngineLocation}set _elevationAlignedObserverPositionRenderSpace(e){this.analysisViewData.observerEngineLocation=e}get _screenPixelSize(){return this.view.state.camera.computeScreenPixelSizeAt(this._elevationAlignedObserverPositionRenderSpace)}_computeResult(e){const t=e.computation,{inputPoints:i,computationResult:n}=t,{observerAdjusted:r,targetAdjusted:o}=i,{start:s,end:a}=n;(0,m.d)(s,r),(0,m.d)(a,o),this._canCompute(t)?this._computeIntersection(e):function(e){let{computation:t,interpolationInfo:i}=e;const{computationResult:n,inputPoints:r}=t,{start:o,end:s,intersection:a}=n,{originalIntersection:l,originalObserver:u,originalTarget:c}=i;if((0,m.d)(a,l),r.isValid){const e=X,t=(0,m.F)(u,l)/(0,m.F)(u,c);(0,m.a)(e,o,u),(0,m.h)(e,e,1-t),(0,m.g)(a,a,e),(0,m.a)(e,s,c),(0,m.h)(e,e,t),(0,m.g)(a,a,e),n.isValid=!0}else t.result=null,n.isValid=!1,n.isTargetVisible=!1}(e),t.notifyResultChanged(),this.emit("result-changed",{target:e.computation.target,result:t.result})}_adjustStartEndPositions(e){const{view:t}=this,{inputPoints:i}=e,{observer:n,target:r,observerAdjusted:o,targetAdjusted:s}=i;(0,m.d)(o,n),(0,m.d)(s,r),(0,d.uY)(t,this._intersector.intersector,i);const{observerSurfaceNormal:a,targetSurfaceNormal:l}=i,u=this._screenPixelSize,c=X;null!=a?(0,m.d)(c,a):(0,m.e)(c,s,o);const h=u;(0,m.n)(c,c),(0,m.h)(c,c,Math.min(h,1)),(0,m.g)(o,o,c),null!=l?(0,m.d)(c,l):(0,m.e)(c,o,s);const p=t.state.camera.computeScreenPixelSizeAt(s);(0,m.n)(c,c),(0,m.h)(c,c,Math.min(p,1)),(0,m.g)(s,s,c)}_computeIntersection(e){let{computation:t,interpolationInfo:i}=e;const{view:n}=this,{sceneIntersectionHelper:r,renderCoordsHelper:o}=n;if(null==r)return;const s=this._intersector.intersector,{computationResult:a,inputPoints:l}=t,{observer:u,target:c}=l,{start:d,end:h}=a,p=(0,T.Cr)(d,h,J);s.options.store=0,r.intersectToolIntersectorRay(p,s);const g=s.results.min,v=a.intersection,_=X;let y=!0;if(null!=g&&g.getIntersectionPoint(v)){(0,m.d)(i.originalIntersection,v),(0,m.d)(i.originalObserver,d),(0,m.d)(i.originalTarget,h),o.fromRenderCoords(v,_,n.spatialReference);const e=1-(0,m.F)(h,c)/(0,m.F)(d,c);y=(0,m.F)(u,v)>=e*(0,m.F)(u,c)}const b=new f.A(_,n.spatialReference);{const{result:e,target:i}=t;null!=e?(e.target=i,e.intersectedGraphic=y?null:(0,k.Gy)(g,n),e.intersectedLocation=y?null:b,e.visible=y):t.result=new V({target:i,elevationAlignedTargetLocation:t.elevationAlignedTargetLocation,intersectedGraphic:y?null:(0,k.Gy)(g,n),intersectedLocation:y?null:b,visible:y})}a.isValid=l.isValid=!0,a.isTargetVisible=y}_canCompute(e){const t=this.analysisViewData.elevationAlignedObserver,i=this.view.frustum;if(null==t||null==e.elevationAlignedTargetLocation||null==i)return!1;const{observerAdjusted:n,targetAdjusted:r}=e.inputPoints,o=i.intersectsPoint(n),s=i.intersectsPoint(r);return o&&s}_onObserverPositionChange(e,t,i,n,r){if(this._externalObserverUpdate=r,null==e)return this.analysisViewData.elevationAlignedObserver=null,void(this._observerFeatureId=null);if(null==t)return(0,q.V)(this.analysis,e.spatialReference,a.A.getLogger(this)),void(this.analysisViewData.elevationAlignedObserver=null);const o=Q(t,i),{absoluteZ:s,elevation:l}=(0,I.Q5)(t.x,t.y,t.z,this.view.spatialReference,this.view,o),c=t.clone();c.z=s,this._effectiveObserverElevationMode=o.mode,this.analysisViewData.elevationAlignedObserver=c;const h=(0,u.vt)();this.view.renderCoordsHelper.toRenderCoords(c,h),this._elevationAlignedObserverPositionRenderSpace=h,this._observerGroundOffsetRenderSpace=s-l,this._observerFeatureId=(0,d.wY)(n),this.priority=W.W6.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onObserverRenderSpacePositionChangeForComputation(e,t,i,n,r){const{inputPoints:o}=e;switch((0,m.d)(o.observer,t),o.observerFeatureId=r,o.observerSurfaceNormal=null,n){case"on-the-ground":case"relative-to-ground":{const e=this._intersector.updateFromGroundIntersection(o.observer,i,o.observer);null==o.observerFeatureId&&(o.observerSurfaceNormal=e)}}this._adjustStartEndPositions(e),e.notifyInputPointsChanged(),this.priority=W.W6.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onTargetPositionChange(e,t,i,n,r){let o=!(arguments.length>5&&void 0!==arguments[5])||arguments[5];const s=e.inputPoints;if(o&&(s.isValid=!1),null==i)return null!=t&&(0,q.V)(this.analysis,t.spatialReference,a.A.getLogger(this)),e.elevationAlignedTargetLocation=null,void e.notifyInputPointsChanged();const l=Q(i,n),{absoluteZ:u,elevation:c}=(0,I.Q5)(i.x,i.y,i.z,this.view.spatialReference,this.view,l),h=i.clone();switch(h.z=u,e.elevationAlignedTargetLocation=h,this.view.renderCoordsHelper.toRenderCoords(e.elevationAlignedTargetLocation,s.target),s.targetFeatureId=(0,d.wY)(r),s.targetSurfaceNormal=null,l.mode){case"on-the-ground":case"relative-to-ground":{const e=this._intersector.updateFromGroundIntersection(s.target,u-c,s.target);null==s.targetFeatureId&&(s.targetSurfaceNormal=e)}}this._adjustStartEndPositions(e),e.notifyInputPointsChanged(),this.priority=W.W6.LINE_OF_SIGHT_TOOL_INTERACTIVE}_connectComputationToTarget(e){return(0,v.vE)([this._updatingHandles.add(()=>({computation:e,targetPosition:e.target.position,targetElevationInfo:e.target.elevationInfo,targetFeatureInfo:e.target.feature,projectedTargetPosition:(0,C.projectOrLoad)(e.target.position,this.view.spatialReference)}),e=>{let{computation:t,targetPosition:i,targetElevationInfo:n,targetFeatureInfo:r,projectedTargetPosition:o}=e;null==o.pending?this._onTargetPositionChange(t,i,o.geometry,n,r):this._updatingHandles.addPromise(o.pending)},y.Vh)])}_connectComputationToObserver(e){return this._updatingHandles.add(()=>({computation:e,observer:this.analysisViewData.elevationAlignedObserver}),e=>{let{computation:t}=e;this._externalObserverUpdate&&(t.inputPoints.isValid=!1,t.notifyInputPointsChanged())},y.Vh)}_connectComputationToRenderSpaceObserver(e){return this._updatingHandles.add(()=>({computation:e,observer:this._elevationAlignedObserverPositionRenderSpace,observerGroundOffset:this._observerGroundOffsetRenderSpace,observerElevationMode:this._effectiveObserverElevationMode,observerFeatureId:this._observerFeatureId}),e=>{let{computation:t,observer:i,observerGroundOffset:n,observerElevationMode:r,observerFeatureId:o}=e;this._onObserverRenderSpacePositionChangeForComputation(t,i,n,r,o)},y.Vh)}_connectComputationToCamera(e){return this._updatingHandles.add(()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty}),t=>{let{isDirty:i}=t;!this.updateOnCameraChange||e.inputPoints.isValid&&!i||e.notifyInputPointsChanged()})}_connectComputationToSlicePlane(e){return this._updatingHandles.add(()=>this.view.slice.plane,()=>{e.inputPoints.isValid=!1,e.notifyInputPointsChanged()})}_connectComputationToElevation(e){const t=(i,n)=>{const r=this.analysis.observer,o=e.target;let s=null,a=null,l=null,u=null,c=null,d=null;if(null!=r?.position){const e=(0,C.projectOrLoad)(r.position,this.view.spatialReference);if(null!=e.pending)return this._updatingHandles.addPromise(e.pending),void e.pending.finally(()=>t(i,n));s=e.geometry,a=r.elevationInfo,l=r.feature}if(null!=o.position){const e=(0,C.projectOrLoad)(o.position,this.view.spatialReference);if(null!=e.pending)return this._updatingHandles.addPromise(e.pending),void e.pending.finally(()=>t(i,n));u=e.geometry,c=o.elevationInfo,d=o.feature}null==s&&null==u||((0,w.S)(i,n,K,this.view.spatialReference),null!=s&&(0,M.vR)(K,s)&&this._onObserverPositionChange(null!=r?r.position:null,s,a,l,!1),null!=u&&(0,M.vR)(K,u)&&this._onTargetPositionChange(e,o.position,u,c,d,!1),null!=s&&null!=u&&(0,M.Mx)(K,s,u)&&e.notifyInputPointsChanged())};return this.view.elevationProvider.on("elevation-change",e=>{let{extent:i,spatialReference:n}=e;return t(i,n)})}_connectComputationToTask(e){let t=null;const i={computation:e,interpolationInfo:{originalIntersection:(0,u.vt)(),originalObserver:(0,u.vt)(),originalTarget:(0,u.vt)()}};return(0,v.vE)([this._updatingHandles.add(()=>e.inputPoints,()=>{t=(0,o.DC)(t),t=(0,h.UT)(async e=>{await(0,_.QZ)(this._frameTask.schedule(()=>this._computeResult(i),e))})},{initial:!0,equals:()=>!1}),(0,v.hA)(()=>t=(0,o.DC)(t))])}_connectComputationToContent(e){return(0,y.on)(()=>this.view.pointsOfInterest?.contentGeometryUpdates.events,"request-update",t=>{const i=t?.renderBounds,{observerAdjusted:n,targetAdjusted:r}=e.inputPoints;(null==i||(0,O.Mx)(i,n,r))&&(e.inputPoints.isValid=!1,e.notifyInputPointsChanged())})}_connectComputation(e){const t=this._computationHandles;t.has(e)||t.add([this._connectComputationToTarget(e),this._connectComputationToObserver(e),this._connectComputationToRenderSpaceObserver(e),this._connectComputationToCamera(e),this._connectComputationToSlicePlane(e),this._connectComputationToElevation(e),this._connectComputationToTask(e),this._connectComputationToContent(e)],e)}_disconnectComputation(e){this._computationHandles.remove(e)}_onComputationCollectionChange(e){let{added:t,removed:i}=e;for(const n of i)this._disconnectComputation(n);for(const n of t)this._connectComputation(n)}_onTargetCollectionChange(e){let{added:t,removed:i}=e;for(const n of i)this._removeTarget(n);for(const n of t)this._addTarget(n)}_onCursorTargetChange(e,t){null!=t&&this._removeTarget(t),null!=e&&this._addTarget(e)}_addTarget(e){this._computations.some(t=>t.target===e)||this._computations.add(new R({target:e}))}_removeTarget(e){const t=this._computations.findIndex(t=>t.target===e);this._computations.removeAt(t)}_connectObserver(){return(0,v.vE)([this._updatingHandles.add(()=>({observerPosition:null!=this.analysis.observer?this.analysis.observer.position:null,projectedObserverPosition:(0,C.projectOrLoad)(null!=this.analysis.observer?this.analysis.observer.position:null,this.view.spatialReference),observerElevationInfo:null!=this.analysis.observer?this.analysis.observer.elevationInfo:null,observerFeatureInfo:null!=this.analysis.observer?this.analysis.observer.feature:null}),e=>{let{observerPosition:t,projectedObserverPosition:i,observerElevationInfo:n,observerFeatureInfo:r}=e;null==i.pending?this._onObserverPositionChange(t,i.geometry,n,r,!0):this._updatingHandles.addPromise(i.pending)},y.Vh)])}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this._computations,e=>this._onComputationCollectionChange(e),{initial:!0,final:!0})}_connectTargets(){return(0,v.vE)([this._updatingHandles.addOnCollectionChange(()=>this.analysis.targets,e=>this._onTargetCollectionChange(e),{initial:!0,final:!0}),this._updatingHandles.add(()=>this.analysisViewData.cursorTarget,(e,t)=>{this._onCursorTargetChange(e,t)})])}get _isCameraDirty(){const e=this.analysisViewData.elevationAlignedObserver,{view:t}=this,{renderCoordsHelper:i}=t;if(null==e||null==i)return!1;const n=X;i.toRenderCoords(e,n);const r=t.state.camera.computeScreenPixelSizeAt(n);return Math.abs((r-this._screenPixelSize)/this._screenPixelSize)>Y}};function Q(e,t){return e.hasZ?t??{mode:"absolute-height",offset:0}:{mode:"on-the-ground",offset:0}}(0,n.Cg)([(0,s.MZ)({constructOnly:!0})],$.prototype,"analysis",void 0),(0,n.Cg)([(0,s.MZ)({constructOnly:!0})],$.prototype,"analysisViewData",void 0),(0,n.Cg)([(0,s.MZ)({constructOnly:!0})],$.prototype,"view",void 0),(0,n.Cg)([(0,s.MZ)()],$.prototype,"updating",null),(0,n.Cg)([(0,s.MZ)()],$.prototype,"priority",null),(0,n.Cg)([(0,s.MZ)()],$.prototype,"updateOnCameraChange",void 0),(0,n.Cg)([(0,s.MZ)()],$.prototype,"_computations",null),(0,n.Cg)([(0,s.MZ)()],$.prototype,"_elevationAlignedObserverPositionRenderSpace",null),(0,n.Cg)([(0,s.MZ)()],$.prototype,"_observerGroundOffsetRenderSpace",void 0),(0,n.Cg)([(0,s.MZ)()],$.prototype,"_effectiveObserverElevationMode",void 0),(0,n.Cg)([(0,s.MZ)()],$.prototype,"_observerFeatureId",void 0),(0,n.Cg)([(0,s.MZ)()],$.prototype,"_screenPixelSize",null),(0,n.Cg)([(0,s.MZ)({readOnly:!0})],$.prototype,"_updatingHandles",void 0),(0,n.Cg)([(0,s.MZ)()],$.prototype,"_frameTask",void 0),(0,n.Cg)([(0,s.MZ)()],$.prototype,"_isCameraDirty",null),$=(0,n.Cg)([(0,l.$)("esri.views.3d.analysis.LineOfSight.LineOfSightController")],$);const Y=.1,X=(0,u.vt)(),J=(0,T.vt)(),K=(0,M.Ie)();var ee=i(69539),te=i(78059),ie=i(60664),ne=i(44230),re=i(731),oe=i(59784);const se=new class{constructor(){this.glowWidth=8,this.innerWidth=.75}};const ae=new class{constructor(){this.size=.5}};function le(e){return(0,oe.f6)(e.accentColor,.75)}const ue=new class{constructor(){this.size=.5,this.visibleColor=new ee.A([3,252,111,.75]),this.occludedColor=new ee.A([252,3,69,.75]),this.undefinedColor=new ee.A([127,127,127,.75])}};const ce=new class{constructor(){this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new ee.A([3,252,111,1]),this.visibleOuterColor=new ee.A([3,252,111,.15]),this.occludedInnerColor=new ee.A([252,3,69,1]),this.occludedOuterColor=new ee.A([252,3,69,.1]),this.undefinedInnerColor=new ee.A([255,255,255,1]),this.undefinedOuterColor=new ee.A([127,127,127,.2])}};var de=i(56121),he=i(38317),pe=i(91175),ge=i(86507),ve=i(72017);class _e extends de.q{constructor(e,t){const i=(0,he.UM)(le(e.effectiveTheme)),n=(0,ve.CM)(i,ae.size,32,32),r=new pe.M(n);super({view:e,renderObjects:[r],metadata:t,elevationInfo:{mode:"absolute-height",offset:0}}),(0,ge.s)(this),this.themeHandle=(0,y.wB)(()=>({color:le(e.effectiveTheme)}),e=>{i.setParameters(e)})}destroy(){this.themeHandle.remove(),super.destroy()}}class ye extends de.q{constructor(e,t){const{size:i,visibleColor:n,occludedColor:r,undefinedColor:o}=ue;super({view:e,renderObjects:[me(i,n,16),me(i,r,32),me(i,o,64)],metadata:t,elevationInfo:{mode:"absolute-height",offset:0}}),(0,ge.s)(this)}}function me(e,t,i){return new pe.M((0,ve.CM)((0,he.UM)(ee.A.toUnitRGBA(t)),e,32,32),i)}var be=i(1307),fe=i(64921),Ce=i(5109),we=i(17046),Oe=i(11500);let Me=class extends Ce.k{constructor(e){super(e),this._creationMode=!1,this.removeIncompleteOnCancel=!1,this.analysisViewData=null,this._latestPointerMovePointerType=null,this._laserlineVisualElement=null,this._grabbedManipulator=null,this._analysisHandles=new g.A,this._updatingHandles=new b.U,this._manipulatorHandles=new g.A,this._targetTrackerManipulator=null}initialize(){this._intersector=new F({view:this.view}),this.addHandles((0,y.z7)(()=>"created"===this.state,()=>this.finishToolCreation(),y.pc)),this._observerManipulator=this._createObserverManipulator(),this._createLaserLine(),this.addHandles([this._updatingHandles.add(()=>this.analysisViewData?.elevationAlignedObserver,e=>this._onObserverLocationChange(e),y.Vh),this._updatingHandles.add(()=>function(e){const t=e.accentColor;return{glowColor:t,innerColor:(0,oe.bJ)(t),globalAlpha:.75*t.a}}(this.view.effectiveTheme),e=>{let{glowColor:t,innerColor:i,globalAlpha:n}=e;return this._updateLaserLineStyle(t,i,n)},y.Vh),this._updatingHandles.add(()=>this._laserLineRendererDependencies(),e=>this._updateLaserLineRenderer(e)),this._connectComputations(),this._updatingHandles.addWhen(()=>!this._shouldRenderTracker,()=>this._clearCursorTracker(),y.Vh),this._updatingHandles.add(()=>({active:this.active,hasGrabbedManipulators:this.hasGrabbedManipulators}),e=>{let{active:t,hasGrabbedManipulators:i}=e;this._creationMode=!!t&&(this._creationMode||!i)},y.Vh)])}destroy(){this._updatingHandles=(0,o.pR)(this._updatingHandles),this._manipulatorHandles=(0,o.pR)(this._manipulatorHandles),this._analysisHandles=(0,o.pR)(this._analysisHandles),this._observerManipulator=null,this._clearCursorTracker(),this._removeLaserLine(),this._intersector=null,this._set("analysis",null)}get state(){return this.active?!this.hasGrabbedManipulators||this._creationMode?"creating":"created":null!=this.analysis.observer?.position?"created":"ready"}get cursor(){return this.active&&this._showTracker?"crosshair":null}get updating(){return null!=this.analysisViewData&&this.analysisViewData.updating||this._updatingHandles.updating}get _showTracker(){return this.active&&"mouse"===this._latestPointerMovePointerType}get _shouldRenderTracker(){return this._showTracker&&null!=this.analysis.observer?.position&&!this.hasGrabbedManipulators}continue(){this.view.activeTool=this}stop(){this.view.activeTool=null}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}onInputEvent(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e)}}onInputEventAfter(e){"immediate-click"===e.type&&this._clickHandler(e)}onShow(){}onHide(){}onDeactivate(){this._clearCursorTracker()}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this.analysisViewData.computations,e=>this._onComputationsCollectionChange(e),{initial:!0,final:!0})}_onComputationsCollectionChange(e){let{added:t,removed:i}=e;for(const n of i)this._disconnectComputation(n);for(const n of t)this._connectComputation(n)}_connectComputation(e){if(this.destroyed)return void a.A.getLogger(this).warn("Attempting to connect an analysis to a destroyed LineOfSight tool. Ignoring.");const t=this._analysisHandles;if(t.has(e))return;const i=this._createTargetManipulator(e.target);null==this._targetTrackerManipulator&&i.metadata.target===this.analysisViewData.cursorTarget&&(this._targetTrackerManipulator=i,this._targetTrackerManipulator.available=!1,this._targetTrackerManipulator.interactive=!1,this._updateLaserLineRenderer()),t.add([this._updatingHandles.add(()=>function(e){const{isValid:t,isTargetVisible:i}=e.computationResult;return{isValid:t,isTargetVisible:i}}(e),()=>function(e,t){const{isValid:i,isTargetVisible:n}=t.computationResult;e.state=i?n?16:32:64}(i,e),y.Vh),this._updatingHandles.add(()=>e.elevationAlignedTargetLocation,e=>this._onTargetLocationChange(e,i),y.Vh)],e)}_disconnectComputation(e){if(this.destroyed)return void a.A.getLogger(this).warn("Attempting to disconnect an analysis from a destroyed LineOfSight tool. Ignoring.");this._analysisHandles.remove(e);const t=this._getTargetManipulator(e.target);null!=t&&(this.manipulators.remove(t),this._manipulatorHandles.remove(t),null!=this._targetTrackerManipulator&&this._targetTrackerManipulator===t&&(this._targetTrackerManipulator=null))}_clearCursorTracker(){this.analysisViewData.cursorTarget=(0,o.pR)(this.analysisViewData.cursorTarget)}_createTargetManipulator(e){const t={target:e,type:"target"},i=new ye(this.view,t);return this._manipulatorHandles.add([this._createTargetManipulatorDragPipeline(i),i.events.on("grab-changed",e=>this._manipulatorGrabChanged(i,e)),i.events.on("immediate-click",e=>this._manipulatorClick(i,e))],i),this.manipulators.add(i),null!=e.position?i.elevationAlignedLocation=e.position:i.available=!1,i}_getTargetManipulator(e){let t=null;return this.manipulators.forEach(i=>{const n=i.manipulator;null==t&&"target"===n.metadata.type&&n.metadata.target===e&&(t=n)}),t}_createObserverManipulator(){const e=new _e(this.view,{type:"observer",intersection:null});return this._manipulatorHandles.add([this._createObserverManipulatorDragPipeline(e),e.events.on("grab-changed",t=>this._manipulatorGrabChanged(e,t)),e.events.on("immediate-click",t=>this._manipulatorClick(e,t))],e),this.manipulators.add(e),e}_screenToIntersection(){return e=>{const t=this._intersector.getScreenPointIntersection(e.screenEnd);return null==t?null:{...e,intersection:t}}}_createTargetManipulatorDragPipeline(e){return(0,we.Xt)(e,(t,i,n)=>{i.next(this._screenToIntersection()).next(this._updateTargetDragStep(e)).next(()=>this._updateLaserLineRenderer()),n.next(function(e){const t=e.position?.clone();return i=>(e.position=t,i)}(e.metadata.target)).next(()=>this._updateLaserLineRenderer())})}_createObserverManipulatorDragPipeline(e){return(0,we.Xt)(e,(e,t,i)=>{t.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next(()=>this._updateLaserLineRenderer()),i.next(this._cancelObserverDragStep()).next(()=>this._updateLaserLineRenderer())})}_updateObserverDragStep(){return e=>(null!=e.intersection.mapPoint?(null==this.analysis.observer&&(this.analysis.observer=new te.A),this._updateFromIntersection(this.analysis.observer,e.intersection)):this.analysis.observer=null,e)}_cancelObserverDragStep(){const e=null!=this.analysis.observer?.position?this.analysis.observer.clone():null;return t=>(this.analysis.observer=e,t)}_updateTargetDragStep(e){return t=>{this._updateFromIntersection(e.metadata.target,t.intersection);const i=t.intersection.mapPoint;return null!=i&&(e.elevationAlignedLocation=i),t}}_manipulatorGrabChanged(e,t){switch(t.action){case"start":this._grabbedManipulator=e;break;case"end":this._grabbedManipulator===e&&(this._grabbedManipulator=null)}}_laserLineRendererDependencies(){return{laserlineVisualElement:this._laserlineVisualElement,grabbedManipulator:this._grabbedManipulator,shouldRenderTracker:this._shouldRenderTracker,observerPosition:null!=this.analysis.observer?this.analysis.observer.position:null,visible:this.visible}}_updateLaserLineRenderer(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._laserLineRendererDependencies();const{laserlineVisualElement:t,grabbedManipulator:i,shouldRenderTracker:n,observerPosition:r,visible:o}=e;if(null==t)return;const s=null!=i?i:n&&null!=r?this._targetTrackerManipulator:null;null!=s&&o?(t.visible=!0,t.heightManifoldTarget=s.renderLocation,s!==this._observerManipulator?t.lineVerticalPlaneSegment=(0,ne.Cr)(this._observerManipulator.renderLocation,s.renderLocation,Te):t.lineVerticalPlaneSegment=null):(t.visible=!1,t.heightManifoldTarget=null,t.lineVerticalPlaneSegment=null)}_createLaserLine(){this._removeLaserLine();const{glowWidth:e,innerWidth:t}=se;this._laserlineVisualElement=new be.o({view:this.view,attached:!0,visible:this.visible,style:{glowWidth:e,innerWidth:t},isDecoration:!0})}_removeLaserLine(){null!=this._laserlineVisualElement&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)}_updateLaserLineStyle(e,t,i){const n=this._laserlineVisualElement;if(null==n)return;const r=n.style;n.style={...r,glowColor:ee.A.toUnitRGB(e),innerColor:ee.A.toUnitRGB(t),globalAlpha:i}}_onObserverLocationChange(e){null!=e?(this._observerManipulator.metadata.intersection=null,this._observerManipulator.available=!0,this._observerManipulator.elevationAlignedLocation=e):this._observerManipulator.available=!1}_onTargetLocationChange(e,t){null!=e?(t.elevationAlignedLocation=e,t!==this._targetTrackerManipulator&&(t.available=!0)):t.available=!1}_addPointFromClickEvent(e){const t=this._intersector.getScreenPointIntersection(e);if(null!=t?.mapPoint)if(null!=this.analysis.observer?.position){this._clearCursorTracker();const e=new ie.A;this._updateFromIntersection(e,t),this.analysis.targets.add(e)}else{const e=new te.A;this._updateFromIntersection(e,t),this.analysis.observer=e}}_clickHandler(e){this.active&&e.button!==fe.w.Right&&(this._addPointFromClickEvent((0,Oe.ZV)(e)),e.stopPropagation())}_doubleClickHandler(e){this.active&&e.button!==fe.w.Right&&(this.stop(),e.stopPropagation())}_pointerMoveHandler(e){if(this.hasGrabbedManipulators)return;if(this._latestPointerMovePointerType=e.pointerType,this._updateLaserLineRenderer(),!this._showTracker||null==this.analysis.observer?.position)return;const t=(0,Oe.ZV)(e),i=this._intersector.getScreenPointIntersection(t);null!=i?.mapPoint&&(null==this.analysisViewData.cursorTarget&&(this.analysisViewData.cursorTarget=new ie.A),this._updateFromIntersection(this.analysisViewData.cursorTarget,i),this._updateLaserLineRenderer())}_updateFromIntersection(e,t){if(null==t.mapPoint)return e.position=null,e.elevationInfo=null,void(e.feature=null);switch(t.context?.type){case"graphic":{const i=t.context.graphic,n=(0,I.bh)(i);"on-the-ground"===n.mode&&(n.mode="relative-to-ground",n.offset=0),e.elevationInfo=new re.A(n),e.feature=i}break;case"ground":e.elevationInfo=new re.A({mode:"on-the-ground"}),e.feature=null;break;default:e.elevationInfo=null,e.feature=null}const i=t.mapPoint.clone();i.z=(0,I.wS)(this.view,i,{mode:"absolute-height",offset:0},e.elevationInfo),e.position=i}_manipulatorClick(e,t){if("observer"===e.metadata.type||e.grabbing||e.dragging||t.button!==fe.w.Right||this.analysis.targets.length<=1)return;const{target:i}=e.metadata;this.analysis.targets.remove(i),t.stopPropagation()}get testInfo(){}};(0,n.Cg)([(0,s.MZ)({constructOnly:!0})],Me.prototype,"view",void 0),(0,n.Cg)([(0,s.MZ)({constructOnly:!0})],Me.prototype,"analysis",void 0),(0,n.Cg)([(0,s.MZ)()],Me.prototype,"_creationMode",void 0),(0,n.Cg)([(0,s.MZ)({readOnly:!0})],Me.prototype,"state",null),(0,n.Cg)([(0,s.MZ)({readOnly:!0})],Me.prototype,"cursor",null),(0,n.Cg)([(0,s.MZ)()],Me.prototype,"removeIncompleteOnCancel",void 0),(0,n.Cg)([(0,s.MZ)({readOnly:!0})],Me.prototype,"updating",null),(0,n.Cg)([(0,s.MZ)({constructOnly:!0})],Me.prototype,"analysisViewData",void 0),(0,n.Cg)([(0,s.MZ)({readOnly:!0})],Me.prototype,"_showTracker",null),(0,n.Cg)([(0,s.MZ)()],Me.prototype,"_latestPointerMovePointerType",void 0),(0,n.Cg)([(0,s.MZ)()],Me.prototype,"_shouldRenderTracker",null),(0,n.Cg)([(0,s.MZ)()],Me.prototype,"_laserlineVisualElement",void 0),(0,n.Cg)([(0,s.MZ)()],Me.prototype,"_grabbedManipulator",void 0),Me=(0,n.Cg)([(0,l.$)("esri.views.3d.analysis.LineOfSight.LineOfSightTool")],Me);const Te=(0,ne.vt)();var Ie=i(13191);class Ae{constructor(e,t,i,n){this.visibleLineVisualElement=e,this.occludedLineVisualElement=t,this.undefinedLineVisualElement=i,this.targetVisualElement=n}destroy(){this.visibleLineVisualElement.destroy(),this.occludedLineVisualElement.destroy(),this.undefinedLineVisualElement.destroy(),this.targetVisualElement.destroy()}}var Ve=i(7256),Re=i(83574);let Se=class extends A.A{constructor(e){super(e),this._lineOfSightVisualElements=new Array,this._computationHandles=new g.A,this._updatingHandles=new b.U}initialize(){this.addHandles(this._connectComputations()),this._createObserverVisualization()}destroy(){this._updatingHandles=(0,o.pR)(this._updatingHandles),this._computationHandles=(0,o.pR)(this._computationHandles),this._observerVisualElement=(0,o.pR)(this._observerVisualElement)}get visible(){return this.analysisViewData.visible}get updating(){return this._updatingHandles.updating}get interactiveAndEditable(){return this.analysisViewData.interactive&&this.analysisViewData.editable}get test(){}_createLineOfSightVisualization(){const e=ce,t=this.view,i=this.isDecoration,n={view:t,attached:!0,width:e.outerWidth,innerWidth:e.innerWidth,isDecoration:i},r=ee.A.toUnitRGBA(e.visibleOuterColor),o=ee.A.toUnitRGBA(e.visibleInnerColor),s=ee.A.toUnitRGBA(e.occludedOuterColor),a=ee.A.toUnitRGBA(e.occludedInnerColor),l=ee.A.toUnitRGBA(e.undefinedOuterColor),u=ee.A.toUnitRGBA(e.undefinedInnerColor),c=new Ve.t({...n,color:r,innerColor:o}),d=new Ve.t({...n,color:s,innerColor:a}),h=new Ve.t({...n,color:l,innerColor:u}),p=new Re.l({view:t,attached:!0,...Pe,size:8,isDecoration:i}),g=new Ae(c,d,h,p);return this._lineOfSightVisualElements.push(g),g}_destroyLineOfSightVisualization(e){e.destroy(),this._lineOfSightVisualElements.splice(this._lineOfSightVisualElements.indexOf(e),1)}_updateLineOfSightVisualization(e,t,i){const n=ce,{computationResult:r,inputPoints:o}=e,{start:s,end:a,intersection:l,isValid:c,isTargetVisible:d}=r,{observer:h}=o,p=He;p[12]=h[0],p[13]=h[1],p[14]=h[2];const g=(0,m.e)(Le,s,h),v=(0,m.e)(xe,a,h),_=(0,m.e)(Ee,l,h),{visibleLineVisualElement:y,occludedLineVisualElement:b,undefinedLineVisualElement:f,targetVisualElement:C}=t,w=null==this.analysisViewData.elevationAlignedObserver||null==e.elevationAlignedTargetLocation,O=this.visible&&!w;y.visible=O,b.visible=O,f.visible=O,C.visible=O,C.attached=!i.interactiveAndEditable,O&&(y.geometry=null,b.geometry=null,f.geometry=null,C.geometry=e.elevationAlignedTargetLocation,c?d?(y.geometry=[[(0,u.ci)(g),(0,u.ci)(v)]],y.transform=p,y.color=ee.A.toUnitRGBA(n.visibleOuterColor),C.color=ee.A.toUnitRGBA(n.visibleInnerColor)):(y.geometry=[[(0,u.ci)(g),(0,u.ci)(_)]],y.transform=p,y.color=ee.A.toUnitRGBA(n.occludedOuterColor),b.geometry=[[(0,u.ci)(_),(0,u.ci)(v)]],b.transform=p,C.color=ee.A.toUnitRGBA(n.occludedInnerColor)):(f.geometry=[[(0,u.ci)(g),(0,u.ci)(v)]],f.transform=p,C.color=ee.A.toUnitRGBA(n.undefinedInnerColor)))}_getLineOfSightVisualizationDependencies(e){const{computationResult:t}=e,{occludedOuterColor:i,visibleOuterColor:n}=ce;return{computationResult:t,occludedOuterColor:i,visibleOuterColor:n,visible:this.visible,interactiveAndEditable:this.interactiveAndEditable}}_connectComputation(e){const t=this._computationHandles;if(t.has(e))return;const i=this._createLineOfSightVisualization();t.add([this._updatingHandles.add(()=>this._getLineOfSightVisualizationDependencies(e),t=>this._updateLineOfSightVisualization(e,i,t),{initial:!0,equals:()=>!1}),(0,v.hA)(()=>this._destroyLineOfSightVisualization(i))],e)}_disconnectComputation(e){this._computationHandles.remove(e)}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this.analysisViewData.computations,e=>this._onComputationsCollectionChange(e),{initial:!0,final:!0})}_onComputationsCollectionChange(e){let{added:t,removed:i}=e;for(const n of i)this._disconnectComputation(n);for(const n of t)this._connectComputation(n)}_createObserverVisualization(){const e=ee.A.toUnitRGBA(ce.visibleInnerColor),t=new Re.l({view:this.view,color:e,...Pe,isDecoration:this.isDecoration});this._observerVisualElement=t,this.addHandles(this._updatingHandles.add(()=>({observer:this.analysisViewData.elevationAlignedObserver,interactiveAndEditable:this.interactiveAndEditable,visible:this.visible}),e=>{let{observer:i,interactiveAndEditable:n,visible:r}=e;null!=i&&!n&&r?(t.geometry=i,this._observerVisualElement.attached=!0):t.attached=!1},y.Vh))}};(0,n.Cg)([(0,s.MZ)({constructOnly:!0})],Se.prototype,"analysis",void 0),(0,n.Cg)([(0,s.MZ)({constructOnly:!0})],Se.prototype,"analysisViewData",void 0),(0,n.Cg)([(0,s.MZ)({constructOnly:!0})],Se.prototype,"view",void 0),(0,n.Cg)([(0,s.MZ)({readOnly:!0})],Se.prototype,"visible",null),(0,n.Cg)([(0,s.MZ)({constructOnly:!0})],Se.prototype,"isDecoration",void 0),(0,n.Cg)([(0,s.MZ)()],Se.prototype,"updating",null),(0,n.Cg)([(0,s.MZ)()],Se.prototype,"interactiveAndEditable",null),(0,n.Cg)([(0,s.MZ)()],Se.prototype,"test",null),Se=(0,n.Cg)([(0,l.$)("esri.views.3d.analysis.LineOfSight.LineOfSightVisualization")],Se);const Pe={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0},Le=(0,u.vt)(),xe=(0,u.vt)(),Ee=(0,u.vt)(),He=(0,Ie.vt)();var Ze=i(10260);let De=class extends c.P{constructor(e){super(e),this.type="line-of-sight-view-3d",this.analysis=null,this.tool=null,this.computations=new r.A,this.cursorTarget=null,this.editable=!0,this.elevationAlignedObserver=null,this.observerEngineLocation=(0,u.vt)(),this.userOperation=null}initialize(){const e=this.view,t=this.analysis;this._analysisController=new $({analysis:t,analysisViewData:this,view:e}),this._analysisVisualization=new Se({analysis:t,analysisViewData:this,view:e,isDecoration:!this.parent}),this.addHandles([this._analysisController.on("result-changed",e=>{e.target!==this.cursorTarget&&this.emit("result-changed",e)}),(0,Ze.Hd)(this,Me)])}destroy(){(0,Ze.aS)(this),this.userOperation=(0,o.DC)(this.userOperation),this._analysisController=(0,o.pR)(this._analysisController),this._analysisVisualization=(0,o.pR)(this._analysisVisualization)}get visible(){return super.visible}set visible(e){super.visible=e}get interactive(){return super.interactive}set interactive(e){super.interactive=e}get results(){return this.computations.map(e=>e.result)}get priority(){return this._analysisController.priority}set priority(e){this._analysisController.priority=e}get updating(){return null!=this._analysisController&&this._analysisController.updating||null!=this._analysisVisualization&&this._analysisVisualization.updating}place(e){return(0,Ze.ZX)(this,{placementOptions:e})}getResultForTarget(e){return this.computations.find(t=>t.target===e)?.result}get testInfo(){}};(0,n.Cg)([(0,s.MZ)({readOnly:!0})],De.prototype,"type",void 0),(0,n.Cg)([(0,s.MZ)({constructOnly:!0,nonNullable:!0})],De.prototype,"analysis",void 0),(0,n.Cg)([(0,s.MZ)()],De.prototype,"tool",void 0),(0,n.Cg)([(0,s.MZ)({readOnly:!0})],De.prototype,"results",null),(0,n.Cg)([(0,s.MZ)()],De.prototype,"priority",null),(0,n.Cg)([(0,s.MZ)()],De.prototype,"computations",void 0),(0,n.Cg)([(0,s.MZ)()],De.prototype,"cursorTarget",void 0),(0,n.Cg)([(0,s.MZ)()],De.prototype,"editable",void 0),(0,n.Cg)([(0,s.MZ)()],De.prototype,"elevationAlignedObserver",void 0),(0,n.Cg)([(0,s.MZ)()],De.prototype,"observerEngineLocation",void 0),(0,n.Cg)([(0,s.MZ)()],De.prototype,"updating",null),(0,n.Cg)([(0,s.MZ)()],De.prototype,"userOperation",void 0),(0,n.Cg)([(0,s.MZ)()],De.prototype,"_analysisController",void 0),(0,n.Cg)([(0,s.MZ)()],De.prototype,"_analysisVisualization",void 0),De=(0,n.Cg)([(0,l.$)("esri.views.3d.analysis.LineOfSightAnalysisView3D")],De);const ze=De},74050:(e,t,i)=>{i.d(t,{Dh:()=>a,IB:()=>u,fg:()=>s,jI:()=>l});i(15941);var n=i(19555),r=i(72745);function o(e,t){return e[0]*t[1]-e[1]*t[0]}function s(e,t,i,r){let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:i;return(0,n.Re)(d,r,i),(0,n.Re)(p,t,o),function(e,t,i){const r=(0,n.Om)(i,t)/(0,n.m3)(i);(0,n.hs)(e,i,r)}(g,p,d),(0,n.WQ)(e,o,g)}function a(e,t,i,r){(0,n.Re)(d,t,i);const o=r/(0,n.Bw)(d);return(0,n.Ln)(e,i,d,o)}function l(e,t){const i=e.start,r=e.end,s=t.start,a=t.end,l=(0,n.Re)(d,r,i),u=(0,n.Re)(h,a,s),v=o(l,u);if(Math.abs(v)<=c)return[];const _=(0,n.Re)(p,i,s),y=o(u,_)/v,m=o(l,_)/v;if(y>=0){if(m>=0||1===t.type)return[(0,n.Ln)(g,i,l,y)]}else if(1===e.type&&(m>=0||1===t.type))return[(0,n.Ln)(g,i,l,y)];return[]}function u(e,t,i){const r=[],o=(0,n.Re)(d,e.end,e.start),s=(0,n.Re)(h,e.start,t),a=(0,n.m3)(o),l=2*(0,n.Om)(o,s),u=l*l-4*a*((0,n.m3)(s)-i*i);if(0===u){const t=-l/(2*a);(1===e.type||t>=0)&&r.push((0,n.Ln)(g,e.start,o,t))}else if(u>0){const t=Math.sqrt(u),i=(-l+t)/(2*a);(1===e.type||i>=0)&&r.push((0,n.Ln)(g,e.start,o,i));const s=(-l-t)/(2*a);(1===e.type||s>=0)&&r.push((0,n.Ln)(p,e.start,o,s))}return r}const c=1e-6,d=(0,r.vt)(),h=(0,r.vt)(),p=(0,r.vt)(),g=(0,r.vt)()},78059:(e,t,i)=>{i.d(t,{A:()=>v});var n=i(6326),r=i(42251),o=i(91967),s=i(69098),a=i(42553),l=i(30726),u=i(46053),c=(i(81806),i(76460),i(47249),i(87990)),d=i(37546),h=i(19247),p=i(731);let g=class extends((0,a.T)((0,s.OU)(o.A))){constructor(e){super(e),this.position=null,this.elevationInfo=null,this.feature=null}equals(e){return(0,l.CM)(this.position,e.position)&&(0,l.CM)(this.elevationInfo,e.elevationInfo)&&(0,r.xH)(this.feature,e.feature)}};(0,n.Cg)([(0,u.MZ)({type:h.A,json:{write:{isRequired:!0}}})],g.prototype,"position",void 0),(0,n.Cg)([(0,u.MZ)({type:p.A}),(0,d.P)()],g.prototype,"elevationInfo",void 0),(0,n.Cg)([(0,u.MZ)(r.N1)],g.prototype,"feature",void 0),g=(0,n.Cg)([(0,c.$)("esri.analysis.LineOfSightAnalysisObserver")],g);const v=g},83574:(e,t,i)=>{i.d(t,{l:()=>y});var n=i(15941),r=i(20664),o=i(9392),s=i(43047),a=i(55855),l=i(14487),u=i(42294),c=i(75762),d=i(32314),h=i(67425),p=i(49296),g=i(72900),v=i(72017),_=i(84248);class y extends d.X{constructor(e){super(e),this._material=null,this._texture=null,this._geometry=null,this._size=3,this._color=(0,a.fA)(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=(0,a.fA)(1,1,1,1),this._elevationInfo=null,this.applyProperties(e)}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get size(){return this._size}set size(e){if(e!==this._size){const t=this._preferredTextureSize;this._size=e,t<this._preferredTextureSize?this.recreate():this._updateSizeAttribute()}}get color(){return this._color}set color(e){(0,s.a)(e,this._color)||((0,s.d)(this._color,e),this._updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this._updateMaterial())}get primitive(){return this._primitive}set primitive(e){this._primitive!==e&&(this._primitive=e,this.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){(0,s.a)(e,this._outlineColor)||((0,s.d)(this._outlineColor,e),this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}_updateMaterial(){this._material?.setParameters(this._materialParameters)}_updateSizeAttribute(){const e=this.object;if(null==e)return;const t=e.geometries[0];if(null==t)return;const i=t.getMutableAttribute("size").data,n=this._geometrySize;i[0]=n,i[1]=n,e.geometryVertexAttributeUpdated(e.geometries[0],"size")}get _materialParameters(){return{color:this._color,textureIsSignedDistanceField:!0,sampleSignedDistanceFieldTexelCenter:(0,g.ny)(this._primitive),distanceFieldBoundingBox:g.PY,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:this._texture?.id,polygonOffset:!1,shaderPolygonOffset:0,drawAsLabel:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled,isDecoration:this.isDecoration}}get _geometrySize(){return this._size/g.CN}createExternalResources(){this._texture=(0,g.sZ)(this._primitive,this._preferredTextureSize),this._material=new _.R(this._materialParameters,1===this.view.state.viewingMode);const e=this.view.stage;this._texture.load(e.renderView.renderingContext),e.addTexture(this._texture)}destroyExternalResources(){this._texture&&(this.view.stage.removeTexture(this._texture),this._texture.dispose(),this._texture=null),this._material=null}createGeometries(e){const t=this._createRenderGeometry();null!=t&&e.addGeometry(t)}forEachMaterial(e){e(this._material)}get _preferredTextureSize(){return(0,n.qE)(2*this._geometrySize,16,128)}calculateMapBounds(e){const t=this.object?.geometries[0];if(!t)return!1;const i=t.attributes.get("position").data;return(0,l.F)(i,this.view.renderCoordsHelper.spatialReference,m,this.view.spatialReference),(0,u.Hq)(e,m),!0}_createRenderGeometry(){const{geometry:e,_material:t}=this;if(null==e||null==t)return null;const{renderCoordsHelper:i,elevationProvider:n}=this.view,o=(0,h.nG)(e,n,p.F.fromElevationInfo(this.elevationInfo),i),s=(0,r.j)(c.rq.get(),e.x,e.y,o),a=c.rq.get();(0,l.F)(s,e.spatialReference,a,i.spatialReference);const u=this._geometrySize;return(0,v.DJ)(t,{position:a,size:[u,u],centerOffsetAndDistance:[0,0,0,1]})}}const m=(0,o.vt)()},86507:(e,t,i)=>{i.d(t,{Q:()=>o,s:()=>s});var n=i(54901),r=i(12482);function o(e,t){return function(e,t){return!!e&&"on-the-ground"!==t.mode&&!(0,r.v9)(t)}(e?.data.coordinateHelper.hasZ(),t)}function s(e,t){let i=null;const r=e.events.on("grab-changed",n=>{null!=i&&(i.remove(),i=null),"start"===n.action?(i=e.disableDisplay(),t&&t(n)):t&&t(n)});return(0,n.hA)(()=>{i?.remove(),r.remove()})}}}]);
//# sourceMappingURL=69943.50e84ab9.chunk.js.map