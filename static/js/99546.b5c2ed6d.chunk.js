"use strict";(self.webpackChunksc_pier_workable=self.webpackChunksc_pier_workable||[]).push([[99546],{18153:(e,t,n)=>{n.d(t,{$:()=>h,p:()=>d});var s=n(23862),i=n(80794),o=n(9876),r=n(72317);function a(e){let{x:t,y:n,z:i}=e;return(0,s.fA)(t,n,i??0)}function h(e,t){switch(e.type){case"edge":return e.draped?new i.X({edgeStart:a(e.start),edgeEnd:a(e.end),targetPoint:(0,s.de)(a(e.target)),objectId:e.objectId,getGroundElevation:t}):new o.z({edgeStart:a(e.start),edgeEnd:a(e.end),targetPoint:(0,s.de)(a(e.target)),objectId:e.objectId,isDraped:!1});case"vertex":return new r.C({targetPoint:(0,s.de)(a(e.target)),objectId:e.objectId,isDraped:!1})}}function d(e,t){return"3d"===e?.type?(n,s)=>e.elevationProvider.getElevation(n,s,0,t,"ground"):()=>null}},23241:(e,t,n)=>{n.d(t,{_:()=>o});var s=n(20664),i=n(64753);class o extends i.m{constructor(e,t,n){super(t,n),this.point=e}equals(e){return e instanceof o&&(0,s.q)(this.point,e.point)}}},33328:(e,t,n)=>{n.d(t,{F:()=>h});var s=n(81806),i=n(70373),o=n(2413);const r={minX:0,minY:0,maxX:0,maxY:0};function a(e,t,n){(function(e){r.minX=e[0],r.minY=e[1],r.maxX=e[2],r.maxY=e[3]})(t),e.search(r,n)}class h{constructor(){this._indexInvalid=!1,this._boundsToLoad=[],this._boundsById=new Map,this._idByBounds=new Map,this._index=new i.wq(9,(0,s.A)("esri-csp-restrictions")?e=>({minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}):["[0]","[1]","[2]","[3]"]),this._loadIndex=()=>{if(this._indexInvalid){const e=new Array(this._idByBounds.size);let t=0;this._idByBounds.forEach((n,s)=>{e[t++]=s}),this._indexInvalid=!1,this._index.clear(),this._index.load(e)}else this._boundsToLoad.length&&(this._index.load(Array.from(new Set(this._boundsToLoad.filter(e=>this._idByBounds.has(e))))),this._boundsToLoad.length=0)}}get fullBounds(){if(!this._boundsById.size)return null;const e=(0,o.Ie)();for(const t of this._boundsById.values())t&&(e[0]=Math.min(t[0],e[0]),e[1]=Math.min(t[1],e[1]),e[2]=Math.max(t[2],e[2]),e[3]=Math.max(t[3],e[3]));return e}get valid(){return!this._indexInvalid}clear(){this._indexInvalid=!1,this._boundsToLoad.length=0,this._boundsById.clear(),this._idByBounds.clear(),this._index.clear()}delete(e){const t=this._boundsById.get(e);this._boundsById.delete(e),t&&(this._idByBounds.delete(t),this._indexInvalid||this._index.remove(t))}forEachInBounds(e,t){this._loadIndex(),a(this._index,e,e=>t(this._idByBounds.get(e)))}get(e){return this._boundsById.get(e)}has(e){return this._boundsById.has(e)}invalidateIndex(){this._indexInvalid||(this._indexInvalid=!0,this._boundsToLoad.length=0)}set(e,t){if(!this._indexInvalid){const t=this._boundsById.get(e);t&&(this._index.remove(t),this._idByBounds.delete(t))}this._boundsById.set(e,t),t&&(this._idByBounds.set(t,e),this._indexInvalid||(this._boundsToLoad.push(t),this._boundsToLoad.length>5e4&&this._loadIndex()))}}},33376:(e,t,n)=>{n.d(t,{T:()=>i});var s=n(20176);const i={getObjectId:e=>e.objectId,getAttributes:e=>e.attributes,getAttribute:(e,t)=>e.attributes[t],cloneWithGeometry:(e,t)=>new s.Om(t,e.attributes,null,e.objectId),getGeometry:e=>e.geometry,getCentroid:(e,t)=>e.ensureCentroid(t)}},35961:(e,t,n)=>{n.d(t,{n:()=>h});n(81806);var s=n(53521),i=n(87663),o=n(50346),r=n(31633),a=n(81478);function h(){let e=arguments.length>1?arguments[1]:void 0;if(arguments.length>0&&void 0!==arguments[0]&&arguments[0]){const{elevationInfo:t,alignPointsInFeatures:n}=e;return new u(t,n)}return new d}class d{async alignCandidates(e,t,n){return e}notifyElevationSourceChange(){}}class u{constructor(e,t){this._elevationInfo=e,this._alignPointsInFeatures=t,this._alignmentsCache=new s.q(1024),this._cacheVersion=0}async alignCandidates(e,t,n){const s=this._elevationInfo;return null==s||"absolute-height"!==s.mode||s.featureExpressionInfo?this._alignComputedElevationCandidates(e,t,n):(function(e,t,n){const{offset:s,unit:i}=n;if(null==s)return;const o=(0,r.G9)(t),h=s*((0,a.Ao)(i??"meters")/o);for(const r of e)switch(r.type){case"edge":r.start.z+=h,r.end.z+=h;continue;case"vertex":r.target.z+=h;continue}}(e,t,s),e)}notifyElevationSourceChange(){this._alignmentsCache.clear(),this._cacheVersion++}async _alignComputedElevationCandidates(e,t,n){const s=new Map;for(const o of e)(0,i.tE)(s,o.objectId,p).push(o);const[r,a,h]=this._prepareQuery(s,t),d=await this._alignPointsInFeatures(r,n);if((0,o.Te)(n),h!==this._cacheVersion)return this._alignComputedElevationCandidates(e,t,n);this._applyCacheAndResponse(r,d,a);const{drapedObjectIds:u,failedObjectIds:l}=d,c=[];for(const i of e){const{objectId:e}=i;u.has(e)&&"edge"===i.type&&(i.draped=!0),l.has(e)||c.push(i)}return c}_prepareQuery(e,t){const n=[],s=[];for(const[i,o]of e){const e=[];for(const t of o)this._addToQueriesOrCachedResult(i,t.target,e,s),"edge"===t.type&&(this._addToQueriesOrCachedResult(i,t.start,e,s),this._addToQueriesOrCachedResult(i,t.end,e,s));0!==e.length&&n.push({objectId:i,points:e})}return[{spatialReference:t.toJSON(),pointsInFeatures:n},s,this._cacheVersion]}_addToQueriesOrCachedResult(e,t,n,s){const i=c(e,t),o=this._alignmentsCache.get(i);null==o?n.push(t):s.push(new l(t,o))}_applyCacheAndResponse(e,t,n){let{elevations:s,drapedObjectIds:i,failedObjectIds:o}=t;for(const h of n)h.apply();let r=0;const a=this._alignmentsCache;for(const{objectId:h,points:d}of e.pointsInFeatures){if(o.has(h)){r+=d.length;continue}const e=!i.has(h);for(const t of d){const n=c(h,t),i=s[r++];t.z=i,e&&a.put(n,i,1)}}}}class l{constructor(e,t){this.point=e,this.z=t}apply(){this.point.z=this.z}}function c(e,t){let{x:n,y:s,z:i,spatialReference:o}=t;return`${e}-${n}-${s}-${i??0}}-wkid:${o?.wkid}`}function p(){return[]}},54222:(e,t,n)=>{n.d(t,{b3:()=>l,jZ:()=>u});var s=n(62825),i=n(2413),o=n(758),r=n(5262),a=n(19902),h=n(73548),d=n(80963);function u(e){return c(e,!0)}function l(e){return c(e,!1)}function c(e,t){if(null==e)return null;const n=e.spatialReference,i=(0,d.Vp)(n),r=(0,s.W)(e)?e.toJSON():e;if(!i)return r;const u=(0,d.K8)(n)?102100:4326,l=h.j7[u].maxX,c=h.j7[u].minX;if((0,a.fT)(r))return _(r,l,c);if((0,a.U9)(r))return r.points=r.points.map(e=>_(e,l,c)),r;if((0,a.ZC)(r))return p(r,i);if((0,a.Bi)(r)||(0,a.Rg)(r)){const e=(0,o.Rg)(v,r),n={xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3]},s=(0,h.kd)(n.xmin,c)*(2*l),i=0===s?r:(0,h.kS)(r,s);return n.xmin+=s,n.xmax+=s,n.xmax>l?m(i,l,t):n.xmin<c?m(i,c,t):i}return r}function p(e,t){if(!t)return e;const n=function(e,t){const n=[],{ymin:s,ymax:i,xmin:o,xmax:r}=e,a=e.xmax-e.xmin,[h,d]=t.valid,{x:u,frameId:l}=y(e.xmin,t),{x:c,frameId:p}=y(e.xmax,t),_=u===c&&a>0;if(a>2*d){const e={xmin:o<r?u:c,ymin:s,xmax:d,ymax:i},t={xmin:h,ymin:s,xmax:o<r?c:u,ymax:i},a={xmin:0,ymin:s,xmax:d,ymax:i},_={xmin:h,ymin:s,xmax:0,ymax:i},y=[],f=[];g(e,a)&&y.push(l),g(e,_)&&f.push(l),g(t,a)&&y.push(p),g(t,_)&&f.push(p);for(let n=l+1;n<p;n++)y.push(n),f.push(n);n.push(new x(e,[l]),new x(t,[p]),new x(a,y),new x(_,f))}else u>c||_?n.push(new x({xmin:u,ymin:s,xmax:d,ymax:i},[l]),new x({xmin:h,ymin:s,xmax:c,ymax:i},[p])):n.push(new x({xmin:u,ymin:s,xmax:c,ymax:i},[l]));return n}(e,t).map(e=>e.extent);return n.length<2?n[0]||e:n.length>2?(e.xmin=t.valid[0],e.xmax=t.valid[1],e):{rings:n.map(e=>[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]])}}function _(e,t,n){if(Array.isArray(e)){const s=e[0];if(s>t){const n=(0,h.kd)(s,t);e[0]=s+n*(-2*t)}else if(s<n){const t=(0,h.kd)(s,n);e[0]=s+t*(-2*n)}}else{const s=e.x;if(s>t){const n=(0,h.kd)(s,t);e.x+=n*(-2*t)}else if(s<n){const t=(0,h.kd)(s,n);e.x+=t*(-2*n)}}return e}function y(e,t){const[n,s]=t.valid,i=2*s;let o,r=0;return e>s?(o=Math.ceil(Math.abs(e-s)/i),e-=o*i,r=o):e<n&&(o=Math.ceil(Math.abs(e-n)/i),e+=o*i,r=-o),{x:e,frameId:r}}function g(e,t){const{xmin:n,ymin:s,xmax:i,ymax:o}=t;return f(e,n,s)&&f(e,n,o)&&f(e,i,o)&&f(e,i,s)}function f(e,t,n){return t>=e.xmin&&t<=e.xmax&&n>=e.ymin&&n<=e.ymax}function m(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const s=!(0,a.Rg)(e);if(s&&(0,r.m3)(e),n)return(new I).cut(e,t);const i=s?e.rings:e.paths,o=s?4:2,h=i.length,d=-2*t;for(let r=0;r<h;r++){const e=i[r];if(e&&e.length>=o){const t=[];for(const n of e)t.push([n[0]+d,n[1]]);i.push(t)}}return s?e.rings=i:e.paths=i,e}class x{constructor(e,t){this.extent=e,this.frameIds=t}}const v=(0,i.vt)();class I{constructor(){this._linesIn=[],this._linesOut=[]}cut(e,t){let n;if(this._xCut=t,e.rings)this._closed=!0,n=e.rings,this._minPts=4;else{if(!e.paths)return null;this._closed=!1,n=e.paths,this._minPts=2}for(const i of n){if(!i||i.length<this._minPts)continue;let e=!0;for(const t of i)e?(this.moveTo(t),e=!1):this.lineTo(t);this._closed&&this.close()}this._pushLineIn(),this._pushLineOut(),n=[];for(const i of this._linesIn)i&&i.length>=this._minPts&&n.push(i);const s=-2*this._xCut;for(const i of this._linesOut)if(i&&i.length>=this._minPts){for(const e of i)e[0]+=s;n.push(i)}return this._closed?e.rings=n:e.paths=n,e}moveTo(e){this._pushLineIn(),this._pushLineOut(),this._prevSide=this._side(e[0]),this._moveTo(e[0],e[1],this._prevSide),this._prevPt=e,this._firstPt=e}lineTo(e){const t=this._side(e[0]);if(t*this._prevSide===-1){const n=this._intersect(this._prevPt,e);this._lineTo(this._xCut,n,0),this._prevSide=0,this._lineTo(e[0],e[1],t)}else this._lineTo(e[0],e[1],t);this._prevSide=t,this._prevPt=e}close(){const e=this._firstPt,t=this._prevPt;e[0]===t[0]&&e[1]===t[1]||this.lineTo(e),this._checkClosingPt(this._lineIn),this._checkClosingPt(this._lineOut)}_moveTo(e,t,n){this._closed?(this._lineIn.push([n<=0?e:this._xCut,t]),this._lineOut.push([n>=0?e:this._xCut,t])):(n<=0&&this._lineIn.push([e,t]),n>=0&&this._lineOut.push([e,t]))}_lineTo(e,t,n){this._closed?(b(this._lineIn,n<=0?e:this._xCut,t),b(this._lineOut,n>=0?e:this._xCut,t)):n<0?(0===this._prevSide&&this._pushLineOut(),this._lineIn.push([e,t])):n>0?(0===this._prevSide&&this._pushLineIn(),this._lineOut.push([e,t])):this._prevSide<0?(this._lineIn.push([e,t]),this._lineOut.push([e,t])):this._prevSide>0&&(this._lineOut.push([e,t]),this._lineIn.push([e,t]))}_checkClosingPt(e){const t=e.length;t>3&&e[0][0]===this._xCut&&e[t-2][0]===this._xCut&&e[1][0]===this._xCut&&(e[0][1]=e[t-2][1],e.pop())}_side(e){return e<this._xCut?-1:e>this._xCut?1:0}_intersect(e,t){const n=(this._xCut-e[0])/(t[0]-e[0]);return e[1]+n*(t[1]-e[1])}_pushLineIn(){this._lineIn&&this._lineIn.length>=this._minPts&&this._linesIn.push(this._lineIn),this._lineIn=[]}_pushLineOut(){this._lineOut&&this._lineOut.length>=this._minPts&&this._linesOut.push(this._lineOut),this._lineOut=[]}}function b(e,t,n){const s=e.length;s>1&&e[s-1][0]===t&&e[s-2][0]===t?e[s-1][1]=n:e.push([t,n])}},69963:(e,t,n)=>{n.d(t,{H:()=>a});n(81806);var s=n(53084),i=n(53521),o=n(50346),r=n(88685);function a(){return arguments.length>0&&void 0!==arguments[0]&&arguments[0]?new d(arguments.length>1?arguments[1]:void 0):new h}class h{async fetch(){return[]}notifySymbologyChange(){}}class d{constructor(e){this._getSymbologyCandidates=e,this._candidatesCache=new i.q(1024),this._cacheVersion=0}async fetch(e,t){if(0===e.length)return[];const n=[],i=[],r=this._candidatesCache;for(const o of e){const e=u(o),t=r.get(e);if(t)for(const n of t)i.push((0,s.o8)(n));else n.push(o),r.put(e,[],1)}if(0===n.length)return i;const a=this._cacheVersion,{candidates:h,sourceCandidateIndices:d}=await this._getSymbologyCandidates(n,t);if((0,o.Te)(t),a!==this._cacheVersion)return this.fetch(e,t);const l=[],{length:c}=h;for(let o=0;o<c;++o){const e=h[o],t=u(n[d[o]]),i=r.get(t);i.push(e),r.put(t,i,i.length),l.push((0,s.o8)(e))}return i.concat(l)}notifySymbologyChange(){this._candidatesCache.clear(),this._cacheVersion++}}function u(e){switch(e.type){case"vertex":{const{objectId:t,target:n}=e,s=`${t}-vertex-${n.x}-${n.y}-${n.z??0}`;return(0,r.Wm)(s).toString()}case"edge":{const{objectId:t,start:n,end:s}=e,i=`${t}-edge-${n.x}-${n.y}-${n.z??0}-to-${s.x}-${s.y}-${s.z??0}`;return(0,r.Wm)(i).toString()}default:return""}}},72317:(e,t,n)=>{n.d(t,{C:()=>r});var s=n(75543),i=n(61751),o=n(23241);class r extends i.w{constructor(e){super({...e,constraint:new s.i7(e.targetPoint)})}get hints(){return[new o._(this.targetPoint,this.isDraped,this.domain)]}}},72547:(e,t,n)=>{n.d(t,{A:()=>_});var s=n(18690),i=n(50076),o=n(54099),r=n(76460),a=n(42294),h=n(2413),d=n(98618),u=n(33328),l=n(55167),c=n(33376);const p=(0,a.vt)();class _{constructor(e){this.geometryInfo=e,this._boundsStore=new u.F,this._featuresById=new Map,this._usedMemory=0,this.events=new o.bk,this.featureAdapter=c.T}get usedMemory(){return this._usedMemory}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){return this._boundsStore.fullBounds}get storeStatistics(){let e=0;return this._featuresById.forEach(t=>{null!=t.geometry&&t.geometry.coords&&(e+=t.geometry.coords.length)}),{featureCount:this._featuresById.size,vertexCount:e/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}getFullExtent(e){if(null==this.fullBounds)return null;const[t,n,s,i]=this.fullBounds;return{xmin:t,ymin:n,xmax:s,ymax:i,spatialReference:(0,l.ag)(e)}}add(e){this._add(e),this._emitChanged()}addMany(e){for(const t of e)this._add(t);this._emitChanged()}upsertMany(e){const t=e.map(e=>this._upsert(e));return this._emitChanged(),t.filter(s.Ru)}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged(),this._usedMemory=0}removeById(e){const t=this._featuresById.get(e);return t?(this._remove(t),this._emitChanged(),t):null}removeManyById(e){this._boundsStore.invalidateIndex();for(const t of e){const e=this._featuresById.get(t);e&&this._remove(e)}this._emitChanged()}forEachBounds(e,t){for(const n of e){const e=this._boundsStore.get(n.objectId);e&&t((0,a.Jt)(p,e))}}getFeature(e){return this._featuresById.get(e)}has(e){return this._featuresById.has(e)}forEach(e){this._featuresById.forEach(t=>e(t))}forEachInBounds(e,t){this._boundsStore.forEachInBounds(e,e=>{t(this._featuresById.get(e))})}_emitChanged(){this.events.emit("changed",void 0)}_add(e){if(!e)return;const t=e.objectId;if(null==t)return void r.A.getLogger("esri.layers.graphics.data.FeatureStore").error(new i.A("featurestore:invalid-feature","feature id is missing",{feature:e}));const n=this._featuresById.get(t);let s;if(n?(e.displayId=n.displayId,s=this._boundsStore.get(t),this._boundsStore.delete(t),this._usedMemory-=this.estimateFeatureUsedMemory?.(n)??0):null!=this.onFeatureAdd&&this.onFeatureAdd(e),!e.geometry?.coords?.length)return this._boundsStore.set(t,null),void this._featuresById.set(t,e);s=(0,d.jQ)(null!=s?s:(0,h.vt)(),e.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),null!=s&&this._boundsStore.set(t,s),this._featuresById.set(t,e),this._usedMemory+=this.estimateFeatureUsedMemory?.(e)??0}_upsert(e){const t=e?.objectId;if(null==t)return r.A.getLogger("esri.layers.graphics.data.FeatureStore").error(new i.A("featurestore:invalid-feature","feature id is missing",{feature:e})),null;const n=this._featuresById.get(t);if(!n)return this._add(e),e;this._usedMemory-=this.estimateFeatureUsedMemory?.(n)??0;const{geometry:s,attributes:o}=e;for(const i in o)n.attributes[i]=o[i];return s&&(n.geometry=s,this._boundsStore.set(t,(0,d.jQ)((0,h.vt)(),s,this.geometryInfo.hasZ,this.geometryInfo.hasM)??null)),this._usedMemory+=this.estimateFeatureUsedMemory?.(n)??0,n}_remove(e){null!=this.onFeatureRemove&&this.onFeatureRemove(e);const t=e.objectId;return this._boundsStore.delete(t),this._featuresById.delete(t),this._usedMemory-=this.estimateFeatureUsedMemory?.(e)??0,e}}},74964:(e,t,n)=>{n.d(t,{z:()=>r});n(81806);class s{filter(e,t){return t}notifyElevationSourceChange(){}}class i{filter(e,t){const{point:n,distance:s}=e,{z:i}=n;if(null==i)return t;if(0===t.length)return t;const r=function(e){return"number"==typeof e?{x:e,y:e,z:e}:e}(s),a=this._updateCandidatesTo3D(t,n,r).filter(o);return a.sort(d),a}_updateCandidatesTo3D(e,t,n){for(const s of e)switch(s.type){case"edge":a(s,t,n);continue;case"vertex":h(s,t,n);continue}return e}}function o(e){return e.distance<=1}function r(){return arguments.length>0&&void 0!==arguments[0]&&arguments[0]?new i:new s}function a(e,t,n){let{x:s,y:i,z:o}=n;const{start:r,end:a,target:h}=e;e.draped||function(e,t,n,s){const i=s.x-n.x,o=s.y-n.y,r=s.z-n.z,a=i*i+o*o+r*r,h=(t.x-n.x)*i+(t.y-n.y)*o+r*(t.z-n.z),d=Math.min(1,Math.max(0,h/a)),u=n.x+i*d,l=n.y+o*d,c=n.z+r*d;e.x=u,e.y=l,e.z=c}(h,t,r,a);const d=(t.x-h.x)/s,u=(t.y-h.y)/i,l=(t.z-h.z)/o;e.distance=Math.sqrt(d*d+u*u+l*l)}function h(e,t,n){let{x:s,y:i,z:o}=n;const{target:r}=e,a=(t.x-r.x)/s,h=(t.y-r.y)/i,d=(t.z-r.z)/o,u=Math.sqrt(a*a+h*h+d*d);e.distance=u}function d(e,t){return e.distance-t.distance}},99546:(e,t,n)=>{n.r(t),n.d(t,{GraphicsSnappingSource:()=>P});var s=n(6326),i=n(91967),o=n(18690),r=n(98773),a=n(56002),h=n(50346),d=n(68134),u=n(46053),l=(n(81806),n(76460),n(87990)),c=n(19451),p=n(65215),_=n(56611),y=n(54222),g=n(31608),f=n(98618),m=n(20176),x=n(72547),v=n(12034),I=n(1900),b=n(12482),C=n(94439),S=n(70330),w=n(18153),B=n(35961),M=n(74964),z=n(69963),E=n(59752);const O="graphics-collections";let P=class extends i.A{get updating(){return this._updatingHandles.updating}get _hasZ(){const e=this.view;return null!=e&&"3d"===e.type&&"map-notes"!==this.layerSource.layer.type}get _snappingElevationAligner(){const{view:e}=this,{layer:t}=this.layerSource,n=null!=e&&"3d"===e.type;if(!n||"map-notes"===t.type)return(0,B.n)();return(0,B.n)(n,{elevationInfo:t.elevationInfo,alignPointsInFeatures:async(n,s)=>(await(0,h.qr)(e.whenLayerView(t),s)).elevationAlignPointsInFeatures(n,s)})}get _snappingElevationFilter(){const{view:e}=this,t=null!=e&&"3d"===e.type&&"map-notes"!==this.layerSource.layer.type;return(0,M.z)(t)}get _symbologySnappingFetcher(){const{view:e}=this,{layer:t}=this.layerSource,n=null!=e&&"3d"===e.type,s=this._extrudedPolygonSymbolsCount>0;return n&&"map-notes"!==t.type&&s?(0,z.H)(s,async(n,s)=>{const i=await e.whenLayerView(t);return(0,h.Te)(s),i.queryForSymbologySnapping({candidates:n,spatialReference:e.spatialReference},s)}):(0,z.H)()}constructor(e){super(e),this.availability=1,this._sources={multipoint:null,point:null,polygon:null,polyline:null},this._loadedWkids=new Set,this._loadedWkts=new Set,this._pendingAdds=[],this._extrudedPolygonSymbolsCount=0,this._updatingHandles=new c.U,this._memoizedMakeGetGroundElevation=(0,a.B)(w.p)}destroy(){for(const e of this._pendingAdds)e.task.abort();this._pendingAdds.length=0,this._mapSources(e=>this._destroySource(e)),this._updatingHandles.destroy()}initialize(){this._updatingHandles.add(()=>this.getGraphicsLayers(),e=>{this._updatingHandles.removeHandles(O);for(const t of e)this._addMany(t.graphics.toArray()),this.addHandles([t.on("graphic-update",e=>this._onGraphicUpdate(e)),this._updatingHandles.addOnCollectionChange(()=>t.graphics,e=>this._onGraphicsChanged(e))],O)},d.Vh);const{view:e}=this,{layer:t}=this.layerSource;null!=e&&"3d"===e.type&&"map-notes"!==t.type&&e.elevationProvider&&this.addHandles([e.elevationProvider.on("elevation-change",e=>{let{context:n}=e;(0,b.Up)(n,t.elevationInfo)&&this._snappingElevationAligner.notifyElevationSourceChange()}),(0,d.wB)(()=>t.elevationInfo,()=>this._snappingElevationAligner.notifyElevationSourceChange(),d.Vh),(0,d.on)(()=>t,["edits","apply-edits","graphic-update"],()=>this._symbologySnappingFetcher.notifySymbologyChange())])}async fetchCandidates(e,t){const{point:n,coordinateHelper:{spatialReference:s}}=e,i=await(0,h.nA)(this._mapSources(n=>this._fetchCandidatesForSource(n,e,t)));(0,h.Te)(t);const o=this._memoizedMakeGetGroundElevation(this.view,s),r=i.flat().map(e=>(0,w.$)(e,o));return(0,S.xX)(n,r),r}async _fetchCandidatesForSource(e,t,n){const s=(0,S.nf)({parameters:t,mode:this.view?.type??"2d"}),i=await e.queryEngine.executeQueryForSnapping(s,n);(0,h.Te)(n);const o=await this._snappingElevationAligner.alignCandidates(i.candidates,t.coordinateHelper.spatialReference,n);(0,h.Te)(n);const r=await this._symbologySnappingFetcher.fetch(o,n);(0,h.Te)(n);const a=0===r.length?o:[...o,...r];return this._snappingElevationFilter.filter(s,a)}refresh(){}_onGraphicUpdate(e){if(this.getGraphicsLayers().some(t=>t.graphics.includes(e.graphic)))switch(e.property){case"geometry":case"visible":this._remove(e.graphic),this._addMany([e.graphic])}}_onGraphicsChanged(e){for(const t of e.removed)this._remove(t);this._addMany(e.added)}_addMany(e){const t=[],n=new Map;for(const s of e)null!=s.geometry&&(this._needsInitializeProjection(s.geometry.spatialReference)?(t.push(s.geometry.spatialReference),n.set(s.uid,s)):this._add(s));this._createPendingAdd(t,n)}_createPendingAdd(e,t){if(!e.length)return;const n=(0,r.UT)(async n=>{await(0,_.initializeProjection)(e.map(e=>({source:e,dest:this.spatialReference})),{signal:n}),this._markLoadedSpatialReferences(e);for(const e of t.values())this._add(e)});this._updatingHandles.addPromise(n.promise);const s={task:n,graphics:t},i=()=>(0,o.Xy)(this._pendingAdds,s);n.promise.then(i,i),this._pendingAdds.push(s)}_markLoadedSpatialReferences(e){for(const t of e){null!=t.wkid&&this._loadedWkids.add(t.wkid);const e=t.wkt2||t.wkt;e&&this._loadedWkts.add(e)}}_add(e){if(null==e.geometry||!e.visible)return;let t=e.geometry;if("mesh"===t.type)return;"extent"===t.type&&(t=p.A.fromExtent(t));const n=this._ensureSource(t.type);if(null==n)return;const s=this._createOptimizedFeature(e.uid,t);null!=s&&(n.featureStore.add(s),(0,C.f3)(e.symbol)&&this._extrudedPolygonSymbolsCount++)}_needsInitializeProjection(e){if(null!=e.wkid&&this._loadedWkids.has(e.wkid))return!1;const t=e.wkt2||e.wkt;return(!t||!this._loadedWkts.has(t))&&!(0,_.canProjectWithoutEngine)(e,this.spatialReference)}_createOptimizedFeature(e,t){const n=(0,_.project)((0,y.b3)(t),this.spatialReference);if(!n)return null;const s=this._ensureGeometryHasZ(n),i=(0,f.Ux)(s,this._hasZ,!1);return new m.Om(i,{[k]:e},null,e)}_ensureGeometryHasZ(e){if(!this._hasZ)return e;const t=e=>{for(;e.length<3;)e.push(0)},n=e.clone();switch(n.hasZ=!0,n.type){case"point":n.z=n.z??0;break;case"multipoint":n.points.forEach(t);break;case"polyline":n.paths.forEach(e=>e.forEach(t));break;case"polygon":n.rings.forEach(e=>e.forEach(t))}return n}_ensureSource(e){const t=this._sources[e];if(null!=t)return t;const n=this._createSource(e);return this._sources[e]=n,n}_createSource(e){const t=g.gy.toJSON(e),n=this._hasZ,s=new x.A({geometryType:t,hasZ:n,hasM:!1});return{featureStore:s,queryEngine:new v.do({featureStore:s,fieldsIndex:I.A.fromLayerJSON({fields:[{name:k,type:"esriFieldTypeOID",alias:k}]}),geometryType:t,hasM:!1,hasZ:n,featureIdInfo:{type:"object-id",fieldName:k},spatialReference:this.spatialReference,priority:E.W6.SNAPPING,scheduler:null!=this.view&&"3d"===this.view.type?this.view.resourceController.scheduler:null}),type:e}}_remove(e){this._mapSources(t=>this._removeFromSource(t,e));for(const t of this._pendingAdds)t.graphics.delete(e.uid),0===t.graphics.size&&t.task.abort()}_removeFromSource(e,t){const n=t.uid;e.featureStore.has(n)&&(e.featureStore.removeById(t.uid),(0,C.f3)(t.symbol)&&this._extrudedPolygonSymbolsCount--)}_destroySource(e){e.queryEngine.destroy(),this._sources[e.type]=null}_mapSources(e){const{point:t,polygon:n,polyline:s,multipoint:i}=this._sources,o=[];return null!=t&&o.push(e(t)),null!=n&&o.push(e(n)),null!=s&&o.push(e(s)),null!=i&&o.push(e(i)),o}};(0,s.Cg)([(0,u.MZ)()],P.prototype,"getGraphicsLayers",void 0),(0,s.Cg)([(0,u.MZ)({constructOnly:!0})],P.prototype,"layerSource",void 0),(0,s.Cg)([(0,u.MZ)({constructOnly:!0})],P.prototype,"spatialReference",void 0),(0,s.Cg)([(0,u.MZ)({constructOnly:!0})],P.prototype,"view",void 0),(0,s.Cg)([(0,u.MZ)({readOnly:!0})],P.prototype,"updating",null),(0,s.Cg)([(0,u.MZ)({readOnly:!0})],P.prototype,"availability",void 0),(0,s.Cg)([(0,u.MZ)()],P.prototype,"_hasZ",null),(0,s.Cg)([(0,u.MZ)()],P.prototype,"_snappingElevationAligner",null),(0,s.Cg)([(0,u.MZ)()],P.prototype,"_snappingElevationFilter",null),(0,s.Cg)([(0,u.MZ)()],P.prototype,"_symbologySnappingFetcher",null),(0,s.Cg)([(0,u.MZ)()],P.prototype,"_extrudedPolygonSymbolsCount",void 0),P=(0,s.Cg)([(0,l.$)("esri.views.interactive.snapping.featureSources.GraphicsSnappingSource")],P);const k="OBJECTID"}}]);
//# sourceMappingURL=99546.b5c2ed6d.chunk.js.map